var _split;_split=_split||function(undef){var nativeSplit=String.prototype.split,compliantExecNpcg=/()??/.exec("")[1]===undef,self;self=function(str,separator,limit){if(Object.prototype.toString.call(separator)!=="[object RegExp]"){return nativeSplit.call(str,separator,limit)}var output=[],flags=(separator.ignoreCase?"i":"")+(separator.multiline?"m":"")+(separator.extended?"x":"")+(separator.sticky?"y":""),lastLastIndex=0,separator=new RegExp(separator.source,flags+"g"),separator2,match,lastIndex,lastLength;str+="";if(!compliantExecNpcg){separator2=new RegExp("^"+separator.source+"$(?!\\s)",flags)}limit=limit===undef?-1>>>0:limit>>>0;while(match=separator.exec(str)){lastIndex=match.index+match[0].length;if(lastIndex>lastLastIndex){output.push(str.slice(lastLastIndex,match.index));if(!compliantExecNpcg&&match.length>1){match[0].replace(separator2,function(){for(var i=1;i<arguments.length-2;i++){if(arguments[i]===undef){match[i]=undef}}})}if(match.length>1&&match.index<str.length){Array.prototype.push.apply(output,match.slice(1))}lastLength=match[0].length;lastLastIndex=lastIndex;if(output.length>=limit){break}}if(separator.lastIndex===match.index){separator.lastIndex++}}if(lastLastIndex===str.length){if(lastLength||!separator.test("")){output.push("")}}else{output.push(str.slice(lastLastIndex))}return output.length>limit?output.slice(0,limit):output};String.prototype.split=function(separator,limit){return self(this,separator,limit)};return self}();window.gettext=function(s){return s};window.ngettext=function(singular,plural,num){return num==1?singular:plural};function interpolate(fmt,obj,named){if(named){return fmt.replace(/%\(\w+\)s/g,function(match){return String(obj[match.slice(2,-2)])})}else{return fmt.replace(/%s/g,function(match){return String(obj.shift())})}}!function(e){function S(e){throw RangeError(g[e])}function x(e,t){var n=e.length;while(n--)e[n]=t(e[n]);return e}function T(e,t){return x(e.split(m),t).join(".")}function N(e){var t=[],n=0,r=e.length,i,s;while(n<r)i=e.charCodeAt(n++),i>=55296&&i<=56319&&n<r?(s=e.charCodeAt(n++),(s&64512)==56320?t.push(((i&1023)<<10)+(s&1023)+65536):(t.push(i),n--)):t.push(i);return t}function C(e){return x(e,function(e){var t="";return e>65535&&(e-=65536,t+=w(e>>>10&1023|55296),e=56320|e&1023),t+=w(e),t}).join("")}function k(e){return e-48<10?e-22:e-65<26?e-65:e-97<26?e-97:o}function L(e,t){return e+22+75*(e<26)-((t!=0)<<5)}function A(e,t,n){var r=0;e=n?b(e/l):e>>1,e+=b(e/t);for(;e>y*a>>1;r+=o)e=b(e/y);return b(r+(y+1)*e/(e+f))}function O(e){var t=[],n=e.length,r,i=0,f=h,l=c,d,v,m,g,y,w,E,x,T,N;d=e.lastIndexOf(p),d<0&&(d=0);for(v=0;v<d;++v)e.charCodeAt(v)>=128&&S("not-basic"),t.push(e.charCodeAt(v));for(m=d>0?d+1:0;m<n;){for(g=i,y=1,w=o;;w+=o){m>=n&&S("invalid-input"),E=k(e.charCodeAt(m++)),(E>=o||E>b((s-i)/y))&&S("overflow"),i+=E*y,x=w<=l?u:w>=l+a?a:w-l;if(E<x)break;N=o-x,y>b(s/N)&&S("overflow"),y*=N}r=t.length+1,l=A(i-g,r,g==0),b(i/r)>s-f&&S("overflow"),f+=b(i/r),i%=r,t.splice(i++,0,f)}return C(t)}function M(e){var t,n,r,i,f,l,d,v,m,g,y,E=[],x,T,C,k;e=N(e),x=e.length,t=h,n=0,f=c;for(l=0;l<x;++l)y=e[l],y<128&&E.push(w(y));r=i=E.length,i&&E.push(p);while(r<x){for(d=s,l=0;l<x;++l)y=e[l],y>=t&&y<d&&(d=y);T=r+1,d-t>b((s-n)/T)&&S("overflow"),n+=(d-t)*T,t=d;for(l=0;l<x;++l){y=e[l],y<t&&++n>s&&S("overflow");if(y==t){for(v=n,m=o;;m+=o){g=m<=f?u:m>=f+a?a:m-f;if(v<g)break;k=v-g,C=o-g,E.push(w(L(g+k%C,0))),v=b(k/C)}E.push(w(L(v,0))),f=A(n,T,r==i),n=0,++r}}++n,++t}return E.join("")}function _(e){return T(e,function(e){return d.test(e)?O(e.slice(4).toLowerCase()):e})}function D(e){return T(e,function(e){return v.test(e)?"xn--"+M(e):e})}var t=typeof exports=="object"&&exports,n=typeof module=="object"&&module&&module.exports==t&&module,r=typeof global=="object"&&global;if(r.global===r||r.window===r)e=r;var i,s=2147483647,o=36,u=1,a=26,f=38,l=700,c=72,h=128,p="-",d=/^xn--/,v=/[^ -~]/,m=/\x2E|\u3002|\uFF0E|\uFF61/g,g={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},y=o-u,b=Math.floor,w=String.fromCharCode,E;i={version:"1.2.3",ucs2:{decode:N,encode:C},decode:O,encode:M,toASCII:D,toUnicode:_};if(typeof define=="function"&&typeof define.amd=="object"&&define.amd)define("punycode",[],function(){return i});else if(t&&!t.nodeType)if(n)n.exports=i;else for(E in i)i.hasOwnProperty(E)&&(t[E]=i[E]);else e.punycode=i}(this),function(e,t){typeof exports=="object"?module.exports=t():typeof define=="function"&&define.amd?define("IPv6",t):e.IPv6=t(e)}(this,function(e){function n(e){var t=e.toLowerCase(),n=t.split(":"),r=n.length,i=8;n[0]===""&&n[1]===""&&n[2]===""?(n.shift(),n.shift()):n[0]===""&&n[1]===""?n.shift():n[r-1]===""&&n[r-2]===""&&n.pop(),r=n.length,n[r-1].indexOf(".")!==-1&&(i=7);var s;for(s=0;s<r;s++)if(n[s]==="")break;if(s<i){n.splice(s,1,"0000");while(n.length<i)n.splice(s,0,"0000");r=n.length}var o;for(var u=0;u<i;u++){o=n[u].split("");for(var a=0;a<3;a++){if(!(o[0]==="0"&&o.length>1))break;o.splice(0,1)}n[u]=o.join("")}var f=-1,l=0,c=0,h=-1,p=!1;for(u=0;u<i;u++)p?n[u]==="0"?c+=1:(p=!1,c>l&&(f=h,l=c)):n[u]=="0"&&(p=!0,h=u,c=1);c>l&&(f=h,l=c),l>1&&n.splice(f,l,""),r=n.length;var d="";n[0]===""&&(beststr=":");for(u=0;u<r;u++){d+=n[u];if(u===r-1)break;d+=":"}return n[r-1]===""&&(d+=":"),d}function r(){return e.IPv6===this&&(e.IPv6=t),this}var t=e&&e.IPv6;return{best:n,noConflict:r}}),function(e,t){typeof exports=="object"?module.exports=t():typeof define=="function"&&define.amd?define("SecondLevelDomains",t):e.SecondLevelDomains=t(e)}(this,function(e){var t=e&&e.SecondLevelDomains,n=Object.prototype.hasOwnProperty,r={list:{ac:"com|gov|mil|net|org",ae:"ac|co|gov|mil|name|net|org|pro|sch",af:"com|edu|gov|net|org",al:"com|edu|gov|mil|net|org",ao:"co|ed|gv|it|og|pb",ar:"com|edu|gob|gov|int|mil|net|org|tur",at:"ac|co|gv|or",au:"asn|com|csiro|edu|gov|id|net|org",ba:"co|com|edu|gov|mil|net|org|rs|unbi|unmo|unsa|untz|unze",bb:"biz|co|com|edu|gov|info|net|org|store|tv",bh:"biz|cc|com|edu|gov|info|net|org",bn:"com|edu|gov|net|org",bo:"com|edu|gob|gov|int|mil|net|org|tv",br:"adm|adv|agr|am|arq|art|ato|b|bio|blog|bmd|cim|cng|cnt|com|coop|ecn|edu|eng|esp|etc|eti|far|flog|fm|fnd|fot|fst|g12|ggf|gov|imb|ind|inf|jor|jus|lel|mat|med|mil|mus|net|nom|not|ntr|odo|org|ppg|pro|psc|psi|qsl|rec|slg|srv|tmp|trd|tur|tv|vet|vlog|wiki|zlg",bs:"com|edu|gov|net|org",bz:"du|et|om|ov|rg",ca:"ab|bc|mb|nb|nf|nl|ns|nt|nu|on|pe|qc|sk|yk",ck:"biz|co|edu|gen|gov|info|net|org",cn:"ac|ah|bj|com|cq|edu|fj|gd|gov|gs|gx|gz|ha|hb|he|hi|hl|hn|jl|js|jx|ln|mil|net|nm|nx|org|qh|sc|sd|sh|sn|sx|tj|tw|xj|xz|yn|zj",co:"com|edu|gov|mil|net|nom|org",cr:"ac|c|co|ed|fi|go|or|sa",cy:"ac|biz|com|ekloges|gov|ltd|name|net|org|parliament|press|pro|tm","do":"art|com|edu|gob|gov|mil|net|org|sld|web",dz:"art|asso|com|edu|gov|net|org|pol",ec:"com|edu|fin|gov|info|med|mil|net|org|pro",eg:"com|edu|eun|gov|mil|name|net|org|sci",er:"com|edu|gov|ind|mil|net|org|rochest|w",es:"com|edu|gob|nom|org",et:"biz|com|edu|gov|info|name|net|org",fj:"ac|biz|com|info|mil|name|net|org|pro",fk:"ac|co|gov|net|nom|org",fr:"asso|com|f|gouv|nom|prd|presse|tm",gg:"co|net|org",gh:"com|edu|gov|mil|org",gn:"ac|com|gov|net|org",gr:"com|edu|gov|mil|net|org",gt:"com|edu|gob|ind|mil|net|org",gu:"com|edu|gov|net|org",hk:"com|edu|gov|idv|net|org",id:"ac|co|go|mil|net|or|sch|web",il:"ac|co|gov|idf|k12|muni|net|org","in":"ac|co|edu|ernet|firm|gen|gov|i|ind|mil|net|nic|org|res",iq:"com|edu|gov|i|mil|net|org",ir:"ac|co|dnssec|gov|i|id|net|org|sch",it:"edu|gov",je:"co|net|org",jo:"com|edu|gov|mil|name|net|org|sch",jp:"ac|ad|co|ed|go|gr|lg|ne|or",ke:"ac|co|go|info|me|mobi|ne|or|sc",kh:"com|edu|gov|mil|net|org|per",ki:"biz|com|de|edu|gov|info|mob|net|org|tel",km:"asso|com|coop|edu|gouv|k|medecin|mil|nom|notaires|pharmaciens|presse|tm|veterinaire",kn:"edu|gov|net|org",kr:"ac|busan|chungbuk|chungnam|co|daegu|daejeon|es|gangwon|go|gwangju|gyeongbuk|gyeonggi|gyeongnam|hs|incheon|jeju|jeonbuk|jeonnam|k|kg|mil|ms|ne|or|pe|re|sc|seoul|ulsan",kw:"com|edu|gov|net|org",ky:"com|edu|gov|net|org",kz:"com|edu|gov|mil|net|org",lb:"com|edu|gov|net|org",lk:"assn|com|edu|gov|grp|hotel|int|ltd|net|ngo|org|sch|soc|web",lr:"com|edu|gov|net|org",lv:"asn|com|conf|edu|gov|id|mil|net|org",ly:"com|edu|gov|id|med|net|org|plc|sch",ma:"ac|co|gov|m|net|org|press",mc:"asso|tm",me:"ac|co|edu|gov|its|net|org|priv",mg:"com|edu|gov|mil|nom|org|prd|tm",mk:"com|edu|gov|inf|name|net|org|pro",ml:"com|edu|gov|net|org|presse",mn:"edu|gov|org",mo:"com|edu|gov|net|org",mt:"com|edu|gov|net|org",mv:"aero|biz|com|coop|edu|gov|info|int|mil|museum|name|net|org|pro",mw:"ac|co|com|coop|edu|gov|int|museum|net|org",mx:"com|edu|gob|net|org",my:"com|edu|gov|mil|name|net|org|sch",nf:"arts|com|firm|info|net|other|per|rec|store|web",ng:"biz|com|edu|gov|mil|mobi|name|net|org|sch",ni:"ac|co|com|edu|gob|mil|net|nom|org",np:"com|edu|gov|mil|net|org",nr:"biz|com|edu|gov|info|net|org",om:"ac|biz|co|com|edu|gov|med|mil|museum|net|org|pro|sch",pe:"com|edu|gob|mil|net|nom|org|sld",ph:"com|edu|gov|i|mil|net|ngo|org",pk:"biz|com|edu|fam|gob|gok|gon|gop|gos|gov|net|org|web",pl:"art|bialystok|biz|com|edu|gda|gdansk|gorzow|gov|info|katowice|krakow|lodz|lublin|mil|net|ngo|olsztyn|org|poznan|pwr|radom|slupsk|szczecin|torun|warszawa|waw|wroc|wroclaw|zgora",pr:"ac|biz|com|edu|est|gov|info|isla|name|net|org|pro|prof",ps:"com|edu|gov|net|org|plo|sec",pw:"belau|co|ed|go|ne|or",ro:"arts|com|firm|info|nom|nt|org|rec|store|tm|www",rs:"ac|co|edu|gov|in|org",sb:"com|edu|gov|net|org",sc:"com|edu|gov|net|org",sh:"co|com|edu|gov|net|nom|org",sl:"com|edu|gov|net|org",st:"co|com|consulado|edu|embaixada|gov|mil|net|org|principe|saotome|store",sv:"com|edu|gob|org|red",sz:"ac|co|org",tr:"av|bbs|bel|biz|com|dr|edu|gen|gov|info|k12|name|net|org|pol|tel|tsk|tv|web",tt:"aero|biz|cat|co|com|coop|edu|gov|info|int|jobs|mil|mobi|museum|name|net|org|pro|tel|travel",tw:"club|com|ebiz|edu|game|gov|idv|mil|net|org",mu:"ac|co|com|gov|net|or|org",mz:"ac|co|edu|gov|org",na:"co|com",nz:"ac|co|cri|geek|gen|govt|health|iwi|maori|mil|net|org|parliament|school",pa:"abo|ac|com|edu|gob|ing|med|net|nom|org|sld",pt:"com|edu|gov|int|net|nome|org|publ",py:"com|edu|gov|mil|net|org",qa:"com|edu|gov|mil|net|org",re:"asso|com|nom",ru:"ac|adygeya|altai|amur|arkhangelsk|astrakhan|bashkiria|belgorod|bir|bryansk|buryatia|cbg|chel|chelyabinsk|chita|chukotka|chuvashia|com|dagestan|e-burg|edu|gov|grozny|int|irkutsk|ivanovo|izhevsk|jar|joshkar-ola|kalmykia|kaluga|kamchatka|karelia|kazan|kchr|kemerovo|khabarovsk|khakassia|khv|kirov|koenig|komi|kostroma|kranoyarsk|kuban|kurgan|kursk|lipetsk|magadan|mari|mari-el|marine|mil|mordovia|mosreg|msk|murmansk|nalchik|net|nnov|nov|novosibirsk|nsk|omsk|orenburg|org|oryol|penza|perm|pp|pskov|ptz|rnd|ryazan|sakhalin|samara|saratov|simbirsk|smolensk|spb|stavropol|stv|surgut|tambov|tatarstan|tom|tomsk|tsaritsyn|tsk|tula|tuva|tver|tyumen|udm|udmurtia|ulan-ude|vladikavkaz|vladimir|vladivostok|volgograd|vologda|voronezh|vrn|vyatka|yakutia|yamal|yekaterinburg|yuzhno-sakhalinsk",rw:"ac|co|com|edu|gouv|gov|int|mil|net",sa:"com|edu|gov|med|net|org|pub|sch",sd:"com|edu|gov|info|med|net|org|tv",se:"a|ac|b|bd|c|d|e|f|g|h|i|k|l|m|n|o|org|p|parti|pp|press|r|s|t|tm|u|w|x|y|z",sg:"com|edu|gov|idn|net|org|per",sn:"art|com|edu|gouv|org|perso|univ",sy:"com|edu|gov|mil|net|news|org",th:"ac|co|go|in|mi|net|or",tj:"ac|biz|co|com|edu|go|gov|info|int|mil|name|net|nic|org|test|web",tn:"agrinet|com|defense|edunet|ens|fin|gov|ind|info|intl|mincom|nat|net|org|perso|rnrt|rns|rnu|tourism",tz:"ac|co|go|ne|or",ua:"biz|cherkassy|chernigov|chernovtsy|ck|cn|co|com|crimea|cv|dn|dnepropetrovsk|donetsk|dp|edu|gov|if|in|ivano-frankivsk|kh|kharkov|kherson|khmelnitskiy|kiev|kirovograd|km|kr|ks|kv|lg|lugansk|lutsk|lviv|me|mk|net|nikolaev|od|odessa|org|pl|poltava|pp|rovno|rv|sebastopol|sumy|te|ternopil|uzhgorod|vinnica|vn|zaporizhzhe|zhitomir|zp|zt",ug:"ac|co|go|ne|or|org|sc",uk:"ac|bl|british-library|co|cym|gov|govt|icnet|jet|lea|ltd|me|mil|mod|national-library-scotland|nel|net|nhs|nic|nls|org|orgn|parliament|plc|police|sch|scot|soc",us:"dni|fed|isa|kids|nsn",uy:"com|edu|gub|mil|net|org",ve:"co|com|edu|gob|info|mil|net|org|web",vi:"co|com|k12|net|org",vn:"ac|biz|com|edu|gov|health|info|int|name|net|org|pro",ye:"co|com|gov|ltd|me|net|org|plc",yu:"ac|co|edu|gov|org",za:"ac|agric|alt|bourse|city|co|cybernet|db|edu|gov|grondar|iaccess|imt|inca|landesign|law|mil|net|ngo|nis|nom|olivetti|org|pix|school|tm|web",zm:"ac|co|com|edu|gov|net|org|sch"},has_expression:null,is_expression:null,has:function(e){return!!e.match(r.has_expression)},is:function(e){return!!e.match(r.is_expression)},get:function(e){var t=e.match(r.has_expression);return t&&t[1]||null},noConflict:function(){return e.SecondLevelDomains===this&&(e.SecondLevelDomains=t),this},init:function(){var e="";for(var t in r.list){if(!n.call(r.list,t))continue;var i="("+r.list[t]+")."+t;e+="|("+i+")"}r.has_expression=new RegExp("\\.("+e.substr(1)+")$","i"),r.is_expression=new RegExp("^("+e.substr(1)+")$","i")}};return r.init(),r}),function(e,t){typeof exports=="object"?module.exports=t(require("./punycode"),require("./IPv6"),require("./SecondLevelDomains")):typeof define=="function"&&define.amd?define("URI",["./punycode","./IPv6","./SecondLevelDomains"],t):e.URI=t(e.punycode,e.IPv6,e.SecondLevelDomains,e)}(this,function(e,t,n,r){function s(e,t){return this instanceof s?(e===undefined&&(typeof location!="undefined"?e=location.href+"":e=""),this.href(e),t!==undefined?this.absoluteTo(t):this):new s(e,t)}function a(e){return e.replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")}function f(e){return e===undefined?"Undefined":String(Object.prototype.toString.call(e)).slice(8,-1)}function l(e){return f(e)==="Array"}function c(e,t){var n={},r,i;if(l(t))for(r=0,i=t.length;r<i;r++)n[t[r]]=!0;else n[t]=!0;for(r=0,i=e.length;r<i;r++)n[e[r]]!==undefined&&(e.splice(r,1),i--,r--);return e}function h(e,t){var n,r;if(l(t)){for(n=0,r=t.length;n<r;n++)if(!h(e,t[n]))return!1;return!0}var i=f(t);for(n=0,r=e.length;n<r;n++)if(i==="RegExp"){if(typeof e[n]=="string"&&e[n].match(t))return!0}else if(e[n]===t)return!0;return!1}function p(e,t){if(!l(e)||!l(t))return!1;if(e.length!==t.length)return!1;e.sort(),t.sort();for(var n=0,r=e.length;n<r;n++)if(e[n]!==t[n])return!1;return!0}function d(e){return escape(e)}function v(e){return encodeURIComponent(e).replace(/[!'()*]/g,d).replace(/\*/g,"%2A")}var i=r&&r.URI,o=s.prototype,u=Object.prototype.hasOwnProperty;s._parts=function(){return{protocol:null,username:null,password:null,hostname:null,urn:null,port:null,path:null,query:null,fragment:null,duplicateQueryParameters:s.duplicateQueryParameters,escapeQuerySpace:s.escapeQuerySpace}},s.duplicateQueryParameters=!1,s.escapeQuerySpace=!0,s.protocol_expression=/^[a-z][a-z0-9-+-]*$/i,s.idn_expression=/[^a-z0-9\.-]/i,s.punycode_expression=/(xn--)/i,s.ip4_expression=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,s.ip6_expression=/^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$/,s.find_uri_expression=/\b((?:[a-z][\w-]+:(?:\/{1,3}|[a-z0-9%])|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/gi,s.defaultPorts={http:"80",https:"443",ftp:"21",gopher:"70",ws:"80",wss:"443"},s.invalid_hostname_characters=/[^a-zA-Z0-9\.-]/,s.domAttributes={a:"href",blockquote:"cite",link:"href",base:"href",script:"src",form:"action",img:"src",area:"href",iframe:"src",embed:"src",source:"src",track:"src",input:"src"},s.getDomAttribute=function(e){if(!e||!e.nodeName)return undefined;var t=e.nodeName.toLowerCase();return t==="input"&&e.type!=="image"?undefined:s.domAttributes[t]},s.encode=v,s.decode=decodeURIComponent,s.iso8859=function(){s.encode=escape,s.decode=unescape},s.unicode=function(){s.encode=v,s.decode=decodeURIComponent},s.characters={pathname:{encode:{expression:/%(24|26|2B|2C|3B|3D|3A|40)/gi,map:{"%24":"$","%26":"&","%2B":"+","%2C":",","%3B":";","%3D":"=","%3A":":","%40":"@"}},decode:{expression:/[\/\?#]/g,map:{"/":"%2F","?":"%3F","#":"%23"}}},reserved:{encode:{expression:/%(21|23|24|26|27|28|29|2A|2B|2C|2F|3A|3B|3D|3F|40|5B|5D)/gi,map:{"%3A":":","%2F":"/","%3F":"?","%23":"#","%5B":"[","%5D":"]","%40":"@","%21":"!","%24":"$","%26":"&","%27":"'","%28":"(","%29":")","%2A":"*","%2B":"+","%2C":",","%3B":";","%3D":"="}}}},s.encodeQuery=function(e,t){var n=s.encode(e+"");return t?n.replace(/%20/g,"+"):n},s.decodeQuery=function(e,t){e+="";try{return s.decode(t?e.replace(/\+/g,"%20"):e)}catch(n){return e}},s.recodePath=function(e){var t=(e+"").split("/");for(var n=0,r=t.length;n<r;n++)t[n]=s.encodePathSegment(s.decode(t[n]));return t.join("/")},s.decodePath=function(e){var t=(e+"").split("/");for(var n=0,r=t.length;n<r;n++)t[n]=s.decodePathSegment(t[n]);return t.join("/")};var m={encode:"encode",decode:"decode"},g,y=function(e,t){return function(n){return s[t](n+"").replace(s.characters[e][t].expression,function(n){return s.characters[e][t].map[n]})}};for(g in m)s[g+"PathSegment"]=y("pathname",m[g]);s.encodeReserved=y("reserved","encode"),s.parse=function(e,t){var n;return t||(t={}),n=e.indexOf("#"),n>-1&&(t.fragment=e.substring(n+1)||null,e=e.substring(0,n)),n=e.indexOf("?"),n>-1&&(t.query=e.substring(n+1)||null,e=e.substring(0,n)),e.substring(0,2)==="//"?(t.protocol=null,e=e.substring(2),e=s.parseAuthority(e,t)):(n=e.indexOf(":"),n>-1&&(t.protocol=e.substring(0,n)||null,t.protocol&&!t.protocol.match(s.protocol_expression)?t.protocol=undefined:t.protocol==="file"?e=e.substring(n+3):e.substring(n+1,n+3)==="//"?(e=e.substring(n+3),e=s.parseAuthority(e,t)):(e=e.substring(n+1),t.urn=!0))),t.path=e,t},s.parseHost=function(e,t){var n=e.indexOf("/"),r,i;return n===-1&&(n=e.length),e.charAt(0)==="["?(r=e.indexOf("]"),t.hostname=e.substring(1,r)||null,t.port=e.substring(r+2,n)||null):e.indexOf(":")!==e.lastIndexOf(":")?(t.hostname=e.substring(0,n)||null,t.port=null):(i=e.substring(0,n).split(":"),t.hostname=i[0]||null,t.port=i[1]||null),t.hostname&&e.substring(n).charAt(0)!=="/"&&(n++,e="/"+e),e.substring(n)||"/"},s.parseAuthority=function(e,t){return e=s.parseUserinfo(e,t),s.parseHost(e,t)},s.parseUserinfo=function(e,t){var n=e.indexOf("/"),r=n>-1?e.lastIndexOf("@",n):e.indexOf("@"),i;return r>-1&&(n===-1||r<n)?(i=e.substring(0,r).split(":"),t.username=i[0]?s.decode(i[0]):null,i.shift(),t.password=i[0]?s.decode(i.join(":")):null,e=e.substring(r+1)):(t.username=null,t.password=null),e},s.parseQuery=function(e,t){if(!e)return{};e=e.replace(/&+/g,"&").replace(/^\?*&*|&+$/g,"");if(!e)return{};var n={},r=e.split("&"),i=r.length,o,u,a;for(var f=0;f<i;f++)o=r[f].split("="),u=s.decodeQuery(o.shift(),t),a=o.length?s.decodeQuery(o.join("="),t):null,n[u]?(typeof n[u]=="string"&&(n[u]=[n[u]]),n[u].push(a)):n[u]=a;return n},s.build=function(e){var t="";return e.protocol&&(t+=e.protocol+":"),!e.urn&&(t||e.hostname)&&(t+="//"),t+=s.buildAuthority(e)||"",typeof e.path=="string"&&(e.path.charAt(0)!=="/"&&typeof e.hostname=="string"&&(t+="/"),t+=e.path),typeof e.query=="string"&&e.query&&(t+="?"+e.query),typeof e.fragment=="string"&&e.fragment&&(t+="#"+e.fragment),t},s.buildHost=function(e){var t="";return e.hostname?(s.ip6_expression.test(e.hostname)?e.port?t+="["+e.hostname+"]:"+e.port:t+=e.hostname:(t+=e.hostname,e.port&&(t+=":"+e.port)),t):""},s.buildAuthority=function(e){return s.buildUserinfo(e)+s.buildHost(e)},s.buildUserinfo=function(e){var t="";return e.username&&(t+=s.encode(e.username),e.password&&(t+=":"+s.encode(e.password)),t+="@"),t},s.buildQuery=function(e,t,n){var r="",i,o,a,f;for(o in e)if(u.call(e,o)&&o)if(l(e[o])){i={};for(a=0,f=e[o].length;a<f;a++)e[o][a]!==undefined&&i[e[o][a]+""]===undefined&&(r+="&"+s.buildQueryParameter(o,e[o][a],n),t!==!0&&(i[e[o][a]+""]=!0))}else e[o]!==undefined&&(r+="&"+s.buildQueryParameter(o,e[o],n));return r.substring(1)},s.buildQueryParameter=function(e,t,n){return s.encodeQuery(e,n)+(t!==null?"="+s.encodeQuery(t,n):"")},s.addQuery=function(e,t,n){if(typeof t=="object")for(var r in t)u.call(t,r)&&s.addQuery(e,r,t[r]);else{if(typeof t!="string")throw new TypeError("URI.addQuery() accepts an object, string as the name parameter");if(e[t]===undefined){e[t]=n;return}typeof e[t]=="string"&&(e[t]=[e[t]]),l(n)||(n=[n]),e[t]=e[t].concat(n)}},s.removeQuery=function(e,t,n){var r,i,o;if(l(t))for(r=0,i=t.length;r<i;r++)e[t[r]]=undefined;else if(typeof t=="object")for(o in t)u.call(t,o)&&s.removeQuery(e,o,t[o]);else{if(typeof t!="string")throw new TypeError("URI.addQuery() accepts an object, string as the first parameter");n!==undefined?e[t]===n?e[t]=undefined:l(e[t])&&(e[t]=c(e[t],n)):e[t]=undefined}},s.hasQuery=function(e,t,n,r){if(typeof t=="object"){for(var i in t)if(u.call(t,i)&&!s.hasQuery(e,i,t[i]))return!1;return!0}if(typeof t!="string")throw new TypeError("URI.hasQuery() accepts an object, string as the name parameter");switch(f(n)){case"Undefined":return t in e;case"Boolean":var o=Boolean(l(e[t])?e[t].length:e[t]);return n===o;case"Function":return!!n(e[t],t,e);case"Array":if(!l(e[t]))return!1;var a=r?h:p;return a(e[t],n);case"RegExp":if(!l(e[t]))return Boolean(e[t]&&e[t].match(n));if(!r)return!1;return h(e[t],n);case"Number":n=String(n);case"String":if(!l(e[t]))return e[t]===n;if(!r)return!1;return h(e[t],n);default:throw new TypeError("URI.hasQuery() accepts undefined, boolean, string, number, RegExp, Function as the value parameter")}},s.commonPath=function(e,t){var n=Math.min(e.length,t.length),r;for(r=0;r<n;r++)if(e.charAt(r)!==t.charAt(r)){r--;break}if(r<1)return e.charAt(0)===t.charAt(0)&&e.charAt(0)==="/"?"/":"";if(e.charAt(r)!=="/"||t.charAt(r)!=="/")r=e.substring(0,r).lastIndexOf("/");return e.substring(0,r+1)},s.withinString=function(e,t){return e.replace(s.find_uri_expression,t)},s.ensureValidHostname=function(t){if(t.match(s.invalid_hostname_characters)){if(!e)throw new TypeError("Hostname '"+t+"' contains characters other than [A-Z0-9.-] and Punycode.js is not available");if(e.toASCII(t).match(s.invalid_hostname_characters))throw new TypeError("Hostname '"+t+"' contains characters other than [A-Z0-9.-]")}},s.noConflict=function(e){if(e){var n={URI:this.noConflict()};return URITemplate&&typeof URITemplate.noConflict=="function"&&(n.URITemplate=URITemplate.noConflict()),t&&typeof t.noConflict=="function"&&(n.IPv6=t.noConflict()),SecondLevelDomains&&typeof SecondLevelDomains.noConflict=="function"&&(n.SecondLevelDomains=SecondLevelDomains.noConflict()),n}return r.URI===this&&(r.URI=i),this},o.build=function(e){if(e===!0)this._deferred_build=!0;else if(e===undefined||this._deferred_build)this._string=s.build(this._parts),this._deferred_build=!1;return this},o.clone=function(){return new s(this)},o.valueOf=o.toString=function(){return this.build(!1)._string},m={protocol:"protocol",username:"username",password:"password",hostname:"hostname",port:"port"},y=function(e){return function(t,n){return t===undefined?this._parts[e]||"":(this._parts[e]=t||null,this.build(!n),this)}};for(g in m)o[g]=y(m[g]);m={query:"?",fragment:"#"},y=function(e,t){return function(n,r){return n===undefined?this._parts[e]||"":(n!==null&&(n+="",n.charAt(0)===t&&(n=n.substring(1))),this._parts[e]=n,this.build(!r),this)}};for(g in m)o[g]=y(g,m[g]);m={search:["?","query"],hash:["#","fragment"]},y=function(e,t){return function(n,r){var i=this[e](n,r);return typeof i=="string"&&i.length?t+i:i}};for(g in m)o[g]=y(m[g][1],m[g][0]);o.pathname=function(e,t){if(e===undefined||e===!0){var n=this._parts.path||(this._parts.hostname?"/":"");return e?s.decodePath(n):n}return this._parts.path=e?s.recodePath(e):"/",this.build(!t),this},o.path=o.pathname,o.href=function(e,t){var n;if(e===undefined)return this.toString();this._string="",this._parts=s._parts();var r=e instanceof s,i=typeof e=="object"&&(e.hostname||e.path||e.pathname);if(e.nodeName){var o=s.getDomAttribute(e);e=e[o]||"",i=!1}!r&&i&&e.pathname!==undefined&&(e=e.toString());if(typeof e=="string")this._parts=s.parse(e,this._parts);else{if(!r&&!i)throw new TypeError("invalid input");var a=r?e._parts:e;for(n in a)u.call(this._parts,n)&&(this._parts[n]=a[n])}return this.build(!t),this},o.is=function(e){var t=!1,r=!1,i=!1,o=!1,u=!1,a=!1,f=!1,l=!this._parts.urn;this._parts.hostname&&(l=!1,r=s.ip4_expression.test(this._parts.hostname),i=s.ip6_expression.test(this._parts.hostname),t=r||i,o=!t,u=o&&n&&n.has(this._parts.hostname),a=o&&s.idn_expression.test(this._parts.hostname),f=o&&s.punycode_expression.test(this._parts.hostname));switch(e.toLowerCase()){case"relative":return l;case"absolute":return!l;case"domain":case"name":return o;case"sld":return u;case"ip":return t;case"ip4":case"ipv4":case"inet4":return r;case"ip6":case"ipv6":case"inet6":return i;case"idn":return a;case"url":return!this._parts.urn;case"urn":return!!this._parts.urn;case"punycode":return f}return null};var b=o.protocol,w=o.port,E=o.hostname;o.protocol=function(e,t){if(e!==undefined&&e){e=e.replace(/:(\/\/)?$/,"");if(e.match(/[^a-zA-z0-9\.+-]/))throw new TypeError("Protocol '"+e+"' contains characters other than [A-Z0-9.+-]")}return b.call(this,e,t)},o.scheme=o.protocol,o.port=function(e,t){if(this._parts.urn)return e===undefined?"":this;if(e!==undefined){e===0&&(e=null);if(e){e+="",e.charAt(0)===":"&&(e=e.substring(1));if(e.match(/[^0-9]/))throw new TypeError("Port '"+e+"' contains characters other than [0-9]")}}return w.call(this,e,t)},o.hostname=function(e,t){if(this._parts.urn)return e===undefined?"":this;if(e!==undefined){var n={};s.parseHost(e,n),e=n.hostname}return E.call(this,e,t)},o.host=function(e,t){return this._parts.urn?e===undefined?"":this:e===undefined?this._parts.hostname?s.buildHost(this._parts):"":(s.parseHost(e,this._parts),this.build(!t),this)},o.authority=function(e,t){return this._parts.urn?e===undefined?"":this:e===undefined?this._parts.hostname?s.buildAuthority(this._parts):"":(s.parseAuthority(e,this._parts),this.build(!t),this)},o.userinfo=function(e,t){if(this._parts.urn)return e===undefined?"":this;if(e===undefined){if(!this._parts.username)return"";var n=s.buildUserinfo(this._parts);return n.substring(0,n.length-1)}return e[e.length-1]!=="@"&&(e+="@"),s.parseUserinfo(e,this._parts),this.build(!t),this},o.resource=function(e,t){var n;return e===undefined?this.path()+this.search()+this.hash():(n=s.parse(e),this._parts.path=n.path,this._parts.query=n.query,this._parts.fragment=n.fragment,this.build(!t),this)},o.subdomain=function(e,t){if(this._parts.urn)return e===undefined?"":this;if(e===undefined){if(!this._parts.hostname||this.is("IP"))return"";var n=this._parts.hostname.length-this.domain().length-1;return this._parts.hostname.substring(0,n)||""}var r=this._parts.hostname.length-this.domain().length,i=this._parts.hostname.substring(0,r),o=new RegExp("^"+a(i));return e&&e.charAt(e.length-1)!=="."&&(e+="."),e&&s.ensureValidHostname(e),this._parts.hostname=this._parts.hostname.replace(o,e),this.build(!t),this},o.domain=function(e,t){if(this._parts.urn)return e===undefined?"":this;typeof e=="boolean"&&(t=e,e=undefined);if(e===undefined){if(!this._parts.hostname||this.is("IP"))return"";var n=this._parts.hostname.match(/\./g);if(n&&n.length<2)return this._parts.hostname;var r=this._parts.hostname.length-this.tld(t).length-1;return r=this._parts.hostname.lastIndexOf(".",r-1)+1,this._parts.hostname.substring(r)||""}if(!e)throw new TypeError("cannot set domain empty");s.ensureValidHostname(e);if(!this._parts.hostname||this.is("IP"))this._parts.hostname=e;else{var i=new RegExp(a(this.domain())+"$");this._parts.hostname=this._parts.hostname.replace(i,e)}return this.build(!t),this},o.tld=function(e,t){if(this._parts.urn)return e===undefined?"":this;typeof e=="boolean"&&(t=e,e=undefined);if(e===undefined){if(!this._parts.hostname||this.is("IP"))return"";var r=this._parts.hostname.lastIndexOf("."),i=this._parts.hostname.substring(r+1);return t!==!0&&n&&n.list[i.toLowerCase()]?n.get(this._parts.hostname)||i:i}var s;if(!e)throw new TypeError("cannot set TLD empty");if(e.match(/[^a-zA-Z0-9-]/)){if(!n||!n.is(e))throw new TypeError("TLD '"+e+"' contains characters other than [A-Z0-9]");s=new RegExp(a(this.tld())+"$"),this._parts.hostname=this._parts.hostname.replace(s,e)}else{if(!this._parts.hostname||this.is("IP"))throw new ReferenceError("cannot set TLD on non-domain host");s=new RegExp(a(this.tld())+"$"),this._parts.hostname=this._parts.hostname.replace(s,e)}return this.build(!t),this},o.directory=function(e,t){if(this._parts.urn)return e===undefined?"":this;if(e===undefined||e===!0){if(!this._parts.path&&!this._parts.hostname)return"";if(this._parts.path==="/")return"/";var n=this._parts.path.length-this.filename().length-1,r=this._parts.path.substring(0,n)||(this._parts.hostname?"/":"");return e?s.decodePath(r):r}var i=this._parts.path.length-this.filename().length,o=this._parts.path.substring(0,i),u=new RegExp("^"+a(o));return this.is("relative")||(e||(e="/"),e.charAt(0)!=="/"&&(e="/"+e)),e&&e.charAt(e.length-1)!=="/"&&(e+="/"),e=s.recodePath(e),this._parts.path=this._parts.path.replace(u,e),this.build(!t),this},o.filename=function(e,t){if(this._parts.urn)return e===undefined?"":this;if(e===undefined||e===!0){if(!this._parts.path||this._parts.path==="/")return"";var n=this._parts.path.lastIndexOf("/"),r=this._parts.path.substring(n+1);return e?s.decodePathSegment(r):r}var i=!1;e.charAt(0)==="/"&&(e=e.substring(1)),e.match(/\.?\//)&&(i=!0);var o=new RegExp(a(this.filename())+"$");return e=s.recodePath(e),this._parts.path=this._parts.path.replace(o,e),i?this.normalizePath(t):this.build(!t),this},o.suffix=function(e,t){if(this._parts.urn)return e===undefined?"":this;if(e===undefined||e===!0){if(!this._parts.path||this._parts.path==="/")return"";var n=this.filename(),r=n.lastIndexOf("."),i,o;return r===-1?"":(i=n.substring(r+1),o=/^[a-z0-9%]+$/i.test(i)?i:"",e?s.decodePathSegment(o):o)}e.charAt(0)==="."&&(e=e.substring(1));var u=this.suffix(),f;if(!u){if(!e)return this;this._parts.path+="."+s.recodePath(e)}else e?f=new RegExp(a(u)+"$"):f=new RegExp(a("."+u)+"$");return f&&(e=s.recodePath(e),this._parts.path=this._parts.path.replace(f,e)),this.build(!t),this},o.segment=function(e,t,n){var r=this._parts.urn?":":"/",i=this.path(),s=i.substring(0,1)==="/",o=i.split(r);e!==undefined&&typeof e!="number"&&(n=t,t=e,e=undefined);if(e!==undefined&&typeof e!="number")throw new Error("Bad segment '"+e+"', must be 0-based integer");s&&o.shift(),e<0&&(e=Math.max(o.length+e,0));if(t===undefined)return e===undefined?o:o[e];if(e===null||o[e]===undefined){if(l(t)){o=[];for(var u=0,a=t.length;u<a;u++){if(!t[u].length&&(!o.length||!o[o.length-1].length))continue;o.length&&!o[o.length-1].length&&o.pop(),o.push(t[u])}}else if(t||typeof t=="string")o[o.length-1]===""?o[o.length-1]=t:o.push(t)}else t||typeof t=="string"&&t.length?o[e]=t:o.splice(e,1);return s&&o.unshift(""),this.path(o.join(r),n)},o.segmentCoded=function(e,t,n){var r,i,o;typeof e!="number"&&(n=t,t=e,e=undefined);if(t===undefined){r=this.segment(e,t,n);if(!l(r))r=r!==undefined?s.decode(r):undefined;else for(i=0,o=r.length;i<o;i++)r[i]=s.decode(r[i]);
return r}if(!l(t))t=typeof t=="string"?s.encode(t):t;else for(i=0,o=t.length;i<o;i++)t[i]=s.decode(t[i]);return this.segment(e,t,n)};var S=o.query;return o.query=function(e,t){if(e===!0)return s.parseQuery(this._parts.query,this._parts.escapeQuerySpace);if(typeof e=="function"){var n=s.parseQuery(this._parts.query,this._parts.escapeQuerySpace),r=e.call(this,n);return this._parts.query=s.buildQuery(r||n,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),this.build(!t),this}return e!==undefined&&typeof e!="string"?(this._parts.query=s.buildQuery(e,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),this.build(!t),this):S.call(this,e,t)},o.setQuery=function(e,t,n){var r=s.parseQuery(this._parts.query,this._parts.escapeQuerySpace);if(typeof e=="object")for(var i in e)u.call(e,i)&&(r[i]=e[i]);else{if(typeof e!="string")throw new TypeError("URI.addQuery() accepts an object, string as the name parameter");r[e]=t!==undefined?t:null}return this._parts.query=s.buildQuery(r,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),typeof e!="string"&&(n=t),this.build(!n),this},o.addQuery=function(e,t,n){var r=s.parseQuery(this._parts.query,this._parts.escapeQuerySpace);return s.addQuery(r,e,t===undefined?null:t),this._parts.query=s.buildQuery(r,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),typeof e!="string"&&(n=t),this.build(!n),this},o.removeQuery=function(e,t,n){var r=s.parseQuery(this._parts.query,this._parts.escapeQuerySpace);return s.removeQuery(r,e,t),this._parts.query=s.buildQuery(r,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),typeof e!="string"&&(n=t),this.build(!n),this},o.hasQuery=function(e,t,n){var r=s.parseQuery(this._parts.query,this._parts.escapeQuerySpace);return s.hasQuery(r,e,t,n)},o.setSearch=o.setQuery,o.addSearch=o.addQuery,o.removeSearch=o.removeQuery,o.hasSearch=o.hasQuery,o.normalize=function(){return this._parts.urn?this.normalizeProtocol(!1).normalizeQuery(!1).normalizeFragment(!1).build():this.normalizeProtocol(!1).normalizeHostname(!1).normalizePort(!1).normalizePath(!1).normalizeQuery(!1).normalizeFragment(!1).build()},o.normalizeProtocol=function(e){return typeof this._parts.protocol=="string"&&(this._parts.protocol=this._parts.protocol.toLowerCase(),this.build(!e)),this},o.normalizeHostname=function(n){return this._parts.hostname&&(this.is("IDN")&&e?this._parts.hostname=e.toASCII(this._parts.hostname):this.is("IPv6")&&t&&(this._parts.hostname=t.best(this._parts.hostname)),this._parts.hostname=this._parts.hostname.toLowerCase(),this.build(!n)),this},o.normalizePort=function(e){return typeof this._parts.protocol=="string"&&this._parts.port===s.defaultPorts[this._parts.protocol]&&(this._parts.port=null,this.build(!e)),this},o.normalizePath=function(e){if(this._parts.urn)return this;if(!this._parts.path||this._parts.path==="/")return this;var t,n=this._parts.path,r,i;n.charAt(0)!=="/"&&(t=!0,n="/"+n),n=n.replace(/(\/(\.\/)+)|(\/\.$)/g,"/").replace(/\/{2,}/g,"/");for(;;){r=n.indexOf("/../");if(r===-1)break;if(r===0){n=n.substring(3);break}i=n.substring(0,r).lastIndexOf("/"),i===-1&&(i=r),n=n.substring(0,i)+n.substring(r+3)}return t&&this.is("relative")&&(n=n.substring(1)),n=s.recodePath(n),this._parts.path=n,this.build(!e),this},o.normalizePathname=o.normalizePath,o.normalizeQuery=function(e){return typeof this._parts.query=="string"&&(this._parts.query.length?this.query(s.parseQuery(this._parts.query,this._parts.escapeQuerySpace)):this._parts.query=null,this.build(!e)),this},o.normalizeFragment=function(e){return this._parts.fragment||(this._parts.fragment=null,this.build(!e)),this},o.normalizeSearch=o.normalizeQuery,o.normalizeHash=o.normalizeFragment,o.iso8859=function(){var e=s.encode,t=s.decode;return s.encode=escape,s.decode=decodeURIComponent,this.normalize(),s.encode=e,s.decode=t,this},o.unicode=function(){var e=s.encode,t=s.decode;return s.encode=v,s.decode=unescape,this.normalize(),s.encode=e,s.decode=t,this},o.readable=function(){var t=this.clone();t.username("").password("").normalize();var n="";t._parts.protocol&&(n+=t._parts.protocol+"://"),t._parts.hostname&&(t.is("punycode")&&e?(n+=e.toUnicode(t._parts.hostname),t._parts.port&&(n+=":"+t._parts.port)):n+=t.host()),t._parts.hostname&&t._parts.path&&t._parts.path.charAt(0)!=="/"&&(n+="/"),n+=t.path(!0);if(t._parts.query){var r="";for(var i=0,o=t._parts.query.split("&"),u=o.length;i<u;i++){var a=(o[i]||"").split("=");r+="&"+s.decodeQuery(a[0],this._parts.escapeQuerySpace).replace(/&/g,"%26"),a[1]!==undefined&&(r+="="+s.decodeQuery(a[1],this._parts.escapeQuerySpace).replace(/&/g,"%26"))}n+="?"+r.substring(1)}return n+=s.decodeQuery(t.hash(),!0),n},o.absoluteTo=function(e){var t=this.clone(),n=["protocol","username","password","hostname","port"],r,i,o;if(this._parts.urn)throw new Error("URNs do not have any generally defined hierarchical components");e instanceof s||(e=new s(e)),t._parts.protocol||(t._parts.protocol=e._parts.protocol);if(this._parts.hostname)return t;for(i=0;o=n[i];i++)t._parts[o]=e._parts[o];n=["query","path"];for(i=0;o=n[i];i++)!t._parts[o]&&e._parts[o]&&(t._parts[o]=e._parts[o]);return t.path().charAt(0)!=="/"&&(r=e.directory(),t._parts.path=(r?r+"/":"")+t._parts.path,t.normalizePath()),t.build(),t},o.relativeTo=function(e){var t=this.clone().normalize(),n,r,i,o,u;if(t._parts.urn)throw new Error("URNs do not have any generally defined hierarchical components");e=new s(e).normalize(),n=t._parts,r=e._parts,o=t.path(),u=e.path();if(o.charAt(0)!=="/")throw new Error("URI is already relative");if(u.charAt(0)!=="/")throw new Error("Cannot calculate a URI relative to another relative URI");n.protocol===r.protocol&&(n.protocol=null);if(n.username!==r.username||n.password!==r.password)return t.build();if(n.protocol!==null||n.username!==null||n.password!==null)return t.build();if(n.hostname!==r.hostname||n.port!==r.port)return t.build();n.hostname=null,n.port=null;if(o===u)return n.path="",t.build();i=s.commonPath(t.path(),e.path());if(!i)return t.build();var a=r.path.substring(i.length).replace(/[^\/]*$/,"").replace(/.*?\//g,"../");return n.path=a+n.path.substring(i.length),t.build()},o.equals=function(e){var t=this.clone(),n=new s(e),r={},i={},o={},a,f,c;t.normalize(),n.normalize();if(t.toString()===n.toString())return!0;a=t.query(),f=n.query(),t.query(""),n.query("");if(t.toString()!==n.toString())return!1;if(a.length!==f.length)return!1;r=s.parseQuery(a,this._parts.escapeQuerySpace),i=s.parseQuery(f,this._parts.escapeQuerySpace);for(c in r)if(u.call(r,c)){if(!l(r[c])){if(r[c]!==i[c])return!1}else if(!p(r[c],i[c]))return!1;o[c]=!0}for(c in i)if(u.call(i,c)&&!o[c])return!1;return!0},o.duplicateQueryParameters=function(e){return this._parts.duplicateQueryParameters=!!e,this},o.escapeQuerySpace=function(e){return this._parts.escapeQuerySpace=!!e,this},s});!function($){$.fn.extend({leanModal:function(options){var defaults={top:100,overlay:.5,closeButton:null};var overlay=$("<div id='lean_overlay'></div>");$("body").append(overlay);options=$.extend(defaults,options);return this.each(function(){var o=options;$(this).click(function(e){var modal_id=$(this).attr("href");$("#lean_overlay").click(function(){close_modal(modal_id)});$(o.closeButton).click(function(){close_modal(modal_id)});var modal_height=$(modal_id).outerHeight();var modal_width=$(modal_id).outerWidth();$("#lean_overlay").css({display:"block",opacity:0});$("#lean_overlay").fadeTo(200,o.overlay);$(modal_id).css({display:"block",position:"fixed",opacity:0,"z-index":11e3,left:50+"%","margin-left":-(modal_width/2)+"px",top:o.top+"px"});$(modal_id).fadeTo(200,1);e.preventDefault()})});function close_modal(modal_id){$("#lean_overlay").fadeOut(200);$(modal_id).css({display:"none"})}}})}(jQuery);!function($){$.timeago=function(timestamp){if(timestamp instanceof Date){return inWords(timestamp)}else if(typeof timestamp==="string"){return inWords($.timeago.parse(timestamp))}else if(typeof timestamp==="number"){return inWords(new Date(timestamp))}else{return inWords($.timeago.datetime(timestamp))}};var $t=$.timeago;$.extend($.timeago,{settings:{refreshMillis:6e4,allowFuture:false,strings:{formatAgo:"%s ago",formatFromNow:"%s from now",seconds:"less than a minute",minute:"about a minute",minutes:"%d minutes",hour:"about an hour",hours:"about %d hours",day:"a day",days:"%d days",month:"about a month",months:"%d months",year:"about a year",years:"%d years",numbers:[]}},inWords:function(distanceMillis){var $l=this.settings.strings;var format=$l.formatAgo;if(this.settings.allowFuture){if(distanceMillis<0){format=$l.formatFromNow}}var seconds=Math.abs(distanceMillis)/1e3;var minutes=seconds/60;var hours=minutes/60;var days=hours/24;var years=days/365;function substitute(stringOrFunction,number){var string=$.isFunction(stringOrFunction)?stringOrFunction(number,distanceMillis):stringOrFunction;var value=$l.numbers&&$l.numbers[number]||number;return string.replace(/%d/i,value)}var words=seconds<45&&substitute($l.seconds,Math.round(seconds))||seconds<90&&substitute($l.minute,1)||minutes<45&&substitute($l.minutes,Math.round(minutes))||minutes<90&&substitute($l.hour,1)||hours<24&&substitute($l.hours,Math.round(hours))||hours<42&&substitute($l.day,1)||days<30&&substitute($l.days,Math.round(days))||days<45&&substitute($l.month,1)||days<365&&substitute($l.months,Math.round(days/30))||years<1.5&&substitute($l.year,1)||substitute($l.years,Math.round(years));return $.trim(format.replace(/%s/i,words))},parse:function(iso8601){var s=$.trim(iso8601);s=s.replace(/\.\d+/,"");s=s.replace(/-/,"/").replace(/-/,"/");s=s.replace(/T/," ").replace(/Z/," UTC");s=s.replace(/([\+\-]\d\d)\:?(\d\d)/," $1$2");return new Date(s)},datetime:function(elem){var iso8601=$t.isTime(elem)?$(elem).attr("datetime"):$(elem).attr("title");return $t.parse(iso8601)},isTime:function(elem){return $(elem).get(0).tagName.toLowerCase()==="time"}});$.fn.timeago=function(){var self=this;self.each(refresh);var $s=$t.settings;if($s.refreshMillis>0){setInterval(function(){self.each(refresh)},$s.refreshMillis)}return self};function refresh(){var data=prepareData(this);if(!isNaN(data.datetime)){$(this).text(inWords(data.datetime))}return this}function prepareData(element){element=$(element);if(!element.data("timeago")){element.data("timeago",{datetime:$t.datetime(element)});var text=$.trim(element.text());if(text.length>0&&!($t.isTime(element)&&element.attr("title"))){element.attr("title",text)}}return element.data("timeago")}function inWords(date){return $t.inWords(distance(date))}function distance(date){return(new Date).getTime()-date.getTime()}document.createElement("abbr");document.createElement("time")}(jQuery);!function(){var n=this,t=n._,r={},e=Array.prototype,u=Object.prototype,i=Function.prototype,a=e.push,o=e.slice,c=e.concat,l=u.toString,f=u.hasOwnProperty,s=e.forEach,p=e.map,h=e.reduce,v=e.reduceRight,d=e.filter,g=e.every,m=e.some,y=e.indexOf,b=e.lastIndexOf,x=Array.isArray,_=Object.keys,j=i.bind,w=function(n){return n instanceof w?n:this instanceof w?(this._wrapped=n,void 0):new w(n)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=w),exports._=w):n._=w,w.VERSION="1.4.4";var A=w.each=w.forEach=function(n,t,e){if(null!=n)if(s&&n.forEach===s)n.forEach(t,e);else if(n.length===+n.length){for(var u=0,i=n.length;i>u;u++)if(t.call(e,n[u],u,n)===r)return}else for(var a in n)if(w.has(n,a)&&t.call(e,n[a],a,n)===r)return};w.map=w.collect=function(n,t,r){var e=[];return null==n?e:p&&n.map===p?n.map(t,r):(A(n,function(n,u,i){e[e.length]=t.call(r,n,u,i)}),e)};var O="Reduce of empty array with no initial value";w.reduce=w.foldl=w.inject=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),h&&n.reduce===h)return e&&(t=w.bind(t,e)),u?n.reduce(t,r):n.reduce(t);if(A(n,function(n,i,a){u?r=t.call(e,r,n,i,a):(r=n,u=!0)}),!u)throw new TypeError(O);return r},w.reduceRight=w.foldr=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),v&&n.reduceRight===v)return e&&(t=w.bind(t,e)),u?n.reduceRight(t,r):n.reduceRight(t);var i=n.length;if(i!==+i){var a=w.keys(n);i=a.length}if(A(n,function(o,c,l){c=a?a[--i]:--i,u?r=t.call(e,r,n[c],c,l):(r=n[c],u=!0)}),!u)throw new TypeError(O);return r},w.find=w.detect=function(n,t,r){var e;return E(n,function(n,u,i){return t.call(r,n,u,i)?(e=n,!0):void 0}),e},w.filter=w.select=function(n,t,r){var e=[];return null==n?e:d&&n.filter===d?n.filter(t,r):(A(n,function(n,u,i){t.call(r,n,u,i)&&(e[e.length]=n)}),e)},w.reject=function(n,t,r){return w.filter(n,function(n,e,u){return!t.call(r,n,e,u)},r)},w.every=w.all=function(n,t,e){t||(t=w.identity);var u=!0;return null==n?u:g&&n.every===g?n.every(t,e):(A(n,function(n,i,a){return(u=u&&t.call(e,n,i,a))?void 0:r}),!!u)};var E=w.some=w.any=function(n,t,e){t||(t=w.identity);var u=!1;return null==n?u:m&&n.some===m?n.some(t,e):(A(n,function(n,i,a){return u||(u=t.call(e,n,i,a))?r:void 0}),!!u)};w.contains=w.include=function(n,t){return null==n?!1:y&&n.indexOf===y?n.indexOf(t)!=-1:E(n,function(n){return n===t})},w.invoke=function(n,t){var r=o.call(arguments,2),e=w.isFunction(t);return w.map(n,function(n){return(e?t:n[t]).apply(n,r)})},w.pluck=function(n,t){return w.map(n,function(n){return n[t]})},w.where=function(n,t,r){return w.isEmpty(t)?r?null:[]:w[r?"find":"filter"](n,function(n){for(var r in t)if(t[r]!==n[r])return!1;return!0})},w.findWhere=function(n,t){return w.where(n,t,!0)},w.max=function(n,t,r){if(!t&&w.isArray(n)&&n[0]===+n[0]&&65535>n.length)return Math.max.apply(Math,n);if(!t&&w.isEmpty(n))return-1/0;var e={computed:-1/0,value:-1/0};return A(n,function(n,u,i){var a=t?t.call(r,n,u,i):n;a>=e.computed&&(e={value:n,computed:a})}),e.value},w.min=function(n,t,r){if(!t&&w.isArray(n)&&n[0]===+n[0]&&65535>n.length)return Math.min.apply(Math,n);if(!t&&w.isEmpty(n))return 1/0;var e={computed:1/0,value:1/0};return A(n,function(n,u,i){var a=t?t.call(r,n,u,i):n;e.computed>a&&(e={value:n,computed:a})}),e.value},w.shuffle=function(n){var t,r=0,e=[];return A(n,function(n){t=w.random(r++),e[r-1]=e[t],e[t]=n}),e};var k=function(n){return w.isFunction(n)?n:function(t){return t[n]}};w.sortBy=function(n,t,r){var e=k(t);return w.pluck(w.map(n,function(n,t,u){return{value:n,index:t,criteria:e.call(r,n,t,u)}}).sort(function(n,t){var r=n.criteria,e=t.criteria;if(r!==e){if(r>e||r===void 0)return 1;if(e>r||e===void 0)return-1}return n.index<t.index?-1:1}),"value")};var F=function(n,t,r,e){var u={},i=k(t||w.identity);return A(n,function(t,a){var o=i.call(r,t,a,n);e(u,o,t)}),u};w.groupBy=function(n,t,r){return F(n,t,r,function(n,t,r){(w.has(n,t)?n[t]:n[t]=[]).push(r)})},w.countBy=function(n,t,r){return F(n,t,r,function(n,t){w.has(n,t)||(n[t]=0),n[t]++})},w.sortedIndex=function(n,t,r,e){r=null==r?w.identity:k(r);for(var u=r.call(e,t),i=0,a=n.length;a>i;){var o=i+a>>>1;u>r.call(e,n[o])?i=o+1:a=o}return i},w.toArray=function(n){return n?w.isArray(n)?o.call(n):n.length===+n.length?w.map(n,w.identity):w.values(n):[]},w.size=function(n){return null==n?0:n.length===+n.length?n.length:w.keys(n).length},w.first=w.head=w.take=function(n,t,r){return null==n?void 0:null==t||r?n[0]:o.call(n,0,t)},w.initial=function(n,t,r){return o.call(n,0,n.length-(null==t||r?1:t))},w.last=function(n,t,r){return null==n?void 0:null==t||r?n[n.length-1]:o.call(n,Math.max(n.length-t,0))},w.rest=w.tail=w.drop=function(n,t,r){return o.call(n,null==t||r?1:t)},w.compact=function(n){return w.filter(n,w.identity)};var R=function(n,t,r){return A(n,function(n){w.isArray(n)?t?a.apply(r,n):R(n,t,r):r.push(n)}),r};w.flatten=function(n,t){return R(n,t,[])},w.without=function(n){return w.difference(n,o.call(arguments,1))},w.uniq=w.unique=function(n,t,r,e){w.isFunction(t)&&(e=r,r=t,t=!1);var u=r?w.map(n,r,e):n,i=[],a=[];return A(u,function(r,e){(t?e&&a[a.length-1]===r:w.contains(a,r))||(a.push(r),i.push(n[e]))}),i},w.union=function(){return w.uniq(c.apply(e,arguments))},w.intersection=function(n){var t=o.call(arguments,1);return w.filter(w.uniq(n),function(n){return w.every(t,function(t){return w.indexOf(t,n)>=0})})},w.difference=function(n){var t=c.apply(e,o.call(arguments,1));return w.filter(n,function(n){return!w.contains(t,n)})},w.zip=function(){for(var n=o.call(arguments),t=w.max(w.pluck(n,"length")),r=Array(t),e=0;t>e;e++)r[e]=w.pluck(n,""+e);return r},w.object=function(n,t){if(null==n)return{};for(var r={},e=0,u=n.length;u>e;e++)t?r[n[e]]=t[e]:r[n[e][0]]=n[e][1];return r},w.indexOf=function(n,t,r){if(null==n)return-1;var e=0,u=n.length;if(r){if("number"!=typeof r)return e=w.sortedIndex(n,t),n[e]===t?e:-1;e=0>r?Math.max(0,u+r):r}if(y&&n.indexOf===y)return n.indexOf(t,r);for(;u>e;e++)if(n[e]===t)return e;return-1},w.lastIndexOf=function(n,t,r){if(null==n)return-1;var e=null!=r;if(b&&n.lastIndexOf===b)return e?n.lastIndexOf(t,r):n.lastIndexOf(t);for(var u=e?r:n.length;u--;)if(n[u]===t)return u;return-1},w.range=function(n,t,r){1>=arguments.length&&(t=n||0,n=0),r=arguments[2]||1;for(var e=Math.max(Math.ceil((t-n)/r),0),u=0,i=Array(e);e>u;)i[u++]=n,n+=r;return i},w.bind=function(n,t){if(n.bind===j&&j)return j.apply(n,o.call(arguments,1));var r=o.call(arguments,2);return function(){return n.apply(t,r.concat(o.call(arguments)))}},w.partial=function(n){var t=o.call(arguments,1);return function(){return n.apply(this,t.concat(o.call(arguments)))}},w.bindAll=function(n){var t=o.call(arguments,1);return 0===t.length&&(t=w.functions(n)),A(t,function(t){n[t]=w.bind(n[t],n)}),n},w.memoize=function(n,t){var r={};return t||(t=w.identity),function(){var e=t.apply(this,arguments);return w.has(r,e)?r[e]:r[e]=n.apply(this,arguments)}},w.delay=function(n,t){var r=o.call(arguments,2);return setTimeout(function(){return n.apply(null,r)},t)},w.defer=function(n){return w.delay.apply(w,[n,1].concat(o.call(arguments,1)))},w.throttle=function(n,t){var r,e,u,i,a=0,o=function(){a=new Date,u=null,i=n.apply(r,e)};return function(){var c=new Date,l=t-(c-a);return r=this,e=arguments,0>=l?(clearTimeout(u),u=null,a=c,i=n.apply(r,e)):u||(u=setTimeout(o,l)),i}},w.debounce=function(n,t,r){var e,u;return function(){var i=this,a=arguments,o=function(){e=null,r||(u=n.apply(i,a))},c=r&&!e;return clearTimeout(e),e=setTimeout(o,t),c&&(u=n.apply(i,a)),u}},w.once=function(n){var t,r=!1;return function(){return r?t:(r=!0,t=n.apply(this,arguments),n=null,t)}},w.wrap=function(n,t){return function(){var r=[n];return a.apply(r,arguments),t.apply(this,r)}},w.compose=function(){var n=arguments;return function(){for(var t=arguments,r=n.length-1;r>=0;r--)t=[n[r].apply(this,t)];return t[0]}},w.after=function(n,t){return 0>=n?t():function(){return 1>--n?t.apply(this,arguments):void 0}},w.keys=_||function(n){if(n!==Object(n))throw new TypeError("Invalid object");var t=[];for(var r in n)w.has(n,r)&&(t[t.length]=r);return t},w.values=function(n){var t=[];for(var r in n)w.has(n,r)&&t.push(n[r]);return t},w.pairs=function(n){var t=[];for(var r in n)w.has(n,r)&&t.push([r,n[r]]);return t},w.invert=function(n){var t={};for(var r in n)w.has(n,r)&&(t[n[r]]=r);return t},w.functions=w.methods=function(n){var t=[];for(var r in n)w.isFunction(n[r])&&t.push(r);return t.sort()},w.extend=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)n[r]=t[r]}),n},w.pick=function(n){var t={},r=c.apply(e,o.call(arguments,1));return A(r,function(r){r in n&&(t[r]=n[r])}),t},w.omit=function(n){var t={},r=c.apply(e,o.call(arguments,1));for(var u in n)w.contains(r,u)||(t[u]=n[u]);return t},w.defaults=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)null==n[r]&&(n[r]=t[r])}),n},w.clone=function(n){return w.isObject(n)?w.isArray(n)?n.slice():w.extend({},n):n},w.tap=function(n,t){return t(n),n};var I=function(n,t,r,e){if(n===t)return 0!==n||1/n==1/t;if(null==n||null==t)return n===t;n instanceof w&&(n=n._wrapped),t instanceof w&&(t=t._wrapped);var u=l.call(n);if(u!=l.call(t))return!1;switch(u){case"[object String]":return n==t+"";case"[object Number]":return n!=+n?t!=+t:0==n?1/n==1/t:n==+t;case"[object Date]":case"[object Boolean]":return+n==+t;case"[object RegExp]":return n.source==t.source&&n.global==t.global&&n.multiline==t.multiline&&n.ignoreCase==t.ignoreCase}if("object"!=typeof n||"object"!=typeof t)return!1;for(var i=r.length;i--;)if(r[i]==n)return e[i]==t;r.push(n),e.push(t);var a=0,o=!0;if("[object Array]"==u){if(a=n.length,o=a==t.length)for(;a--&&(o=I(n[a],t[a],r,e)););}else{var c=n.constructor,f=t.constructor;if(c!==f&&!(w.isFunction(c)&&c instanceof c&&w.isFunction(f)&&f instanceof f))return!1;for(var s in n)if(w.has(n,s)&&(a++,!(o=w.has(t,s)&&I(n[s],t[s],r,e))))break;if(o){for(s in t)if(w.has(t,s)&&!a--)break;o=!a}}return r.pop(),e.pop(),o};w.isEqual=function(n,t){return I(n,t,[],[])},w.isEmpty=function(n){if(null==n)return!0;if(w.isArray(n)||w.isString(n))return 0===n.length;for(var t in n)if(w.has(n,t))return!1;return!0},w.isElement=function(n){return!(!n||1!==n.nodeType)},w.isArray=x||function(n){return"[object Array]"==l.call(n)},w.isObject=function(n){return n===Object(n)},A(["Arguments","Function","String","Number","Date","RegExp"],function(n){w["is"+n]=function(t){return l.call(t)=="[object "+n+"]"}}),w.isArguments(arguments)||(w.isArguments=function(n){return!(!n||!w.has(n,"callee"))}),"function"!=typeof/./&&(w.isFunction=function(n){return"function"==typeof n}),w.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))},w.isNaN=function(n){return w.isNumber(n)&&n!=+n},w.isBoolean=function(n){return n===!0||n===!1||"[object Boolean]"==l.call(n)},w.isNull=function(n){return null===n},w.isUndefined=function(n){return n===void 0},w.has=function(n,t){return f.call(n,t)},w.noConflict=function(){return n._=t,this},w.identity=function(n){return n},w.times=function(n,t,r){for(var e=Array(n),u=0;n>u;u++)e[u]=t.call(r,u);return e},w.random=function(n,t){return null==t&&(t=n,n=0),n+Math.floor(Math.random()*(t-n+1))};var M={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};M.unescape=w.invert(M.escape);var S={escape:RegExp("["+w.keys(M.escape).join("")+"]","g"),unescape:RegExp("("+w.keys(M.unescape).join("|")+")","g")};w.each(["escape","unescape"],function(n){w[n]=function(t){return null==t?"":(""+t).replace(S[n],function(t){return M[n][t]})}}),w.result=function(n,t){if(null==n)return null;var r=n[t];return w.isFunction(r)?r.call(n):r},w.mixin=function(n){A(w.functions(n),function(t){var r=w[t]=n[t];w.prototype[t]=function(){var n=[this._wrapped];return a.apply(n,arguments),D.call(this,r.apply(w,n))}})};var N=0;w.uniqueId=function(n){var t=++N+"";return n?n+t:t},w.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var T=/(.)^/,q={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},B=/\\|'|\r|\n|\t|\u2028|\u2029/g;w.template=function(n,t,r){var e;r=w.defaults({},r,w.templateSettings);var u=RegExp([(r.escape||T).source,(r.interpolate||T).source,(r.evaluate||T).source].join("|")+"|$","g"),i=0,a="__p+='";n.replace(u,function(t,r,e,u,o){return a+=n.slice(i,o).replace(B,function(n){return"\\"+q[n]}),r&&(a+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'"),e&&(a+="'+\n((__t=("+e+"))==null?'':__t)+\n'"),u&&(a+="';\n"+u+"\n__p+='"),i=o+t.length,t}),a+="';\n",r.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{e=Function(r.variable||"obj","_",a)}catch(o){throw o.source=a,o}if(t)return e(t,w);var c=function(n){return e.call(this,n,w)};return c.source="function("+(r.variable||"obj")+"){\n"+a+"}",c},w.chain=function(n){return w(n).chain()};var D=function(n){return this._chain?w(n).chain():n};w.mixin(w),A(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var t=e[n];w.prototype[n]=function(){var r=this._wrapped;return t.apply(r,arguments),"shift"!=n&&"splice"!=n||0!==r.length||delete r[0],D.call(this,r)}}),A(["concat","join","slice"],function(n){var t=e[n];w.prototype[n]=function(){return D.call(this,t.apply(this._wrapped,arguments))}}),w.extend(w.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}.call(this);!function(){var t=this;var e=t.Backbone;var i=[];var r=i.push;var s=i.slice;var n=i.splice;var a;if(typeof exports!=="undefined"){a=exports}else{a=t.Backbone={}}a.VERSION="1.0.0";var h=t._;if(!h&&typeof require!=="undefined")h=require("underscore");a.$=t.jQuery||t.Zepto||t.ender||t.$;a.noConflict=function(){t.Backbone=e;return this};a.emulateHTTP=false;a.emulateJSON=false;var o=a.Events={on:function(t,e,i){if(!l(this,"on",t,[e,i])||!e)return this;this._events||(this._events={});var r=this._events[t]||(this._events[t]=[]);r.push({callback:e,context:i,ctx:i||this});return this},once:function(t,e,i){if(!l(this,"once",t,[e,i])||!e)return this;var r=this;var s=h.once(function(){r.off(t,s);e.apply(this,arguments)});s._callback=e;return this.on(t,s,i)},off:function(t,e,i){var r,s,n,a,o,u,c,f;if(!this._events||!l(this,"off",t,[e,i]))return this;if(!t&&!e&&!i){this._events={};return this}a=t?[t]:h.keys(this._events);for(o=0,u=a.length;o<u;o++){t=a[o];if(n=this._events[t]){this._events[t]=r=[];if(e||i){for(c=0,f=n.length;c<f;c++){s=n[c];if(e&&e!==s.callback&&e!==s.callback._callback||i&&i!==s.context){r.push(s)}}}if(!r.length)delete this._events[t]}}return this},trigger:function(t){if(!this._events)return this;var e=s.call(arguments,1);if(!l(this,"trigger",t,e))return this;var i=this._events[t];var r=this._events.all;if(i)c(i,e);if(r)c(r,arguments);return this},stopListening:function(t,e,i){var r=this._listeners;if(!r)return this;var s=!e&&!i;if(typeof e==="object")i=this;if(t)(r={})[t._listenerId]=t;for(var n in r){r[n].off(e,i,this);if(s)delete this._listeners[n]}return this}};var u=/\s+/;var l=function(t,e,i,r){if(!i)return true;if(typeof i==="object"){for(var s in i){t[e].apply(t,[s,i[s]].concat(r))}return false}if(u.test(i)){var n=i.split(u);for(var a=0,h=n.length;a<h;a++){t[e].apply(t,[n[a]].concat(r))}return false}return true};var c=function(t,e){var i,r=-1,s=t.length,n=e[0],a=e[1],h=e[2];switch(e.length){case 0:while(++r<s)(i=t[r]).callback.call(i.ctx);return;case 1:while(++r<s)(i=t[r]).callback.call(i.ctx,n);return;case 2:while(++r<s)(i=t[r]).callback.call(i.ctx,n,a);return;case 3:while(++r<s)(i=t[r]).callback.call(i.ctx,n,a,h);return;default:while(++r<s)(i=t[r]).callback.apply(i.ctx,e)}};var f={listenTo:"on",listenToOnce:"once"};h.each(f,function(t,e){o[e]=function(e,i,r){var s=this._listeners||(this._listeners={});var n=e._listenerId||(e._listenerId=h.uniqueId("l"));s[n]=e;if(typeof i==="object")r=this;e[t](i,r,this);return this}});o.bind=o.on;o.unbind=o.off;h.extend(a,o);var d=a.Model=function(t,e){var i;var r=t||{};e||(e={});this.cid=h.uniqueId("c");this.attributes={};h.extend(this,h.pick(e,p));if(e.parse)r=this.parse(r,e)||{};if(i=h.result(this,"defaults")){r=h.defaults({},r,i)}this.set(r,e);this.changed={};this.initialize.apply(this,arguments)};var p=["url","urlRoot","collection"];h.extend(d.prototype,o,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(t){return h.clone(this.attributes)},sync:function(){return a.sync.apply(this,arguments)},get:function(t){return this.attributes[t]},escape:function(t){return h.escape(this.get(t))},has:function(t){return this.get(t)!=null},set:function(t,e,i){var r,s,n,a,o,u,l,c;if(t==null)return this;if(typeof t==="object"){s=t;i=e}else{(s={})[t]=e}i||(i={});if(!this._validate(s,i))return false;n=i.unset;o=i.silent;a=[];u=this._changing;this._changing=true;if(!u){this._previousAttributes=h.clone(this.attributes);this.changed={}}c=this.attributes,l=this._previousAttributes;if(this.idAttribute in s)this.id=s[this.idAttribute];for(r in s){e=s[r];if(!h.isEqual(c[r],e))a.push(r);if(!h.isEqual(l[r],e)){this.changed[r]=e}else{delete this.changed[r]}n?delete c[r]:c[r]=e}if(!o){if(a.length)this._pending=true;for(var f=0,d=a.length;f<d;f++){this.trigger("change:"+a[f],this,c[a[f]],i)}}if(u)return this;if(!o){while(this._pending){this._pending=false;this.trigger("change",this,i)}}this._pending=false;this._changing=false;return this},unset:function(t,e){return this.set(t,void 0,h.extend({},e,{unset:true}))},clear:function(t){var e={};for(var i in this.attributes)e[i]=void 0;return this.set(e,h.extend({},t,{unset:true}))},hasChanged:function(t){if(t==null)return!h.isEmpty(this.changed);return h.has(this.changed,t)},changedAttributes:function(t){if(!t)return this.hasChanged()?h.clone(this.changed):false;var e,i=false;var r=this._changing?this._previousAttributes:this.attributes;for(var s in t){if(h.isEqual(r[s],e=t[s]))continue;(i||(i={}))[s]=e}return i},previous:function(t){if(t==null||!this._previousAttributes)return null;return this._previousAttributes[t]},previousAttributes:function(){return h.clone(this._previousAttributes)},fetch:function(t){t=t?h.clone(t):{};if(t.parse===void 0)t.parse=true;var e=this;var i=t.success;t.success=function(r){if(!e.set(e.parse(r,t),t))return false;if(i)i(e,r,t);e.trigger("sync",e,r,t)};R(this,t);return this.sync("read",this,t)},save:function(t,e,i){var r,s,n,a=this.attributes;if(t==null||typeof t==="object"){r=t;i=e}else{(r={})[t]=e}if(r&&(!i||!i.wait)&&!this.set(r,i))return false;i=h.extend({validate:true},i);if(!this._validate(r,i))return false;if(r&&i.wait){this.attributes=h.extend({},a,r)}if(i.parse===void 0)i.parse=true;var o=this;var u=i.success;i.success=function(t){o.attributes=a;var e=o.parse(t,i);if(i.wait)e=h.extend(r||{},e);if(h.isObject(e)&&!o.set(e,i)){return false}if(u)u(o,t,i);o.trigger("sync",o,t,i)};R(this,i);s=this.isNew()?"create":i.patch?"patch":"update";if(s==="patch")i.attrs=r;n=this.sync(s,this,i);if(r&&i.wait)this.attributes=a;return n},destroy:function(t){t=t?h.clone(t):{};var e=this;var i=t.success;var r=function(){e.trigger("destroy",e,e.collection,t)};t.success=function(s){if(t.wait||e.isNew())r();if(i)i(e,s,t);if(!e.isNew())e.trigger("sync",e,s,t)};if(this.isNew()){t.success();return false}R(this,t);var s=this.sync("delete",this,t);if(!t.wait)r();return s},url:function(){var t=h.result(this,"urlRoot")||h.result(this.collection,"url")||U();if(this.isNew())return t;return t+(t.charAt(t.length-1)==="/"?"":"/")+encodeURIComponent(this.id)},parse:function(t,e){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},isValid:function(t){return this._validate({},h.extend(t||{},{validate:true}))},_validate:function(t,e){if(!e.validate||!this.validate)return true;t=h.extend({},this.attributes,t);var i=this.validationError=this.validate(t,e)||null;if(!i)return true;this.trigger("invalid",this,i,h.extend(e||{},{validationError:i}));return false}});var v=["keys","values","pairs","invert","pick","omit"];h.each(v,function(t){d.prototype[t]=function(){var e=s.call(arguments);e.unshift(this.attributes);return h[t].apply(h,e)}});var g=a.Collection=function(t,e){e||(e={});if(e.url)this.url=e.url;if(e.model)this.model=e.model;if(e.comparator!==void 0)this.comparator=e.comparator;this._reset();this.initialize.apply(this,arguments);if(t)this.reset(t,h.extend({silent:true},e))};var m={add:true,remove:true,merge:true};var y={add:true,merge:false,remove:false};h.extend(g.prototype,o,{model:d,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return a.sync.apply(this,arguments)},add:function(t,e){return this.set(t,h.defaults(e||{},y))},remove:function(t,e){t=h.isArray(t)?t.slice():[t];e||(e={});var i,r,s,n;for(i=0,r=t.length;i<r;i++){n=this.get(t[i]);if(!n)continue;delete this._byId[n.id];delete this._byId[n.cid];s=this.indexOf(n);this.models.splice(s,1);this.length--;if(!e.silent){e.index=s;n.trigger("remove",n,this,e)}this._removeReference(n)}return this},set:function(t,e){e=h.defaults(e||{},m);if(e.parse)t=this.parse(t,e);if(!h.isArray(t))t=t?[t]:[];var i,s,a,o,u,l;var c=e.at;var f=this.comparator&&c==null&&e.sort!==false;var d=h.isString(this.comparator)?this.comparator:null;var p=[],v=[],g={};for(i=0,s=t.length;i<s;i++){if(!(a=this._prepareModel(t[i],e)))continue;
if(u=this.get(a)){if(e.remove)g[u.cid]=true;if(e.merge){u.set(a.attributes,e);if(f&&!l&&u.hasChanged(d))l=true}}else if(e.add){p.push(a);a.on("all",this._onModelEvent,this);this._byId[a.cid]=a;if(a.id!=null)this._byId[a.id]=a}}if(e.remove){for(i=0,s=this.length;i<s;++i){if(!g[(a=this.models[i]).cid])v.push(a)}if(v.length)this.remove(v,e)}if(p.length){if(f)l=true;this.length+=p.length;if(c!=null){n.apply(this.models,[c,0].concat(p))}else{r.apply(this.models,p)}}if(l)this.sort({silent:true});if(e.silent)return this;for(i=0,s=p.length;i<s;i++){(a=p[i]).trigger("add",a,this,e)}if(l)this.trigger("sort",this,e);return this},reset:function(t,e){e||(e={});for(var i=0,r=this.models.length;i<r;i++){this._removeReference(this.models[i])}e.previousModels=this.models;this._reset();this.add(t,h.extend({silent:true},e));if(!e.silent)this.trigger("reset",this,e);return this},push:function(t,e){t=this._prepareModel(t,e);this.add(t,h.extend({at:this.length},e));return t},pop:function(t){var e=this.at(this.length-1);this.remove(e,t);return e},unshift:function(t,e){t=this._prepareModel(t,e);this.add(t,h.extend({at:0},e));return t},shift:function(t){var e=this.at(0);this.remove(e,t);return e},slice:function(t,e){return this.models.slice(t,e)},get:function(t){if(t==null)return void 0;return this._byId[t.id!=null?t.id:t.cid||t]},at:function(t){return this.models[t]},where:function(t,e){if(h.isEmpty(t))return e?void 0:[];return this[e?"find":"filter"](function(e){for(var i in t){if(t[i]!==e.get(i))return false}return true})},findWhere:function(t){return this.where(t,true)},sort:function(t){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");t||(t={});if(h.isString(this.comparator)||this.comparator.length===1){this.models=this.sortBy(this.comparator,this)}else{this.models.sort(h.bind(this.comparator,this))}if(!t.silent)this.trigger("sort",this,t);return this},sortedIndex:function(t,e,i){e||(e=this.comparator);var r=h.isFunction(e)?e:function(t){return t.get(e)};return h.sortedIndex(this.models,t,r,i)},pluck:function(t){return h.invoke(this.models,"get",t)},fetch:function(t){t=t?h.clone(t):{};if(t.parse===void 0)t.parse=true;var e=t.success;var i=this;t.success=function(r){var s=t.reset?"reset":"set";i[s](r,t);if(e)e(i,r,t);i.trigger("sync",i,r,t)};R(this,t);return this.sync("read",this,t)},create:function(t,e){e=e?h.clone(e):{};if(!(t=this._prepareModel(t,e)))return false;if(!e.wait)this.add(t,e);var i=this;var r=e.success;e.success=function(s){if(e.wait)i.add(t,e);if(r)r(t,s,e)};t.save(null,e);return t},parse:function(t,e){return t},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0;this.models=[];this._byId={}},_prepareModel:function(t,e){if(t instanceof d){if(!t.collection)t.collection=this;return t}e||(e={});e.collection=this;var i=new this.model(t,e);if(!i._validate(t,e)){this.trigger("invalid",this,t,e);return false}return i},_removeReference:function(t){if(this===t.collection)delete t.collection;t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,i,r){if((t==="add"||t==="remove")&&i!==this)return;if(t==="destroy")this.remove(e,r);if(e&&t==="change:"+e.idAttribute){delete this._byId[e.previous(e.idAttribute)];if(e.id!=null)this._byId[e.id]=e}this.trigger.apply(this,arguments)}});var _=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];h.each(_,function(t){g.prototype[t]=function(){var e=s.call(arguments);e.unshift(this.models);return h[t].apply(h,e)}});var w=["groupBy","countBy","sortBy"];h.each(w,function(t){g.prototype[t]=function(e,i){var r=h.isFunction(e)?e:function(t){return t.get(e)};return h[t](this.models,r,i)}});var b=a.View=function(t){this.cid=h.uniqueId("view");this._configure(t||{});this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()};var x=/^(\S+)\s*(.*)$/;var E=["model","collection","el","id","attributes","className","tagName","events"];h.extend(b.prototype,o,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();this.stopListening();return this},setElement:function(t,e){if(this.$el)this.undelegateEvents();this.$el=t instanceof a.$?t:a.$(t);this.el=this.$el[0];if(e!==false)this.delegateEvents();return this},delegateEvents:function(t){if(!(t||(t=h.result(this,"events"))))return this;this.undelegateEvents();for(var e in t){var i=t[e];if(!h.isFunction(i))i=this[t[e]];if(!i)continue;var r=e.match(x);var s=r[1],n=r[2];i=h.bind(i,this);s+=".delegateEvents"+this.cid;if(n===""){this.$el.on(s,i)}else{this.$el.on(s,n,i)}}return this},undelegateEvents:function(){this.$el.off(".delegateEvents"+this.cid);return this},_configure:function(t){if(this.options)t=h.extend({},h.result(this,"options"),t);h.extend(this,h.pick(t,E));this.options=t},_ensureElement:function(){if(!this.el){var t=h.extend({},h.result(this,"attributes"));if(this.id)t.id=h.result(this,"id");if(this.className)t["class"]=h.result(this,"className");var e=a.$("<"+h.result(this,"tagName")+">").attr(t);this.setElement(e,false)}else{this.setElement(h.result(this,"el"),false)}}});a.sync=function(t,e,i){var r=k[t];h.defaults(i||(i={}),{emulateHTTP:a.emulateHTTP,emulateJSON:a.emulateJSON});var s={type:r,dataType:"json"};if(!i.url){s.url=h.result(e,"url")||U()}if(i.data==null&&e&&(t==="create"||t==="update"||t==="patch")){s.contentType="application/json";s.data=JSON.stringify(i.attrs||e.toJSON(i))}if(i.emulateJSON){s.contentType="application/x-www-form-urlencoded";s.data=s.data?{model:s.data}:{}}if(i.emulateHTTP&&(r==="PUT"||r==="DELETE"||r==="PATCH")){s.type="POST";if(i.emulateJSON)s.data._method=r;var n=i.beforeSend;i.beforeSend=function(t){t.setRequestHeader("X-HTTP-Method-Override",r);if(n)return n.apply(this,arguments)}}if(s.type!=="GET"&&!i.emulateJSON){s.processData=false}if(s.type==="PATCH"&&window.ActiveXObject&&!(window.external&&window.external.msActiveXFilteringEnabled)){s.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")}}var o=i.xhr=a.ajax(h.extend(s,i));e.trigger("request",e,o,i);return o};var k={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};a.ajax=function(){return a.$.ajax.apply(a.$,arguments)};var S=a.Router=function(t){t||(t={});if(t.routes)this.routes=t.routes;this._bindRoutes();this.initialize.apply(this,arguments)};var $=/\((.*?)\)/g;var T=/(\(\?)?:\w+/g;var H=/\*\w+/g;var A=/[\-{}\[\]+?.,\\\^$|#\s]/g;h.extend(S.prototype,o,{initialize:function(){},route:function(t,e,i){if(!h.isRegExp(t))t=this._routeToRegExp(t);if(h.isFunction(e)){i=e;e=""}if(!i)i=this[e];var r=this;a.history.route(t,function(s){var n=r._extractParameters(t,s);i&&i.apply(r,n);r.trigger.apply(r,["route:"+e].concat(n));r.trigger("route",e,n);a.history.trigger("route",r,e,n)});return this},navigate:function(t,e){a.history.navigate(t,e);return this},_bindRoutes:function(){if(!this.routes)return;this.routes=h.result(this,"routes");var t,e=h.keys(this.routes);while((t=e.pop())!=null){this.route(t,this.routes[t])}},_routeToRegExp:function(t){t=t.replace(A,"\\$&").replace($,"(?:$1)?").replace(T,function(t,e){return e?t:"([^/]+)"}).replace(H,"(.*?)");return new RegExp("^"+t+"$")},_extractParameters:function(t,e){var i=t.exec(e).slice(1);return h.map(i,function(t){return t?decodeURIComponent(t):null})}});var I=a.History=function(){this.handlers=[];h.bindAll(this,"checkUrl");if(typeof window!=="undefined"){this.location=window.location;this.history=window.history}};var N=/^[#\/]|\s+$/g;var P=/^\/+|\/+$/g;var O=/msie [\w.]+/;var C=/\/$/;I.started=false;h.extend(I.prototype,o,{interval:50,getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t,e){if(t==null){if(this._hasPushState||!this._wantsHashChange||e){t=this.location.pathname;var i=this.root.replace(C,"");if(!t.indexOf(i))t=t.substr(i.length)}else{t=this.getHash()}}return t.replace(N,"")},start:function(t){if(I.started)throw new Error("Backbone.history has already been started");I.started=true;this.options=h.extend({},{root:"/"},this.options,t);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var e=this.getFragment();var i=document.documentMode;var r=O.exec(navigator.userAgent.toLowerCase())&&(!i||i<=7);this.root=("/"+this.root+"/").replace(P,"/");if(r&&this._wantsHashChange){this.iframe=a.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow;this.navigate(e)}if(this._hasPushState){a.$(window).on("popstate",this.checkUrl)}else if(this._wantsHashChange&&"onhashchange"in window&&!r){a.$(window).on("hashchange",this.checkUrl)}else if(this._wantsHashChange){this._checkUrlInterval=setInterval(this.checkUrl,this.interval)}this.fragment=e;var s=this.location;var n=s.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!n){this.fragment=this.getFragment(null,true);this.location.replace(this.root+this.location.search+"#"+this.fragment);return true}else if(this._wantsPushState&&this._hasPushState&&n&&s.hash){this.fragment=this.getHash().replace(N,"");this.history.replaceState({},document.title,this.root+this.fragment+s.search)}if(!this.options.silent)return this.loadUrl()},stop:function(){a.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl);clearInterval(this._checkUrlInterval);I.started=false},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(t){var e=this.getFragment();if(e===this.fragment&&this.iframe){e=this.getFragment(this.getHash(this.iframe))}if(e===this.fragment)return false;if(this.iframe)this.navigate(e);this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(t){var e=this.fragment=this.getFragment(t);var i=h.any(this.handlers,function(t){if(t.route.test(e)){t.callback(e);return true}});return i},navigate:function(t,e){if(!I.started)return false;if(!e||e===true)e={trigger:e};t=this.getFragment(t||"");if(this.fragment===t)return;this.fragment=t;var i=this.root+t;if(this._hasPushState){this.history[e.replace?"replaceState":"pushState"]({},document.title,i)}else if(this._wantsHashChange){this._updateHash(this.location,t,e.replace);if(this.iframe&&t!==this.getFragment(this.getHash(this.iframe))){if(!e.replace)this.iframe.document.open().close();this._updateHash(this.iframe.location,t,e.replace)}}else{return this.location.assign(i)}if(e.trigger)this.loadUrl(t)},_updateHash:function(t,e,i){if(i){var r=t.href.replace(/(javascript:|#).*$/,"");t.replace(r+"#"+e)}else{t.hash="#"+e}}});a.history=new I;var j=function(t,e){var i=this;var r;if(t&&h.has(t,"constructor")){r=t.constructor}else{r=function(){return i.apply(this,arguments)}}h.extend(r,i,e);var s=function(){this.constructor=r};s.prototype=i.prototype;r.prototype=new s;if(t)h.extend(r.prototype,t);r.__super__=i.prototype;return r};d.extend=g.extend=S.extend=b.extend=I.extend=j;var U=function(){throw new Error('A "url" property or function must be specified')};var R=function(t,e){var i=e.error;e.error=function(r){if(i)i(t,r,e);t.trigger("error",t,r,e)}}}.call(this);var Mustache;!function(exports){if(typeof module!=="undefined"){module.exports=exports}else if(typeof define==="function"){define(exports)}else{Mustache=exports}}(function(){var exports={};exports.name="mustache.js";exports.version="0.5.1-dev";exports.tags=["{{","}}"];exports.parse=parse;exports.clearCache=clearCache;exports.compile=compile;exports.compilePartial=compilePartial;exports.render=render;exports.Scanner=Scanner;exports.Context=Context;exports.Renderer=Renderer;exports.to_html=function(template,view,partials,send){var result=render(template,view,partials);if(typeof send==="function"){send(result)}else{return result}};var whiteRe=/\s*/;var spaceRe=/\s+/;var nonSpaceRe=/\S/;var eqRe=/\s*=/;var curlyRe=/\s*\}/;var tagRe=/#|\^|\/|>|\{|&|=|!/;function testRe(re,string){return RegExp.prototype.test.call(re,string)}function isWhitespace(string){return!testRe(nonSpaceRe,string)}var isArray=Array.isArray||function(obj){return Object.prototype.toString.call(obj)==="[object Array]"};var jsCharsRe=/[\x00-\x2F\x3A-\x40\x5B-\x60\x7B-\xFF\u2028\u2029]/gm;function quote(text){var escaped=text.replace(jsCharsRe,function(c){return"\\u"+("0000"+c.charCodeAt(0).toString(16)).slice(-4)});return'"'+escaped+'"'}function escapeRe(string){return string.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function escapeHtml(string){return String(string).replace(/[&<>"'\/]/g,function(s){return entityMap[s]})}exports.isWhitespace=isWhitespace;exports.isArray=isArray;exports.quote=quote;exports.escapeRe=escapeRe;exports.escapeHtml=escapeHtml;function Scanner(string){this.string=string;this.tail=string;this.pos=0}Scanner.prototype.eos=function(){return this.tail===""};Scanner.prototype.scan=function(re){var match=this.tail.match(re);if(match&&match.index===0){this.tail=this.tail.substring(match[0].length);this.pos+=match[0].length;return match[0]}return null};Scanner.prototype.scanUntil=function(re){var match,pos=this.tail.search(re);switch(pos){case-1:match=this.tail;this.pos+=this.tail.length;this.tail="";break;case 0:match=null;break;default:match=this.tail.substring(0,pos);this.tail=this.tail.substring(pos);this.pos+=pos}return match};function Context(view,parent){this.view=view;this.parent=parent;this.clearCache()}Context.make=function(view){return view instanceof Context?view:new Context(view)};Context.prototype.clearCache=function(){this._cache={}};Context.prototype.push=function(view){return new Context(view,this)};Context.prototype.lookup=function(name){var value=this._cache[name];if(!value){if(name==="."){value=this.view}else{var context=this;while(context){if(name.indexOf(".")>0){var names=name.split("."),i=0;value=context.view;while(value&&i<names.length){value=value[names[i++]]}}else{value=context.view[name]}if(value!=null){break}context=context.parent}}this._cache[name]=value}if(typeof value==="function"){value=value.call(this.view)}return value};function Renderer(){this.clearCache()}Renderer.prototype.clearCache=function(){this._cache={};this._partialCache={}};Renderer.prototype.compile=function(tokens,tags){if(typeof tokens==="string"){tokens=parse(tokens,tags)}var fn=compileTokens(tokens),self=this;return function(view){return fn(Context.make(view),self)}};Renderer.prototype.compilePartial=function(name,tokens,tags){this._partialCache[name]=this.compile(tokens,tags);return this._partialCache[name]};Renderer.prototype.render=function(template,view){var fn=this._cache[template];if(!fn){fn=this.compile(template);this._cache[template]=fn}return fn(view)};Renderer.prototype._section=function(name,context,callback){var value=context.lookup(name);switch(typeof value){case"object":if(isArray(value)){var buffer="";for(var i=0,len=value.length;i<len;++i){buffer+=callback(context.push(value[i]),this)}return buffer}return value?callback(context.push(value),this):"";case"function":var sectionText=callback(context,this),self=this;var scopedRender=function(template){return self.render(template,context)};return value.call(context.view,sectionText,scopedRender)||"";default:if(value){return callback(context,this)}}return""};Renderer.prototype._inverted=function(name,context,callback){var value=context.lookup(name);if(value==null||value===false||isArray(value)&&value.length===0){return callback(context,this)}return""};Renderer.prototype._partial=function(name,context){var fn=this._partialCache[name];if(fn){return fn(context,this)}return""};Renderer.prototype._name=function(name,context,escape){var value=context.lookup(name);if(typeof value==="function"){value=value.call(context.view)}var string=value==null?"":String(value);if(escape){return escapeHtml(string)}return string};function compileTokens(tokens,returnBody){var body=['""'];var token,method,escape;for(var i=0,len=tokens.length;i<len;++i){token=tokens[i];switch(token.type){case"#":case"^":method=token.type==="#"?"_section":"_inverted";body.push("r."+method+"("+quote(token.value)+", c, function (c, r) {\n"+"  "+compileTokens(token.tokens,true)+"\n"+"})");break;case"{":case"&":case"name":escape=token.type==="name"?"true":"false";body.push("r._name("+quote(token.value)+", c, "+escape+")");break;case">":body.push("r._partial("+quote(token.value)+", c)");break;case"text":body.push(quote(token.value));break}}body="return "+body.join(" + ")+";";if(returnBody){return body}return new Function("c, r",body)}function escapeTags(tags){if(tags.length===2){return[new RegExp(escapeRe(tags[0])+"\\s*"),new RegExp("\\s*"+escapeRe(tags[1]))]}throw new Error("Invalid tags: "+tags.join(" "))}function nestTokens(tokens){var tree=[];var collector=tree;var sections=[];var token,section;for(var i=0;i<tokens.length;++i){token=tokens[i];switch(token.type){case"#":case"^":token.tokens=[];sections.push(token);collector.push(token);collector=token.tokens;break;case"/":if(sections.length===0){throw new Error("Unopened section: "+token.value)}section=sections.pop();if(section.value!==token.value){throw new Error("Unclosed section: "+section.value)}if(sections.length>0){collector=sections[sections.length-1].tokens}else{collector=tree}break;default:collector.push(token)}}section=sections.pop();if(section){throw new Error("Unclosed section: "+section.value)}return tree}function squashTokens(tokens){var lastToken;for(var i=0;i<tokens.length;++i){var token=tokens[i];if(lastToken&&lastToken.type==="text"&&token.type==="text"){lastToken.value+=token.value;tokens.splice(i--,1)}else{lastToken=token}}}function parse(template,tags){tags=tags||exports.tags;var tagRes=escapeTags(tags);var scanner=new Scanner(template);var tokens=[],spaces=[],hasTag=false,nonSpace=false;var stripSpace=function(){if(hasTag&&!nonSpace){while(spaces.length){tokens.splice(spaces.pop(),1)}}else{spaces=[]}hasTag=false;nonSpace=false};var type,value,chr;while(!scanner.eos()){value=scanner.scanUntil(tagRes[0]);if(value){for(var i=0,len=value.length;i<len;++i){chr=value.charAt(i);if(isWhitespace(chr)){spaces.push(tokens.length)}else{nonSpace=true}tokens.push({type:"text",value:chr});if(chr==="\n"){stripSpace()}}}if(!scanner.scan(tagRes[0])){break}hasTag=true;type=scanner.scan(tagRe)||"name";scanner.scan(whiteRe);if(type==="="){value=scanner.scanUntil(eqRe);scanner.scan(eqRe);scanner.scanUntil(tagRes[1])}else if(type==="{"){var closeRe=new RegExp("\\s*"+escapeRe("}"+tags[1]));value=scanner.scanUntil(closeRe);scanner.scan(curlyRe);scanner.scanUntil(tagRes[1])}else{value=scanner.scanUntil(tagRes[1])}if(!scanner.scan(tagRes[1])){throw new Error("Unclosed tag at "+scanner.pos)}tokens.push({type:type,value:value});if(type==="name"||type==="{"||type==="&"){nonSpace=true}if(type==="="){tags=value.split(spaceRe);tagRes=escapeTags(tags)}}squashTokens(tokens);return nestTokens(tokens)}var _renderer=new Renderer;function clearCache(){_renderer.clearCache()}function compile(tokens,tags){return _renderer.compile(tokens,tags)}function compilePartial(name,tokens,tags){return _renderer.compilePartial(name,tokens,tags)}function render(template,view,partials){if(partials){for(var name in partials){compilePartial(name,partials[name])}}return _renderer.render(template,view)}return exports}());var Markdown;if(typeof exports==="object"&&typeof require==="function")Markdown=exports;else Markdown={};!function(){function identity(x){return x}function returnFalse(x){return false}function HookCollection(){}HookCollection.prototype={chain:function(hookname,func){var original=this[hookname];if(!original)throw new Error("unknown hook "+hookname);if(original===identity)this[hookname]=func;else this[hookname]=function(x){return func(original(x))}},set:function(hookname,func){if(!this[hookname])throw new Error("unknown hook "+hookname);this[hookname]=func},addNoop:function(hookname){this[hookname]=identity},addFalse:function(hookname){this[hookname]=returnFalse}};Markdown.HookCollection=HookCollection;function SaveHash(){}SaveHash.prototype={set:function(key,value){this["s_"+key]=value},get:function(key){return this["s_"+key]}};Markdown.Converter=function(){var pluginHooks=this.hooks=new HookCollection;pluginHooks.addNoop("plainLinkText");pluginHooks.addNoop("preConversion");pluginHooks.addNoop("postConversion");var g_urls;var g_titles;var g_html_blocks;var g_list_level;this.makeHtml=function(text){if(g_urls)throw new Error("Recursive call to converter.makeHtml");g_urls=new SaveHash;g_titles=new SaveHash;g_html_blocks=[];g_list_level=0;text=pluginHooks.preConversion(text);text=text.replace(/~/g,"~T");text=text.replace(/\$/g,"~D");text=text.replace(/\r\n/g,"\n");text=text.replace(/\r/g,"\n");text="\n\n"+text+"\n\n";text=_Detab(text);text=text.replace(/^[ \t]+$/gm,"");text=_HashHTMLBlocks(text);text=_StripLinkDefinitions(text);text=_RunBlockGamut(text);text=_UnescapeSpecialChars(text);text=text.replace(/~D/g,"$$");text=text.replace(/~T/g,"~");text=pluginHooks.postConversion(text);g_html_blocks=g_titles=g_urls=null;return text};function _StripLinkDefinitions(text){text=text.replace(/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?(?=\s|$)[ \t]*\n?[ \t]*((\n*)["(](.+?)[")][ \t]*)?(?:\n+)/gm,function(wholeMatch,m1,m2,m3,m4,m5){m1=m1.toLowerCase();g_urls.set(m1,_EncodeAmpsAndAngles(m2));if(m4){return m3}else if(m5){g_titles.set(m1,m5.replace(/"/g,"&quot;"))}return""});return text}function _HashHTMLBlocks(text){var block_tags_a="p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del";var block_tags_b="p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math";text=text.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))/gm,hashElement);text=text.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math)\b[^\r]*?.*<\/\2>[ \t]*(?=\n+)\n)/gm,hashElement);text=text.replace(/\n[ ]{0,3}((<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,hashElement);text=text.replace(/\n\n[ ]{0,3}(<!(--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>[ \t]*(?=\n{2,}))/g,hashElement);text=text.replace(/(?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,hashElement);return text}function hashElement(wholeMatch,m1){var blockText=m1;blockText=blockText.replace(/^\n+/,"");blockText=blockText.replace(/\n+$/g,"");blockText="\n\n~K"+(g_html_blocks.push(blockText)-1)+"K\n\n";return blockText}function _RunBlockGamut(text,doNotUnhash){text=_DoHeaders(text);var replacement="<hr />\n";text=text.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm,replacement);text=text.replace(/^[ ]{0,2}([ ]?-[ ]?){3,}[ \t]*$/gm,replacement);text=text.replace(/^[ ]{0,2}([ ]?_[ ]?){3,}[ \t]*$/gm,replacement);text=_DoLists(text);text=_DoCodeBlocks(text);text=_DoBlockQuotes(text);text=_HashHTMLBlocks(text);text=_FormParagraphs(text,doNotUnhash);return text}function _RunSpanGamut(text){text=_DoCodeSpans(text);text=_EscapeSpecialCharsWithinTagAttributes(text);text=_EncodeBackslashEscapes(text);text=_DoImages(text);text=_DoAnchors(text);text=_DoAutoLinks(text);text=text.replace(/~P/g,"://");text=_EncodeAmpsAndAngles(text);text=_DoItalicsAndBold(text);text=text.replace(/  +\n/g," <br>\n");return text}function _EscapeSpecialCharsWithinTagAttributes(text){var regex=/(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>)/gi;text=text.replace(regex,function(wholeMatch){var tag=wholeMatch.replace(/(.)<\/?code>(?=.)/g,"$1`");tag=escapeCharacters(tag,wholeMatch.charAt(1)=="!"?"\\`*_/":"\\`*_");return tag});return text}function _DoAnchors(text){text=text.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,writeAnchorTag);text=text.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?((?:\([^)]*\)|[^()\s])*?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,writeAnchorTag);text=text.replace(/(\[([^\[\]]+)\])()()()()()/g,writeAnchorTag);return text}function writeAnchorTag(wholeMatch,m1,m2,m3,m4,m5,m6,m7){if(m7==undefined)m7="";var whole_match=m1;var link_text=m2.replace(/:\/\//g,"~P");var link_id=m3.toLowerCase();var url=m4;var title=m7;if(url==""){if(link_id==""){link_id=link_text.toLowerCase().replace(/ ?\n/g," ")}url="#"+link_id;if(g_urls.get(link_id)!=undefined){url=g_urls.get(link_id);if(g_titles.get(link_id)!=undefined){title=g_titles.get(link_id)}}else{if(whole_match.search(/\(\s*\)$/m)>-1){url=""}else{return whole_match}}}url=encodeProblemUrlChars(url);url=escapeCharacters(url,"*_");var result='<a href="'+url+'"';if(title!=""){title=attributeEncode(title);title=escapeCharacters(title,"*_");result+=' title="'+title+'"'}result+=">"+link_text+"</a>";return result}function _DoImages(text){text=text.replace(/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,writeImageTag);text=text.replace(/(!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,writeImageTag);return text}function attributeEncode(text){return text.replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}function writeImageTag(wholeMatch,m1,m2,m3,m4,m5,m6,m7){var whole_match=m1;var alt_text=m2;var link_id=m3.toLowerCase();var url=m4;var title=m7;if(!title)title="";if(url==""){if(link_id==""){link_id=alt_text.toLowerCase().replace(/ ?\n/g," ")}url="#"+link_id;if(g_urls.get(link_id)!=undefined){url=g_urls.get(link_id);if(g_titles.get(link_id)!=undefined){title=g_titles.get(link_id)}}else{return whole_match}}alt_text=escapeCharacters(attributeEncode(alt_text),"*_[]()");url=escapeCharacters(url,"*_");var result='<img src="'+url+'" alt="'+alt_text+'"';title=attributeEncode(title);title=escapeCharacters(title,"*_");result+=' title="'+title+'"';result+=" />";return result}function _DoHeaders(text){text=text.replace(/^(.+)[ \t]*\n=+[ \t]*\n+/gm,function(wholeMatch,m1){return"<h1>"+_RunSpanGamut(m1)+"</h1>\n\n"});text=text.replace(/^(.+)[ \t]*\n-+[ \t]*\n+/gm,function(matchFound,m1){return"<h2>"+_RunSpanGamut(m1)+"</h2>\n\n"});text=text.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm,function(wholeMatch,m1,m2){var h_level=m1.length;return"<h"+h_level+">"+_RunSpanGamut(m2)+"</h"+h_level+">\n\n"});return text}function _DoLists(text){text+="~0";var whole_list=/^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm;if(g_list_level){text=text.replace(whole_list,function(wholeMatch,m1,m2){var list=m1;var list_type=m2.search(/[*+-]/g)>-1?"ul":"ol";var result=_ProcessListItems(list,list_type);result=result.replace(/\s+$/,"");result="<"+list_type+">"+result+"</"+list_type+">\n";return result})}else{whole_list=/(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g;text=text.replace(whole_list,function(wholeMatch,m1,m2,m3){var runup=m1;var list=m2;var list_type=m3.search(/[*+-]/g)>-1?"ul":"ol";var result=_ProcessListItems(list,list_type);result=runup+"<"+list_type+">\n"+result+"</"+list_type+">\n";return result})}text=text.replace(/~0/,"");return text}var _listItemMarkers={ol:"\\d+[.]",ul:"[*+-]"};function _ProcessListItems(list_str,list_type){g_list_level++;list_str=list_str.replace(/\n{2,}$/,"\n");list_str+="~0";var marker=_listItemMarkers[list_type];var re=new RegExp("(^[ \\t]*)("+marker+")[ \\t]+([^\\r]+?(\\n+))(?=(~0|\\1("+marker+")[ \\t]+))","gm");var last_item_had_a_double_newline=false;list_str=list_str.replace(re,function(wholeMatch,m1,m2,m3){var item=m3;var leading_space=m1;var ends_with_double_newline=/\n\n$/.test(item);var contains_double_newline=ends_with_double_newline||item.search(/\n{2,}/)>-1;if(contains_double_newline||last_item_had_a_double_newline){item=_RunBlockGamut(_Outdent(item),true)}else{item=_DoLists(_Outdent(item));item=item.replace(/\n$/,"");item=_RunSpanGamut(item)}last_item_had_a_double_newline=ends_with_double_newline;return"<li>"+item+"</li>\n"});list_str=list_str.replace(/~0/g,"");g_list_level--;return list_str}function _DoCodeBlocks(text){text+="~0";text=text.replace(/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g,function(wholeMatch,m1,m2){var codeblock=m1;var nextChar=m2;codeblock=_EncodeCode(_Outdent(codeblock));codeblock=_Detab(codeblock);codeblock=codeblock.replace(/^\n+/g,"");codeblock=codeblock.replace(/\n+$/g,"");codeblock="<pre><code>"+codeblock+"\n</code></pre>";return"\n\n"+codeblock+"\n\n"+nextChar});text=text.replace(/~0/,"");return text}function hashBlock(text){text=text.replace(/(^\n+|\n+$)/g,"");return"\n\n~K"+(g_html_blocks.push(text)-1)+"K\n\n"}function _DoCodeSpans(text){text=text.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,function(wholeMatch,m1,m2,m3,m4){var c=m3;c=c.replace(/^([ \t]*)/g,"");c=c.replace(/[ \t]*$/g,"");c=_EncodeCode(c);c=c.replace(/:\/\//g,"~P");return m1+"<code>"+c+"</code>"});return text}function _EncodeCode(text){text=text.replace(/&/g,"&amp;");text=text.replace(/</g,"&lt;");text=text.replace(/>/g,"&gt;");text=escapeCharacters(text,"*_{}[]\\",false);return text}function _DoItalicsAndBold(text){text=text.replace(/([\W_]|^)(\*\*|__)(?=\S)([^\r]*?\S[\*_]*)\2([\W_]|$)/g,"$1<strong>$3</strong>$4");text=text.replace(/([\W_]|^)(\*|_)(?=\S)([^\r\*_]*?\S)\2([\W_]|$)/g,"$1<em>$3</em>$4");return text}function _DoBlockQuotes(text){text=text.replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm,function(wholeMatch,m1){var bq=m1;bq=bq.replace(/^[ \t]*>[ \t]?/gm,"~0");bq=bq.replace(/~0/g,"");bq=bq.replace(/^[ \t]+$/gm,"");bq=_RunBlockGamut(bq);bq=bq.replace(/(^|\n)/g,"$1  ");bq=bq.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,function(wholeMatch,m1){var pre=m1;pre=pre.replace(/^  /gm,"~0");pre=pre.replace(/~0/g,"");return pre});return hashBlock("<blockquote>\n"+bq+"\n</blockquote>")});return text}function _FormParagraphs(text,doNotUnhash){text=text.replace(/^\n+/g,"");text=text.replace(/\n+$/g,"");var grafs=text.split(/\n{2,}/g);var grafsOut=[];var markerRe=/~K(\d+)K/;var end=grafs.length;for(var i=0;i<end;i++){var str=grafs[i];if(markerRe.test(str)){grafsOut.push(str)}else if(/\S/.test(str)){str=_RunSpanGamut(str);str=str.replace(/^([ \t]*)/g,"<p>");str+="</p>";grafsOut.push(str)}}if(!doNotUnhash){end=grafsOut.length;for(var i=0;i<end;i++){var foundAny=true;while(foundAny){foundAny=false;grafsOut[i]=grafsOut[i].replace(/~K(\d+)K/g,function(wholeMatch,id){foundAny=true;return g_html_blocks[id]})}}}return grafsOut.join("\n\n")}function _EncodeAmpsAndAngles(text){text=text.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;");text=text.replace(/<(?![a-z\/?\$!])/gi,"&lt;");return text}function _EncodeBackslashEscapes(text){text=text.replace(/\\(\\)/g,escapeCharacters_callback);text=text.replace(/\\([`*_{}\[\]()>#+-.!])/g,escapeCharacters_callback);return text}function _DoAutoLinks(text){text=text.replace(/(^|\s)(https?|ftp)(:\/\/[-A-Z0-9+&@#\/%?=~_|\[\]\(\)!:,\.;]*[-A-Z0-9+&@#\/%=~_|\[\]])($|\W)/gi,"$1<$2$3>$4");var replacer=function(wholematch,m1){return'<a href="'+m1+'">'+pluginHooks.plainLinkText(m1)+"</a>"};text=text.replace(/<((https?|ftp):[^'">\s]+)>/gi,replacer);return text}function _UnescapeSpecialChars(text){text=text.replace(/~E(\d+)E/g,function(wholeMatch,m1){var charCodeToReplace=parseInt(m1);return String.fromCharCode(charCodeToReplace)});return text}function _Outdent(text){text=text.replace(/^(\t|[ ]{1,4})/gm,"~0");text=text.replace(/~0/g,"");return text}function _Detab(text){if(!/\t/.test(text))return text;var spaces=["    ","   ","  "," "],skew=0,v;return text.replace(/[\n\t]/g,function(match,offset){if(match==="\n"){skew=offset+1;return match}v=(offset-skew)%4;skew=offset+1;return spaces[v]})}var _problemUrlChars=/(?:["'*()[\]:]|~D)/g;function encodeProblemUrlChars(url){if(!url)return"";var len=url.length;return url.replace(_problemUrlChars,function(match,offset){if(match=="~D")return"%24";
if(match==":"){if(offset==len-1||/[0-9\/]/.test(url.charAt(offset+1)))return":"}return"%"+match.charCodeAt(0).toString(16)})}function escapeCharacters(text,charsToEscape,afterBackslash){var regexString="(["+charsToEscape.replace(/([\[\]\\])/g,"\\$1")+"])";if(afterBackslash){regexString="\\\\"+regexString}var regex=new RegExp(regexString,"g");text=text.replace(regex,escapeCharacters_callback);return text}function escapeCharacters_callback(wholeMatch,m1){var charCodeToEscape=m1.charCodeAt(0);return"~E"+charCodeToEscape+"E"}}}();!function(){var output,Converter;if(typeof exports==="object"&&typeof require==="function"){output=exports;Converter=require("./Markdown.Converter").Converter}else{output=window.Markdown;Converter=output.Converter}output.getSanitizingConverter=function(){var converter=new Converter;converter.hooks.chain("postConversion",sanitizeHtml);converter.hooks.chain("postConversion",balanceTags);return converter};function sanitizeHtml(html){return html.replace(/<[^>]*>?/gi,sanitizeTag)}var basic_tag_whitelist=/^(<\/?(b|blockquote|code|del|dd|dl|dt|em|h1|h2|h3|i|kbd|li|ol|p|pre|s|sup|sub|strong|strike|ul)>|<(br|hr)\s?\/?>)$/i;var a_white=/^(<a\shref="((https?|ftp):\/\/|\/)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+"(\stitle="[^"<>]+")?\s?>|<\/a>)$/i;var img_white=/^(<img\ssrc="(https?:\/\/|\/)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+"(\swidth="\d{1,3}")?(\sheight="\d{1,3}")?(\salt="[^"<>]*")?(\stitle="[^"<>]*")?\s?\/?>)$/i;function sanitizeTag(tag){if(tag.match(basic_tag_whitelist)||tag.match(a_white)||tag.match(img_white))return tag;else return""}function balanceTags(html){if(html=="")return"";var re=/<\/?\w+[^>]*(\s|$|>)/g;var tags=html.toLowerCase().match(re);var tagcount=(tags||[]).length;if(tagcount==0)return html;var tagname,tag;var ignoredtags="<p><img><br><li><hr>";var match;var tagpaired=[];var tagremove=[];var needsRemoval=false;for(var ctag=0;ctag<tagcount;ctag++){tagname=tags[ctag].replace(/<\/?(\w+).*/,"$1");if(tagpaired[ctag]||ignoredtags.search("<"+tagname+">")>-1)continue;tag=tags[ctag];match=-1;if(!/^<\//.test(tag)){for(var ntag=ctag+1;ntag<tagcount;ntag++){if(!tagpaired[ntag]&&tags[ntag]=="</"+tagname+">"){match=ntag;break}}}if(match==-1)needsRemoval=tagremove[ctag]=true;else tagpaired[match]=true}if(!needsRemoval)return html;var ctag=0;html=html.replace(re,function(match){var res=tagremove[ctag]?"":match;ctag++;return res});return html}}();!function(){var util={},position={},ui={},doc=window.document,re=window.RegExp,nav=window.navigator,SETTINGS={lineLength:72},uaSniffed={isIE:/msie/.test(nav.userAgent.toLowerCase()),isIE_5or6:/msie 6/.test(nav.userAgent.toLowerCase())||/msie 5/.test(nav.userAgent.toLowerCase()),isOpera:/opera/.test(nav.userAgent.toLowerCase())};var linkDialogText="<p><b>"+gettext("Insert Hyperlink")+"</b></p><p>http://example.com/ "+gettext('"optional title"')+"</p>";var imageDialogText="<p><b>"+gettext("Insert Image (upload file or type url)")+"</b></p><p>http://example.com/images/diagram.jpg "+gettext('"optional title"')+"<br><br></p>";var imageDefaultText="http://";var linkDefaultText="http://";var defaultHelpHoverTitle=gettext("Markdown Editing Help");Markdown.Editor=function(markdownConverter,idPostfix,help,imageUploadHandler){idPostfix=idPostfix||"";var hooks=this.hooks=new Markdown.HookCollection;hooks.addNoop("onPreviewPush");hooks.addNoop("postBlockquoteCreation");hooks.addFalse("insertImageDialog");this.getConverter=function(){return markdownConverter};var that=this,panels;this.run=function(){if(panels)return;panels=new PanelCollection(idPostfix);var commandManager=new CommandManager(hooks);var previewManager=new PreviewManager(markdownConverter,panels,function(text,previewSet){hooks.onPreviewPush(text,previewSet)});var undoManager,uiManager;if(!/\?noundo/.test(doc.location.href)){undoManager=new UndoManager(function(){previewManager.refresh();if(uiManager)uiManager.setUndoRedoButtonStates()},panels);this.textOperation=function(f){undoManager.setCommandMode();f();that.refreshPreview()}}uiManager=new UIManager(idPostfix,panels,undoManager,previewManager,commandManager,help,imageUploadHandler);uiManager.setUndoRedoButtonStates();var forceRefresh=that.refreshPreview=function(){previewManager.refresh(true)};forceRefresh()}};function Chunks(){}Chunks.prototype.findTags=function(startRegex,endRegex){var chunkObj=this;var regex;if(startRegex){regex=util.extendRegExp(startRegex,"","$");this.before=this.before.replace(regex,function(match){chunkObj.startTag=chunkObj.startTag+match;return""});regex=util.extendRegExp(startRegex,"^","");this.selection=this.selection.replace(regex,function(match){chunkObj.startTag=chunkObj.startTag+match;return""})}if(endRegex){regex=util.extendRegExp(endRegex,"","$");this.selection=this.selection.replace(regex,function(match){chunkObj.endTag=match+chunkObj.endTag;return""});regex=util.extendRegExp(endRegex,"^","");this.after=this.after.replace(regex,function(match){chunkObj.endTag=match+chunkObj.endTag;return""})}};Chunks.prototype.trimWhitespace=function(remove){var beforeReplacer,afterReplacer,that=this;if(remove){beforeReplacer=afterReplacer=""}else{beforeReplacer=function(s){that.before+=s;return""};afterReplacer=function(s){that.after=s+that.after;return""}}this.selection=this.selection.replace(/^(\s*)/,beforeReplacer).replace(/(\s*)$/,afterReplacer)};Chunks.prototype.skipLines=function(nLinesBefore,nLinesAfter,findExtraNewlines){if(nLinesBefore===undefined){nLinesBefore=1}if(nLinesAfter===undefined){nLinesAfter=1}nLinesBefore++;nLinesAfter++;var regexText;var replacementText;if(navigator.userAgent.match(/Chrome/)){"X".match(/()./)}this.selection=this.selection.replace(/(^\n*)/,"");this.startTag=this.startTag+re.$1;this.selection=this.selection.replace(/(\n*$)/,"");this.endTag=this.endTag+re.$1;this.startTag=this.startTag.replace(/(^\n*)/,"");this.before=this.before+re.$1;this.endTag=this.endTag.replace(/(\n*$)/,"");this.after=this.after+re.$1;if(this.before){regexText=replacementText="";while(nLinesBefore--){regexText+="\\n?";replacementText+="\n"}if(findExtraNewlines){regexText="\\n*"}this.before=this.before.replace(new re(regexText+"$",""),replacementText)}if(this.after){regexText=replacementText="";while(nLinesAfter--){regexText+="\\n?";replacementText+="\n"}if(findExtraNewlines){regexText="\\n*"}this.after=this.after.replace(new re(regexText,""),replacementText)}};function PanelCollection(postfix){this.buttonBar=doc.getElementById("wmd-button-bar"+postfix);this.preview=doc.getElementById("wmd-preview"+postfix);this.input=doc.getElementById("wmd-input"+postfix)}util.isVisible=function(elem){if(window.getComputedStyle){return window.getComputedStyle(elem,null).getPropertyValue("display")!=="none"}else if(elem.currentStyle){return elem.currentStyle["display"]!=="none"}};util.addEvent=function(elem,event,listener){if(elem.attachEvent){elem.attachEvent("on"+event,listener)}else{elem.addEventListener(event,listener,false)}};util.removeEvent=function(elem,event,listener){if(elem.detachEvent){elem.detachEvent("on"+event,listener)}else{elem.removeEventListener(event,listener,false)}};util.fixEolChars=function(text){text=text.replace(/\r\n/g,"\n");text=text.replace(/\r/g,"\n");return text};util.extendRegExp=function(regex,pre,post){if(pre===null||pre===undefined){pre=""}if(post===null||post===undefined){post=""}var pattern=regex.toString();var flags;pattern=pattern.replace(/\/([gim]*)$/,function(wholeMatch,flagsPart){flags=flagsPart;return""});pattern=pattern.replace(/(^\/|\/$)/g,"");pattern=pre+pattern+post;return new re(pattern,flags)};position.getTop=function(elem,isInner){var result=elem.offsetTop;if(!isInner){while(elem=elem.offsetParent){result+=elem.offsetTop}}return result};position.getHeight=function(elem){return elem.offsetHeight||elem.scrollHeight};position.getWidth=function(elem){return elem.offsetWidth||elem.scrollWidth};position.getPageSize=function(){var scrollWidth,scrollHeight;var innerWidth,innerHeight;if(self.innerHeight&&self.scrollMaxY){scrollWidth=doc.body.scrollWidth;scrollHeight=self.innerHeight+self.scrollMaxY}else if(doc.body.scrollHeight>doc.body.offsetHeight){scrollWidth=doc.body.scrollWidth;scrollHeight=doc.body.scrollHeight}else{scrollWidth=doc.body.offsetWidth;scrollHeight=doc.body.offsetHeight}if(self.innerHeight){innerWidth=self.innerWidth;innerHeight=self.innerHeight}else if(doc.documentElement&&doc.documentElement.clientHeight){innerWidth=doc.documentElement.clientWidth;innerHeight=doc.documentElement.clientHeight}else if(doc.body){innerWidth=doc.body.clientWidth;innerHeight=doc.body.clientHeight}var maxWidth=Math.max(scrollWidth,innerWidth);var maxHeight=Math.max(scrollHeight,innerHeight);return[maxWidth,maxHeight,innerWidth,innerHeight]};function UndoManager(callback,panels){var undoObj=this;var undoStack=[];var stackPtr=0;var mode="none";var lastState;var timer;var inputStateObj;var setMode=function(newMode,noSave){if(mode!=newMode){mode=newMode;if(!noSave){saveState()}}if(!uaSniffed.isIE||mode!="moving"){timer=setTimeout(refreshState,1)}else{inputStateObj=null}};var refreshState=function(isInitialState){inputStateObj=new TextareaState(panels,isInitialState);timer=undefined};this.setCommandMode=function(){mode="command";saveState();timer=setTimeout(refreshState,0)};this.canUndo=function(){return stackPtr>1};this.canRedo=function(){if(undoStack[stackPtr+1]){return true}return false};this.undo=function(){if(undoObj.canUndo()){if(lastState){lastState.restore();lastState=null}else{undoStack[stackPtr]=new TextareaState(panels);undoStack[--stackPtr].restore();if(callback){callback()}}}mode="none";panels.input.focus();refreshState()};this.redo=function(){if(undoObj.canRedo()){undoStack[++stackPtr].restore();if(callback){callback()}}mode="none";panels.input.focus();refreshState()};var saveState=function(){var currState=inputStateObj||new TextareaState(panels);if(!currState){return false}if(mode=="moving"){if(!lastState){lastState=currState}return}if(lastState){if(undoStack[stackPtr-1].text!=lastState.text){undoStack[stackPtr++]=lastState}lastState=null}undoStack[stackPtr++]=currState;undoStack[stackPtr+1]=null;if(callback){callback()}};var handleCtrlYZ=function(event){var handled=false;if(event.ctrlKey||event.metaKey){var keyCode=event.charCode||event.keyCode;var keyCodeChar=String.fromCharCode(keyCode);switch(keyCodeChar){case"y":undoObj.redo();handled=true;break;case"z":if(!event.shiftKey){undoObj.undo()}else{undoObj.redo()}handled=true;break}}if(handled){if(event.preventDefault){event.preventDefault()}if(window.event){window.event.returnValue=false}return}};var handleModeChange=function(event){if(!event.ctrlKey&&!event.metaKey){var keyCode=event.keyCode;if(keyCode>=33&&keyCode<=40||keyCode>=63232&&keyCode<=63235){setMode("moving")}else if(keyCode==8||keyCode==46||keyCode==127){setMode("deleting")}else if(keyCode==13){setMode("newlines")}else if(keyCode==27){setMode("escape")}else if((keyCode<16||keyCode>20)&&keyCode!=91){setMode("typing")}}};var setEventHandlers=function(){util.addEvent(panels.input,"keypress",function(event){if((event.ctrlKey||event.metaKey)&&(event.keyCode==89||event.keyCode==90)){event.preventDefault()}});var handlePaste=function(){if(uaSniffed.isIE||inputStateObj&&inputStateObj.text!=panels.input.value){if(timer==undefined){mode="paste";saveState();refreshState()}}};util.addEvent(panels.input,"keydown",handleCtrlYZ);util.addEvent(panels.input,"keydown",handleModeChange);util.addEvent(panels.input,"mousedown",function(){setMode("moving")});panels.input.onpaste=handlePaste;panels.input.ondrop=handlePaste};var init=function(){setEventHandlers();refreshState(true);saveState()};init()}function TextareaState(panels,isInitialState){var stateObj=this;var inputArea=panels.input;this.init=function(){if(!util.isVisible(inputArea)){return}if(!isInitialState&&doc.activeElement&&doc.activeElement!==inputArea){return}this.setInputAreaSelectionStartEnd();this.scrollTop=inputArea.scrollTop;if(!this.text&&inputArea.selectionStart||inputArea.selectionStart===0){this.text=inputArea.value}};this.setInputAreaSelection=function(){if(!util.isVisible(inputArea)){return}if(inputArea.selectionStart!==undefined&&!uaSniffed.isOpera){inputArea.focus();inputArea.selectionStart=stateObj.start;inputArea.selectionEnd=stateObj.end;inputArea.scrollTop=stateObj.scrollTop}else if(doc.selection){if(doc.activeElement&&doc.activeElement!==inputArea){return}inputArea.focus();var range=inputArea.createTextRange();range.moveStart("character",-inputArea.value.length);range.moveEnd("character",-inputArea.value.length);range.moveEnd("character",stateObj.end);range.moveStart("character",stateObj.start);range.select()}};this.setInputAreaSelectionStartEnd=function(){if(!panels.ieCachedRange&&(inputArea.selectionStart||inputArea.selectionStart===0)){stateObj.start=inputArea.selectionStart;stateObj.end=inputArea.selectionEnd}else if(doc.selection){stateObj.text=util.fixEolChars(inputArea.value);var range=panels.ieCachedRange||doc.selection.createRange();var fixedRange=util.fixEolChars(range.text);var marker="";var markedRange=marker+fixedRange+marker;range.text=markedRange;var inputText=util.fixEolChars(inputArea.value);range.moveStart("character",-markedRange.length);range.text=fixedRange;stateObj.start=inputText.indexOf(marker);stateObj.end=inputText.lastIndexOf(marker)-marker.length;var len=stateObj.text.length-util.fixEolChars(inputArea.value).length;if(len){range.moveStart("character",-fixedRange.length);while(len--){fixedRange+="\n";stateObj.end+=1}range.text=fixedRange}if(panels.ieCachedRange)stateObj.scrollTop=panels.ieCachedScrollTop;panels.ieCachedRange=null;this.setInputAreaSelection()}};this.restore=function(){if(stateObj.text!=undefined&&stateObj.text!=inputArea.value){inputArea.value=stateObj.text}this.setInputAreaSelection();inputArea.scrollTop=stateObj.scrollTop};this.getChunks=function(){var chunk=new Chunks;chunk.before=util.fixEolChars(stateObj.text.substring(0,stateObj.start));chunk.startTag="";chunk.selection=util.fixEolChars(stateObj.text.substring(stateObj.start,stateObj.end));chunk.endTag="";chunk.after=util.fixEolChars(stateObj.text.substring(stateObj.end));chunk.scrollTop=stateObj.scrollTop;return chunk};this.setChunks=function(chunk){chunk.before=chunk.before+chunk.startTag;chunk.after=chunk.endTag+chunk.after;this.start=chunk.before.length;this.end=chunk.before.length+chunk.selection.length;this.text=chunk.before+chunk.selection+chunk.after;this.scrollTop=chunk.scrollTop};this.init()}function PreviewManager(converter,panels,previewPushCallback){var managerObj=this;var timeout;var elapsedTime;var oldInputText;var maxDelay=3e3;var startType="delayed";var setupEvents=function(inputElem,listener){util.addEvent(inputElem,"input",listener);inputElem.onpaste=listener;inputElem.ondrop=listener;util.addEvent(inputElem,"keypress",listener);util.addEvent(inputElem,"keydown",listener)};var getDocScrollTop=function(){var result=0;if(window.innerHeight){result=window.pageYOffset}else if(doc.documentElement&&doc.documentElement.scrollTop){result=doc.documentElement.scrollTop}else if(doc.body){result=doc.body.scrollTop}return result};var makePreviewHtml=function(){if(!panels.preview)return;var text=panels.input.value;if(text&&text==oldInputText){return}else{oldInputText=text}var prevTime=(new Date).getTime();text=converter.makeHtml(text);var currTime=(new Date).getTime();elapsedTime=currTime-prevTime;pushPreviewHtml(text)};var applyTimeout=function(){if(timeout){clearTimeout(timeout);timeout=undefined}if(startType!=="manual"){var delay=0;if(startType==="delayed"){delay=elapsedTime}if(delay>maxDelay){delay=maxDelay}timeout=setTimeout(makePreviewHtml,delay)}};var getScaleFactor=function(panel){if(panel.scrollHeight<=panel.clientHeight){return 1}return panel.scrollTop/(panel.scrollHeight-panel.clientHeight)};var setPanelScrollTops=function(){if(panels.preview){panels.preview.scrollTop=(panels.preview.scrollHeight-panels.preview.clientHeight)*getScaleFactor(panels.preview)}};this.refresh=function(requiresRefresh){if(requiresRefresh){oldInputText="";makePreviewHtml()}else{applyTimeout()}};this.processingTime=function(){return elapsedTime};var isFirstTimeFilled=true;var ieSafePreviewSet=function(text){var preview=panels.preview;var parent=preview.parentNode;var sibling=preview.nextSibling;parent.removeChild(preview);preview.innerHTML=text;if(!sibling)parent.appendChild(preview);else parent.insertBefore(preview,sibling)};var nonSuckyBrowserPreviewSet=function(text){panels.preview.innerHTML=text};var previewSetter;var previewSet=function(text){if(previewSetter)return previewSetter(text);try{nonSuckyBrowserPreviewSet(text);previewSetter=nonSuckyBrowserPreviewSet}catch(e){previewSetter=ieSafePreviewSet;previewSetter(text)}};var pushPreviewHtml=function(text){var emptyTop=position.getTop(panels.input)-getDocScrollTop();if(panels.preview){previewPushCallback(text,previewSet)}setPanelScrollTops();if(isFirstTimeFilled){isFirstTimeFilled=false;return}var fullTop=position.getTop(panels.input)-getDocScrollTop();if(uaSniffed.isIE){setTimeout(function(){window.scrollBy(0,fullTop-emptyTop)},0)}else{window.scrollBy(0,fullTop-emptyTop)}};var init=function(){setupEvents(panels.input,applyTimeout);makePreviewHtml();if(panels.preview){panels.preview.scrollTop=0}};init()}ui.createBackground=function(){var background=doc.createElement("div"),style=background.style;background.className="wmd-prompt-background";style.position="absolute";style.top="0";style.zIndex="1000";if(uaSniffed.isIE){style.filter="alpha(opacity=50)"}else{style.opacity="0.5"}var pageSize=position.getPageSize();style.height=pageSize[1]+"px";if(uaSniffed.isIE){style.left=doc.documentElement.scrollLeft;style.width=doc.documentElement.clientWidth}else{style.left="0";style.width="100%"}doc.body.appendChild(background);return background};ui.prompt=function(text,defaultInputText,callback,imageUploadHandler){var dialog;var input;if(defaultInputText===undefined){defaultInputText=""}var checkEscape=function(key){var code=key.charCode||key.keyCode;if(code===27){close(true)}};var close=function(isCancel){util.removeEvent(doc.body,"keydown",checkEscape);var text=input.value;if(isCancel){text=null}else{text=text.replace(/^http:\/\/(https?|ftp):\/\//,"$1://");if(!/^(?:https?|ftp):\/\//.test(text)&&text.charAt(0)!="/"){text="http://"+text}}dialog.parentNode.removeChild(dialog);callback(text);return false};var createDialog=function(){dialog=doc.createElement("div");dialog.setAttribute("role","dialog");dialog.className="wmd-prompt-dialog";dialog.style.padding="10px;";dialog.style.position="fixed";dialog.style.width="400px";dialog.style.zIndex="1001";var question=doc.createElement("div");question.innerHTML=text;question.style.padding="5px";dialog.appendChild(question);var form=doc.createElement("form"),style=form.style;form.onsubmit=function(){return close(false)};style.padding="0";style.margin="0";style.cssFloat="left";style.width="100%";style.textAlign="center";style.position="relative";dialog.appendChild(form);input=doc.createElement("input");input.type="text";input.value=defaultInputText;style=input.style;style.display="block";style.width="80%";style.marginLeft=style.marginRight="auto";form.appendChild(input);if(imageUploadHandler){var chooseFile=doc.createElement("input");chooseFile.type="file";chooseFile.name="file-upload";chooseFile.id="file-upload";chooseFile.onchange=function(){imageUploadHandler(this,input)};form.appendChild(doc.createElement("br"));form.appendChild(chooseFile)}var okButton=doc.createElement("input");okButton.type="button";okButton.onclick=function(){return close(false)};okButton.value="OK";style=okButton.style;style.margin="10px";style.display="inline";style.width="7em";var cancelButton=doc.createElement("input");cancelButton.type="button";cancelButton.onclick=function(){return close(true)};cancelButton.value="Cancel";style=cancelButton.style;style.margin="10px";style.display="inline";style.width="7em";form.appendChild(okButton);form.appendChild(cancelButton);util.addEvent(doc.body,"keydown",checkEscape);dialog.style.top="50%";dialog.style.left="50%";dialog.style.display="block";if(uaSniffed.isIE_5or6){dialog.style.position="absolute";dialog.style.top=doc.documentElement.scrollTop+200+"px";dialog.style.left="50%"}doc.body.appendChild(dialog);dialog.style.marginTop=-(position.getHeight(dialog)/2)+"px";dialog.style.marginLeft=-(position.getWidth(dialog)/2)+"px"};setTimeout(function(){createDialog();var defTextLen=defaultInputText.length;if(input.selectionStart!==undefined){input.selectionStart=0;input.selectionEnd=defTextLen}else if(input.createTextRange){var range=input.createTextRange();range.collapse(false);range.moveStart("character",-defTextLen);range.moveEnd("character",defTextLen);range.select()}input.focus()},0)};function UIManager(postfix,panels,undoManager,previewManager,commandManager,helpOptions,imageUploadHandler){var inputBox=panels.input,buttons={};makeSpritedButtonRow();var keyEvent="keydown";if(uaSniffed.isOpera){keyEvent="keypress"}util.addEvent(inputBox,keyEvent,function(key){if((key.ctrlKey||key.metaKey)&&!key.altKey&&!key.shiftKey){var keyCode=key.charCode||key.keyCode;var keyCodeStr=String.fromCharCode(keyCode).toLowerCase();switch(keyCodeStr){case"b":doClick(buttons.bold);break;case"i":doClick(buttons.italic);break;case"l":doClick(buttons.link);break;case"q":doClick(buttons.quote);break;case"k":doClick(buttons.code);break;case"g":doClick(buttons.image);break;case"o":doClick(buttons.olist);break;case"u":doClick(buttons.ulist);break;case"h":doClick(buttons.heading);break;case"r":doClick(buttons.hr);break;case"y":doClick(buttons.redo);break;case"z":if(key.shiftKey){doClick(buttons.redo)}else{doClick(buttons.undo)}break;default:return}if(key.preventDefault){key.preventDefault()}if(window.event){window.event.returnValue=false}}});util.addEvent(inputBox,"keyup",function(key){if(key.shiftKey&&!key.ctrlKey&&!key.metaKey){var keyCode=key.charCode||key.keyCode;if(keyCode===13){var fakeButton={};fakeButton.textOp=bindCommand("doAutoindent");doClick(fakeButton)}}});if(uaSniffed.isIE){util.addEvent(inputBox,"keydown",function(key){var code=key.keyCode;if(code===27){return false}})}function doClick(button){inputBox.focus();if(button.textOp){if(undoManager){undoManager.setCommandMode()}var state=new TextareaState(panels);if(!state){return}var chunks=state.getChunks();var fixupInputArea=function(){inputBox.focus();if(chunks){state.setChunks(chunks)}state.restore();previewManager.refresh()};var noCleanup=button.textOp(chunks,fixupInputArea);if(!noCleanup){fixupInputArea()}}if(button.execute){button.execute(undoManager)}}function setupButton(button,isEnabled){var normalYShift="0px";var disabledYShift="-20px";var highlightYShift="-40px";var image=button.getElementsByTagName("span")[0];if(isEnabled){image.style.backgroundPosition=button.XShift+" "+normalYShift;button.onmouseover=function(){image.style.backgroundPosition=this.XShift+" "+highlightYShift};button.onmouseout=function(){image.style.backgroundPosition=this.XShift+" "+normalYShift};if(uaSniffed.isIE){button.onmousedown=function(){if(doc.activeElement&&doc.activeElement!==panels.input){return}panels.ieCachedRange=document.selection.createRange();panels.ieCachedScrollTop=panels.input.scrollTop}}if(!button.isHelp){button.onclick=function(){if(this.onmouseout){this.onmouseout()}doClick(this);return false};util.addEvent(button,"keydown",function(event){var keyCode=event.charCode||event.keyCode;if(keyCode==32||keyCode==13){if(event.preventDefault){event.preventDefault()}if(window.event){window.event.returnValue=false}doClick(button)}})}}else{image.style.backgroundPosition=button.XShift+" "+disabledYShift;button.onmouseover=button.onmouseout=button.onclick=function(){}}}function bindCommand(method){if(typeof method==="string")method=commandManager[method];return function(){method.apply(commandManager,arguments)}}function makeSpritedButtonRow(){var buttonBar=panels.buttonBar;var normalYShift="0px";var disabledYShift="-20px";var highlightYShift="-40px";var buttonRow=document.createElement("div");buttonRow.setAttribute("role","toolbar");buttonRow.id="wmd-button-row"+postfix;buttonRow.className="wmd-button-row";buttonRow=buttonBar.appendChild(buttonRow);var xPosition=0;var makeButton=function(id,title,XShift,textOp){var button=document.createElement("span");button.setAttribute("role","button");button.tabIndex=0;button.className="wmd-button";button.style.left=xPosition+"px";xPosition+=25;var buttonImage=document.createElement("span");button.id=id+postfix;button.appendChild(buttonImage);button.title=title;button.XShift=XShift;if(textOp)button.textOp=textOp;setupButton(button,true);buttonRow.appendChild(button);return button};var makeSpacer=function(num){var spacer=document.createElement("span");spacer.setAttribute("role","separator");spacer.className="wmd-spacer wmd-spacer"+num;spacer.id="wmd-spacer"+num+postfix;buttonRow.appendChild(spacer);xPosition+=25};buttons.bold=makeButton("wmd-bold-button",gettext("Bold (Ctrl+B)"),"0px",bindCommand("doBold"));buttons.italic=makeButton("wmd-italic-button",gettext("Italic (Ctrl+I)"),"-20px",bindCommand("doItalic"));makeSpacer(1);buttons.link=makeButton("wmd-link-button",gettext("Hyperlink (Ctrl+L)"),"-40px",bindCommand(function(chunk,postProcessing){return this.doLinkOrImage(chunk,postProcessing,false)}));buttons.quote=makeButton("wmd-quote-button",gettext("Blockquote (Ctrl+Q)"),"-60px",bindCommand("doBlockquote"));buttons.code=makeButton("wmd-code-button",gettext("Code Sample (Ctrl+K)"),"-80px",bindCommand("doCode"));buttons.image=makeButton("wmd-image-button",gettext("Image (Ctrl+G)"),"-100px",bindCommand(function(chunk,postProcessing){return this.doLinkOrImage(chunk,postProcessing,true,imageUploadHandler)}));makeSpacer(2);buttons.olist=makeButton("wmd-olist-button",gettext("Numbered List (Ctrl+O)"),"-120px",bindCommand(function(chunk,postProcessing){this.doList(chunk,postProcessing,true)}));buttons.ulist=makeButton("wmd-ulist-button",gettext("Bulleted List (Ctrl+U)"),"-140px",bindCommand(function(chunk,postProcessing){this.doList(chunk,postProcessing,false)}));buttons.heading=makeButton("wmd-heading-button",gettext("Heading (Ctrl+H)"),"-160px",bindCommand("doHeading"));buttons.hr=makeButton("wmd-hr-button",gettext("Horizontal Rule (Ctrl+R)"),"-180px",bindCommand("doHorizontalRule"));makeSpacer(3);buttons.undo=makeButton("wmd-undo-button",gettext("Undo (Ctrl+Z)"),"-200px",null);buttons.undo.execute=function(manager){if(manager)manager.undo()};var redoTitle=/win/.test(nav.platform.toLowerCase())?gettext("Redo (Ctrl+Y)"):gettext("Redo (Ctrl+Shift+Z)");buttons.redo=makeButton("wmd-redo-button",redoTitle,"-220px",null);buttons.redo.execute=function(manager){if(manager)manager.redo()};if(helpOptions){var helpButton=document.createElement("span");var helpButtonImage=document.createElement("span");helpButton.appendChild(helpButtonImage);helpButton.className="wmd-button wmd-help-button";helpButton.id="wmd-help-button"+postfix;helpButton.XShift="-240px";helpButton.isHelp=true;helpButton.style.right="0px";helpButton.title=helpOptions.title||defaultHelpHoverTitle;helpButton.onclick=helpOptions.handler;setupButton(helpButton,true);buttonRow.appendChild(helpButton);buttons.help=helpButton}setUndoRedoButtonStates()}function setUndoRedoButtonStates(){if(undoManager){setupButton(buttons.undo,undoManager.canUndo());setupButton(buttons.redo,undoManager.canRedo())}}this.setUndoRedoButtonStates=setUndoRedoButtonStates}function CommandManager(pluginHooks){this.hooks=pluginHooks}var commandProto=CommandManager.prototype;commandProto.prefixes="(?:\\s{4,}|\\s*>|\\s*-\\s+|\\s*\\d+\\.|=|\\+|-|_|\\*|#|\\s*\\[[^\n]]+\\]:)";commandProto.unwrap=function(chunk){var txt=new re("([^\\n])\\n(?!(\\n|"+this.prefixes+"))","g");chunk.selection=chunk.selection.replace(txt,"$1 $2")};commandProto.wrap=function(chunk,len){this.unwrap(chunk);var regex=new re("(.{1,"+len+"})( +|$\\n?)","gm"),that=this;chunk.selection=chunk.selection.replace(regex,function(line,marked){if(new re("^"+that.prefixes,"").test(line)){return line}return marked+"\n"});chunk.selection=chunk.selection.replace(/\s+$/,"")};commandProto.doBold=function(chunk,postProcessing){return this.doBorI(chunk,postProcessing,2,gettext("strong text"))};commandProto.doItalic=function(chunk,postProcessing){return this.doBorI(chunk,postProcessing,1,gettext("emphasized text"))};commandProto.doBorI=function(chunk,postProcessing,nStars,insertText){chunk.trimWhitespace();chunk.selection=chunk.selection.replace(/\n{2,}/g,"\n");var starsBefore=/(\**$)/.exec(chunk.before)[0];var starsAfter=/(^\**)/.exec(chunk.after)[0];var prevStars=Math.min(starsBefore.length,starsAfter.length);if(prevStars>=nStars&&(prevStars!=2||nStars!=1)){chunk.before=chunk.before.replace(re("[*]{"+nStars+"}$",""),"");chunk.after=chunk.after.replace(re("^[*]{"+nStars+"}",""),"")}else if(!chunk.selection&&starsAfter){chunk.after=chunk.after.replace(/^([*_]*)/,"");chunk.before=chunk.before.replace(/(\s?)$/,"");var whitespace=re.$1;chunk.before=chunk.before+starsAfter+whitespace}else{if(!chunk.selection&&!starsAfter){chunk.selection=insertText}var markup=nStars<=1?"*":"**";chunk.before=chunk.before+markup;chunk.after=markup+chunk.after}return};commandProto.stripLinkDefs=function(text,defsToAdd){text=text.replace(/^[ ]{0,3}\[(\d+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|$)/gm,function(totalMatch,id,link,newlines,title){defsToAdd[id]=totalMatch.replace(/\s*$/,"");if(newlines){defsToAdd[id]=totalMatch.replace(/["(](.+?)[")]$/,"");return newlines+title}return""});return text};commandProto.addLinkDef=function(chunk,linkDef){var refNumber=0;var defsToAdd={};chunk.before=this.stripLinkDefs(chunk.before,defsToAdd);chunk.selection=this.stripLinkDefs(chunk.selection,defsToAdd);chunk.after=this.stripLinkDefs(chunk.after,defsToAdd);var defs="";var regex=/(\[)((?:\[[^\]]*\]|[^\[\]])*)(\][ ]?(?:\n[ ]*)?\[)(\d+)(\])/g;var addDefNumber=function(def){refNumber++;def=def.replace(/^[ ]{0,3}\[(\d+)\]:/,"  ["+refNumber+"]:");defs+="\n"+def};var getLink=function(wholeMatch,before,inner,afterInner,id,end){inner=inner.replace(regex,getLink);if(defsToAdd[id]){addDefNumber(defsToAdd[id]);return before+inner+afterInner+refNumber+end}return wholeMatch};chunk.before=chunk.before.replace(regex,getLink);if(linkDef){addDefNumber(linkDef)}else{chunk.selection=chunk.selection.replace(regex,getLink)}var refOut=refNumber;chunk.after=chunk.after.replace(regex,getLink);if(chunk.after){chunk.after=chunk.after.replace(/\n*$/,"")}if(!chunk.after){chunk.selection=chunk.selection.replace(/\n*$/,"")}chunk.after+="\n\n"+defs;return refOut};function properlyEncoded(linkdef){return linkdef.replace(/^\s*(.*?)(?:\s+"(.+)")?\s*$/,function(wholematch,link,title){link=link.replace(/\?.*$/,function(querypart){return querypart.replace(/\+/g," ")});link=decodeURIComponent(link);link=encodeURI(link).replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29");link=link.replace(/\?.*$/,function(querypart){return querypart.replace(/\+/g,"%2b")});if(title){title=title.trim?title.trim():title.replace(/^\s*/,"").replace(/\s*$/,"");title=$.trim(title).replace(/"/g,"quot;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}return title?link+' "'+title+'"':link})}commandProto.doLinkOrImage=function(chunk,postProcessing,isImage,imageUploadHandler){chunk.trimWhitespace();chunk.findTags(/\s*!?\[/,/\][ ]?(?:\n[ ]*)?(\[.*?\])?/);var background;if(chunk.endTag.length>1&&chunk.startTag.length>0){chunk.startTag=chunk.startTag.replace(/!?\[/,"");chunk.endTag="";this.addLinkDef(chunk,null)}else{chunk.selection=chunk.startTag+chunk.selection+chunk.endTag;chunk.startTag=chunk.endTag="";if(/\n\n/.test(chunk.selection)){this.addLinkDef(chunk,null);return}var that=this;var linkEnteredCallback=function(link){background.parentNode.removeChild(background);if(link!==null){chunk.selection=(" "+chunk.selection).replace(/([^\\](?:\\\\)*)(?=[[\]])/g,"$1\\").substr(1);var linkDef=" [999]: "+properlyEncoded(link);
var num=that.addLinkDef(chunk,linkDef);chunk.startTag=isImage?"![":"[";chunk.endTag="]["+num+"]";if(!chunk.selection){if(isImage){chunk.selection=gettext("enter image description here")}else{chunk.selection=gettext("enter link description here")}}}postProcessing()};background=ui.createBackground();if(isImage){if(!this.hooks.insertImageDialog(linkEnteredCallback))ui.prompt(imageDialogText,imageDefaultText,linkEnteredCallback,imageUploadHandler)}else{ui.prompt(linkDialogText,linkDefaultText,linkEnteredCallback)}return true}};commandProto.doAutoindent=function(chunk,postProcessing){var commandMgr=this,fakeSelection=false;chunk.before=chunk.before.replace(/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]*\n$/,"\n\n");chunk.before=chunk.before.replace(/(\n|^)[ ]{0,3}>[ \t]*\n$/,"\n\n");chunk.before=chunk.before.replace(/(\n|^)[ \t]+\n$/,"\n\n");if(!chunk.selection&&!/^[ \t]*(?:\n|$)/.test(chunk.after)){chunk.after=chunk.after.replace(/^[^\n]*/,function(wholeMatch){chunk.selection=wholeMatch;return""});fakeSelection=true}if(/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]+.*\n$/.test(chunk.before)){if(commandMgr.doList){commandMgr.doList(chunk)}}if(/(\n|^)[ ]{0,3}>[ \t]+.*\n$/.test(chunk.before)){if(commandMgr.doBlockquote){commandMgr.doBlockquote(chunk)}}if(/(\n|^)(\t|[ ]{4,}).*\n$/.test(chunk.before)){if(commandMgr.doCode){commandMgr.doCode(chunk)}}if(fakeSelection){chunk.after=chunk.selection+chunk.after;chunk.selection=""}};commandProto.doBlockquote=function(chunk,postProcessing){chunk.selection=chunk.selection.replace(/^(\n*)([^\r]+?)(\n*)$/,function(totalMatch,newlinesBefore,text,newlinesAfter){chunk.before+=newlinesBefore;chunk.after=newlinesAfter+chunk.after;return text});chunk.before=chunk.before.replace(/(>[ \t]*)$/,function(totalMatch,blankLine){chunk.selection=blankLine+chunk.selection;return""});chunk.selection=chunk.selection.replace(/^(\s|>)+$/,"");chunk.selection=chunk.selection||gettext("Blockquote");var match="",leftOver="",line;if(chunk.before){var lines=chunk.before.replace(/\n$/,"").split("\n");var inChain=false;for(var i=0;i<lines.length;i++){var good=false;line=lines[i];inChain=inChain&&line.length>0;if(/^>/.test(line)){good=true;if(!inChain&&line.length>1)inChain=true}else if(/^[ \t]*$/.test(line)){good=true}else{good=inChain}if(good){match+=line+"\n"}else{leftOver+=match+line;match="\n"}}if(!/(^|\n)>/.test(match)){leftOver+=match;match=""}}chunk.startTag=match;chunk.before=leftOver;if(chunk.after){chunk.after=chunk.after.replace(/^\n?/,"\n")}chunk.after=chunk.after.replace(/^(((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*)/,function(totalMatch){chunk.endTag=totalMatch;return""});var replaceBlanksInTags=function(useBracket){var replacement=useBracket?"> ":"";if(chunk.startTag){chunk.startTag=chunk.startTag.replace(/\n((>|\s)*)\n$/,function(totalMatch,markdown){return"\n"+markdown.replace(/^[ ]{0,3}>?[ \t]*$/gm,replacement)+"\n"})}if(chunk.endTag){chunk.endTag=chunk.endTag.replace(/^\n((>|\s)*)\n/,function(totalMatch,markdown){return"\n"+markdown.replace(/^[ ]{0,3}>?[ \t]*$/gm,replacement)+"\n"})}};if(/^(?![ ]{0,3}>)/m.test(chunk.selection)){this.wrap(chunk,SETTINGS.lineLength-2);chunk.selection=chunk.selection.replace(/^/gm,"> ");replaceBlanksInTags(true);chunk.skipLines()}else{chunk.selection=chunk.selection.replace(/^[ ]{0,3}> ?/gm,"");this.unwrap(chunk);replaceBlanksInTags(false);if(!/^(\n|^)[ ]{0,3}>/.test(chunk.selection)&&chunk.startTag){chunk.startTag=chunk.startTag.replace(/\n{0,2}$/,"\n\n")}if(!/(\n|^)[ ]{0,3}>.*$/.test(chunk.selection)&&chunk.endTag){chunk.endTag=chunk.endTag.replace(/^\n{0,2}/,"\n\n")}}chunk.selection=this.hooks.postBlockquoteCreation(chunk.selection);if(!/\n/.test(chunk.selection)){chunk.selection=chunk.selection.replace(/^(> *)/,function(wholeMatch,blanks){chunk.startTag+=blanks;return""})}};commandProto.doCode=function(chunk,postProcessing){var hasTextBefore=/\S[ ]*$/.test(chunk.before);var hasTextAfter=/^[ ]*\S/.test(chunk.after);if(!hasTextAfter&&!hasTextBefore||/\n/.test(chunk.selection)){chunk.before=chunk.before.replace(/[ ]{4}$/,function(totalMatch){chunk.selection=totalMatch+chunk.selection;return""});var nLinesBack=1;var nLinesForward=1;if(/(\n|^)(\t|[ ]{4,}).*\n$/.test(chunk.before)){nLinesBack=0}if(/^\n(\t|[ ]{4,})/.test(chunk.after)){nLinesForward=0}chunk.skipLines(nLinesBack,nLinesForward);if(!chunk.selection){chunk.startTag="    ";chunk.selection=gettext("enter code here")}else{if(/^[ ]{0,3}\S/m.test(chunk.selection)){if(/\n/.test(chunk.selection))chunk.selection=chunk.selection.replace(/^/gm,"    ");else chunk.before+="    "}else{chunk.selection=chunk.selection.replace(/^[ ]{4}/gm,"")}}}else{chunk.trimWhitespace();chunk.findTags(/`/,/`/);if(!chunk.startTag&&!chunk.endTag){chunk.startTag=chunk.endTag="`";if(!chunk.selection){chunk.selection=gettext("enter code here")}}else if(chunk.endTag&&!chunk.startTag){chunk.before+=chunk.endTag;chunk.endTag=""}else{chunk.startTag=chunk.endTag=""}}};commandProto.doList=function(chunk,postProcessing,isNumberedList){var previousItemsRegex=/(\n|^)(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*$/;var nextItemsRegex=/^\n*(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*/;var bullet="-";var num=1;var getItemPrefix=function(){var prefix;if(isNumberedList){prefix=" "+num+". ";num++}else{prefix=" "+bullet+" "}return prefix};var getPrefixedItem=function(itemText){if(isNumberedList===undefined){isNumberedList=/^\s*\d/.test(itemText)}itemText=itemText.replace(/^[ ]{0,3}([*+-]|\d+[.])\s/gm,function(_){return getItemPrefix()});return itemText};chunk.findTags(/(\n|^)*[ ]{0,3}([*+-]|\d+[.])\s+/,null);if(chunk.before&&!/\n$/.test(chunk.before)&&!/^\n/.test(chunk.startTag)){chunk.before+=chunk.startTag;chunk.startTag=""}if(chunk.startTag){var hasDigits=/\d+[.]/.test(chunk.startTag);chunk.startTag="";chunk.selection=chunk.selection.replace(/\n[ ]{4}/g,"\n");this.unwrap(chunk);chunk.skipLines();if(hasDigits){chunk.after=chunk.after.replace(nextItemsRegex,getPrefixedItem)}if(isNumberedList==hasDigits){return}}var nLinesUp=1;chunk.before=chunk.before.replace(previousItemsRegex,function(itemText){if(/^\s*([*+-])/.test(itemText)){bullet=re.$1}nLinesUp=/[^\n]\n\n[^\n]/.test(itemText)?1:0;return getPrefixedItem(itemText)});if(!chunk.selection){chunk.selection=gettext("List item")}var prefix=getItemPrefix();var nLinesDown=1;chunk.after=chunk.after.replace(nextItemsRegex,function(itemText){nLinesDown=/[^\n]\n\n[^\n]/.test(itemText)?1:0;return getPrefixedItem(itemText)});chunk.trimWhitespace(true);chunk.skipLines(nLinesUp,nLinesDown,true);chunk.startTag=prefix;var spaces=prefix.replace(/./g," ");this.wrap(chunk,SETTINGS.lineLength-spaces.length);chunk.selection=chunk.selection.replace(/\n/g,"\n"+spaces)};commandProto.doHeading=function(chunk,postProcessing){chunk.selection=chunk.selection.replace(/\s+/g," ");chunk.selection=chunk.selection.replace(/(^\s+|\s+$)/g,"");if(!chunk.selection){chunk.startTag="## ";chunk.selection=gettext("Heading");chunk.endTag=" ##";return}var headerLevel=0;chunk.findTags(/#+[ ]*/,/[ ]*#+/);if(/#+/.test(chunk.startTag)){headerLevel=re.lastMatch.length}chunk.startTag=chunk.endTag="";chunk.findTags(null,/\s?(-+|=+)/);if(/=+/.test(chunk.endTag)){headerLevel=1}if(/-+/.test(chunk.endTag)){headerLevel=2}chunk.startTag=chunk.endTag="";chunk.skipLines(1,1);var headerLevelToCreate=headerLevel==0?2:headerLevel-1;if(headerLevelToCreate>0){var headerChar=headerLevelToCreate>=2?"-":"=";var len=chunk.selection.length;if(len>SETTINGS.lineLength){len=SETTINGS.lineLength}chunk.endTag="\n";while(len--){chunk.endTag+=headerChar}}};commandProto.doHorizontalRule=function(chunk,postProcessing){chunk.startTag="----------\n";chunk.selection="";chunk.skipLines(2,1,true)}}();!function(){var getTime;getTime=function(){return(new Date).getTime()};this.MathJaxDelayRenderer=function(){var bufferId,numBuffers;MathJaxDelayRenderer.prototype.maxDelay=3e3;MathJaxDelayRenderer.prototype.mathjaxRunning=false;MathJaxDelayRenderer.prototype.elapsedTime=0;MathJaxDelayRenderer.prototype.mathjaxDelay=0;MathJaxDelayRenderer.prototype.mathjaxTimeout=void 0;bufferId="mathjax_delay_buffer";numBuffers=0;function MathJaxDelayRenderer(params){params=params||{};this.maxDelay=params["maxDelay"]||this.maxDelay;this.bufferId=params["bufferId"]||bufferId+numBuffers;numBuffers+=1;this.$buffer=$("<div>").attr("id",this.bufferId).css("display","none").appendTo($("body"))}MathJaxDelayRenderer.prototype.render=function(params){var delay,elem,preprocessor,previewSetter,renderer,text,_this=this;elem=params["element"];previewSetter=params["previewSetter"];text=params["text"];if(text==null){text=$(elem).html()}preprocessor=params["preprocessor"];if(params["delay"]===false){if(preprocessor!=null){text=preprocessor(text)}$(elem).html(text);return MathJax.Hub.Queue(["Typeset",MathJax.Hub,$(elem).attr("id")])}else{if(this.mathjaxTimeout){window.clearTimeout(this.mathjaxTimeout);this.mathjaxTimeout=void 0}delay=Math.min(this.elapsedTime+this.mathjaxDelay,this.maxDelay);renderer=function(){var curTime,prevTime;if(_this.mathjaxRunning){return}prevTime=getTime();if(preprocessor!=null){text=preprocessor(text)}_this.$buffer.html(text);curTime=getTime();_this.elapsedTime=curTime-prevTime;if(MathJax){prevTime=getTime();_this.mathjaxRunning=true;return MathJax.Hub.Queue(["Typeset",MathJax.Hub,_this.$buffer.attr("id")],function(){_this.mathjaxRunning=false;curTime=getTime();_this.mathjaxDelay=curTime-prevTime;if(previewSetter){return previewSetter($(_this.$buffer).html())}else{return $(elem).html($(_this.$buffer).html())}})}else{return _this.mathjaxDelay=0}};return this.mathjaxTimeout=window.setTimeout(renderer,delay)}};return MathJaxDelayRenderer}()}.call(this);!function(){$(function(){var HUB,MathJaxProcessor;if(typeof MathJax==="undefined"||MathJax===null){return}HUB=MathJax.Hub;MathJaxProcessor=function(){var CODESPAN,MATHSPLIT;MATHSPLIT=/(\$\$?|\\(?:begin|end)\{[a-z]*\*?\}|\\[\\{}$]|[{}]|(?:\n\s*)+|@@\d+@@)/i;CODESPAN=/(^|[^\\])(`+)([^\n]*?[^`\n])\2(?!`)/gm;function MathJaxProcessor(inlineMark,displayMark){this.inlineMark=inlineMark||"$";this.displayMark=displayMark||"$$";this.math=null;this.blocks=null}MathJaxProcessor.prototype.processMath=function(start,last,preProcess){var block,i,_i,_ref;block=this.blocks.slice(start,last+1).join("").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");if(HUB.Browser.isMSIE){block=block.replace(/(%[^\n]*)\n/g,"$1<br/>\n")}for(i=_i=_ref=start+1;_ref<=last?_i<=last:_i>=last;i=_ref<=last?++_i:--_i){this.blocks[i]=""}this.blocks[start]="@@"+this.math.length+"@@";if(preProcess){block=preProcess(block)}return this.math.push(block)};MathJaxProcessor.prototype.removeMath=function(text){var block,braces,current,deTilde,end,hasCodeSpans,last,start,_i,_ref;text=text||"";this.math=[];start=end=last=null;braces=0;hasCodeSpans=/`/.test(text);if(hasCodeSpans){text=text.replace(/~/g,"~T").replace(CODESPAN,function($0){return $0.replace(/\$/g,"~D")});deTilde=function(text){return text.replace(/~([TD])/g,function($0,$1){return{T:"~",D:"$"}[$1]})}}else{deTilde=function(text){return text}}this.blocks=_split(text.replace(/\r\n?/g,"\n"),MATHSPLIT);for(current=_i=1,_ref=this.blocks.length;_i<_ref;current=_i+=2){block=this.blocks[current];if(block.charAt(0)==="@"){this.blocks[current]="@@"+this.math.length+"@@";this.math.push(block)}else if(start){if(block===end){if(braces){last=current}else{this.processMath(start,current,deTilde);start=end=last=null}}else if(block.match(/\n.*\n/)){if(last){current=last;this.processMath(start,current,deTilde)}start=end=last=null;braces=0}else if(block==="{"){++braces}else if(block==="}"&&braces){--braces}}else{if(block===this.inlineMark||block===this.displayMark){start=current;end=block;braces=0}else if(block.substr(1,5)==="begin"){start=current;end="\\end"+block.substr(6);braces=0}}}if(last){this.processMath(start,last,deTilde);start=end=last=null}return deTilde(this.blocks.join(""))};MathJaxProcessor.removeMathWrapper=function(_this){return function(text){return _this.removeMath(text)}};MathJaxProcessor.prototype.replaceMath=function(text){var _this=this;text=text.replace(/@@(\d+)@@/g,function($0,$1){return _this.math[$1]});this.math=null;return text};MathJaxProcessor.replaceMathWrapper=function(_this){return function(text){return _this.replaceMath(text)}};return MathJaxProcessor}();if(typeof Markdown!=="undefined"&&Markdown!==null){Markdown.getMathCompatibleConverter=function(postProcessor){var converter,processor;postProcessor||(postProcessor=function(text){return text});converter=Markdown.getSanitizingConverter();processor=new MathJaxProcessor;converter.hooks.chain("preConversion",MathJaxProcessor.removeMathWrapper(processor));converter.hooks.chain("postConversion",function(text){return postProcessor(MathJaxProcessor.replaceMathWrapper(processor)(text))});return converter};return Markdown.makeWmdEditor=function(elem,appended_id,imageUploadUrl,postProcessor){var $elem,$wmdPanel,$wmdPreviewContainer,ajaxFileUpload,converter,delayRenderer,editor,imageUploadHandler,initialText,wmdInputId,_append;$elem=$(elem);if(!$elem.length){console.log("warning: elem for makeWmdEditor doesn't exist");return}if(!$elem.find(".wmd-panel").length){initialText=$elem.html();$elem.empty();_append=appended_id||"";wmdInputId="wmd-input"+_append;$wmdPreviewContainer=$("<div>").addClass("wmd-preview-container").append($("<div>").addClass("wmd-preview-label").text(gettext("Preview"))).append($("<div>").attr("id","wmd-preview"+_append).addClass("wmd-panel wmd-preview"));$wmdPanel=$("<div>").addClass("wmd-panel").append($("<div>").attr("id","wmd-button-bar"+_append)).append($("<label>").addClass("sr").attr("for",wmdInputId).text(gettext("Post body"))).append($("<textarea>").addClass("wmd-input").attr("id",wmdInputId).html(initialText)).append($wmdPreviewContainer);$elem.append($wmdPanel)}converter=Markdown.getMathCompatibleConverter(postProcessor);ajaxFileUpload=function(imageUploadUrl,input,startUploadHandler){$("#loading").ajaxStart(function(){return $(this).show()}).ajaxComplete(function(){return $(this).hide()});$("#upload").ajaxStart(function(){return $(this).hide()}).ajaxComplete(function(){return $(this).show()});return $.ajaxFileUpload({url:imageUploadUrl,secureuri:false,fileElementId:"file-upload",dataType:"json",success:function(data,status){var error,fileURL;fileURL=data["result"]["file_url"];error=data["result"]["error"];if(error!==""){alert(error);if(startUploadHandler){$("#file-upload").unbind("change").change(startUploadHandler)}return console.log(error)}else{return $(input).attr("value",fileURL)}},error:function(data,status,e){alert(e);if(startUploadHandler){return $("#file-upload").unbind("change").change(startUploadHandler)}}})};imageUploadHandler=function(elem,input){return ajaxFileUpload(imageUploadUrl,input,imageUploadHandler)};editor=new Markdown.Editor(converter,appended_id,null,imageUploadHandler);delayRenderer=new MathJaxDelayRenderer;editor.hooks.chain("onPreviewPush",function(text,previewSet){return delayRenderer.render({text:text,previewSetter:previewSet})});editor.run();return editor}}})}.call(this);!function(){var __bind=function(fn,me){return function(){return fn.apply(me,arguments)}};this.TooltipManager=function(){function TooltipManager(){this.hideTooltip=__bind(this.hideTooltip,this);this.moveTooltip=__bind(this.moveTooltip,this);this.showTooltip=__bind(this.showTooltip,this);this.$body=$("body");this.$tooltip=$('<div class="tooltip"></div>');this.$body.delegate("[data-tooltip]",{mouseover:this.showTooltip,mousemove:this.moveTooltip,mouseout:this.hideTooltip,click:this.hideTooltip})}TooltipManager.prototype.showTooltip=function(e){var $target,tooltipCoords,tooltipText,_this=this;$target=$(e.target).closest("[data-tooltip]");tooltipText=$target.attr("data-tooltip");this.$tooltip.html(tooltipText);this.$body.append(this.$tooltip);tooltipCoords={x:e.pageX-this.$tooltip.outerWidth()/2,y:e.pageY-(this.$tooltip.outerHeight()+15)};this.$tooltip.css;({left:tooltipCoords.x,top:tooltipCoords.y});return this.tooltipTimer=setTimeout(function(){_this.$tooltip.show().css("opacity",1);return _this.tooltipTimer=setTimeout(function(){return _this.hideTooltip()},3e3)},500)};TooltipManager.prototype.moveTooltip=function(e){var tooltipCoords;tooltipCoords={x:e.pageX-this.$tooltip.outerWidth()/2,y:e.pageY-(this.$tooltip.outerHeight()+15)};return this.$tooltip.css({left:tooltipCoords.x,top:tooltipCoords.y})};TooltipManager.prototype.hideTooltip=function(e){this.$tooltip.hide().css("opacity",0);return clearTimeout(this.tooltipTimer)};return TooltipManager}();$(function(){return new TooltipManager})}.call(this);!function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionUser=function(_super){__extends(DiscussionUser,_super);function DiscussionUser(){_ref=DiscussionUser.__super__.constructor.apply(this,arguments);return _ref}DiscussionUser.prototype.following=function(thread){return _.include(this.get("subscribed_thread_ids"),thread.id)};DiscussionUser.prototype.voted=function(thread){return _.include(this.get("upvoted_ids"),thread.id)};DiscussionUser.prototype.vote=function(thread){this.get("upvoted_ids").push(thread.id);return thread.vote()};DiscussionUser.prototype.unvote=function(thread){this.set("upvoted_ids",_.without(this.get("upvoted_ids"),thread.id));return thread.unvote()};return DiscussionUser}(Backbone.Model)}}.call(this);!function(){var _ref,_ref1,_ref2,_ref3,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1},__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};if(typeof Backbone!=="undefined"&&Backbone!==null){this.Content=function(_super){__extends(Content,_super);function Content(){_ref=Content.__super__.constructor.apply(this,arguments);return _ref}Content.contents={};Content.contentInfos={};Content.prototype.template=function(){return DiscussionUtil.getTemplate("_content")};Content.prototype.actions={editable:".admin-edit",can_reply:".discussion-reply",can_delete:".admin-delete",can_openclose:".admin-openclose"};Content.prototype.urlMappers={};Content.prototype.urlFor=function(name){return this.urlMappers[name].apply(this)};Content.prototype.can=function(action){return(this.get("ability")||{})[action]};Content.prototype.canBeEndorsed=function(){return false};Content.prototype.updateInfo=function(info){if(info){this.set("ability",info.ability);this.set("voted",info.voted);return this.set("subscribed",info.subscribed)}};Content.prototype.addComment=function(comment,options){var comments_count,model,thread;options||(options={});if(!options.silent){thread=this.get("thread");comments_count=parseInt(thread.get("comments_count"));thread.set("comments_count",comments_count+1)}this.get("children").push(comment);model=new Comment($.extend({},comment,{thread:this.get("thread")}));this.get("comments").add(model);this.trigger("comment:add");return model};Content.prototype.removeComment=function(comment){var comments_count,thread;thread=this.get("thread");comments_count=parseInt(thread.get("comments_count"));thread.set("comments_count",comments_count-1-comment.getCommentsCount());return this.trigger("comment:remove")};Content.prototype.resetComments=function(children){var comment,_i,_len,_ref1,_results;this.set("children",[]);this.set("comments",new Comments);_ref1=children||[];_results=[];for(_i=0,_len=_ref1.length;_i<_len;_i++){comment=_ref1[_i];_results.push(this.addComment(comment,{silent:true}))}return _results};Content.prototype.initialize=function(){var userId;Content.addContent(this.id,this);userId=this.get("user_id");if(userId!=null){this.set("staff_authored",DiscussionUtil.isStaff(userId));this.set("community_ta_authored",DiscussionUtil.isTA(userId))}else{this.set("staff_authored",false);this.set("community_ta_authored",false)}if(Content.getInfo(this.id)){this.updateInfo(Content.getInfo(this.id))}this.set("user_url",DiscussionUtil.urlFor("user_profile",userId));return this.resetComments(this.get("children"))};Content.prototype.remove=function(){if(this.get("type")==="comment"){this.get("thread").removeComment(this);return this.get("thread").trigger("comment:remove",this)}else{return this.trigger("thread:remove",this)}};Content.addContent=function(id,content){return this.contents[id]=content};Content.getContent=function(id){return this.contents[id]};Content.getInfo=function(id){return this.contentInfos[id]};Content.loadContentInfos=function(infos){var id,info;for(id in infos){info=infos[id];if(this.getContent(id)){this.getContent(id).updateInfo(info)}}return $.extend(this.contentInfos,infos)};Content.prototype.pinThread=function(){var pinned;pinned=this.get("pinned");this.set("pinned",pinned);return this.trigger("change",this)};Content.prototype.unPinThread=function(){var pinned;pinned=this.get("pinned");this.set("pinned",pinned);return this.trigger("change",this)};Content.prototype.flagAbuse=function(){var temp_array;temp_array=this.get("abuse_flaggers");temp_array.push(window.user.get("id"));this.set("abuse_flaggers",temp_array);return this.trigger("change",this)};Content.prototype.unflagAbuse=function(){this.get("abuse_flaggers").pop(window.user.get("id"));return this.trigger("change",this)};Content.prototype.isFlagged=function(){var flaggers,user,_ref1;user=DiscussionUtil.getUser();flaggers=this.get("abuse_flaggers");return user&&((_ref1=user.id,__indexOf.call(flaggers,_ref1)>=0)||DiscussionUtil.isPrivilegedUser(user.id)&&flaggers.length>0)};Content.prototype.incrementVote=function(increment){var newVotes;newVotes=_.clone(this.get("votes"));newVotes.up_count=newVotes.up_count+increment;return this.set("votes",newVotes)};Content.prototype.vote=function(){return this.incrementVote(1)};Content.prototype.unvote=function(){return this.incrementVote(-1)};return Content}(Backbone.Model);this.Thread=function(_super){__extends(Thread,_super);function Thread(){_ref1=Thread.__super__.constructor.apply(this,arguments);return _ref1}Thread.prototype.urlMappers={retrieve:function(){return DiscussionUtil.urlFor("retrieve_single_thread",this.discussion.id,this.id)},reply:function(){return DiscussionUtil.urlFor("create_comment",this.id)},unvote:function(){return DiscussionUtil.urlFor("undo_vote_for_"+this.get("type"),this.id)},upvote:function(){return DiscussionUtil.urlFor("upvote_"+this.get("type"),this.id)},downvote:function(){return DiscussionUtil.urlFor("downvote_"+this.get("type"),this.id)},close:function(){return DiscussionUtil.urlFor("openclose_thread",this.id)},update:function(){return DiscussionUtil.urlFor("update_thread",this.id)},_delete:function(){return DiscussionUtil.urlFor("delete_thread",this.id)},follow:function(){return DiscussionUtil.urlFor("follow_thread",this.id)},unfollow:function(){return DiscussionUtil.urlFor("unfollow_thread",this.id)},flagAbuse:function(){return DiscussionUtil.urlFor("flagAbuse_"+this.get("type"),this.id)},unFlagAbuse:function(){return DiscussionUtil.urlFor("unFlagAbuse_"+this.get("type"),this.id)},pinThread:function(){return DiscussionUtil.urlFor("pin_thread",this.id)},unPinThread:function(){return DiscussionUtil.urlFor("un_pin_thread",this.id)}};Thread.prototype.initialize=function(){this.set("thread",this);return Thread.__super__.initialize.call(this)};Thread.prototype.comment=function(){return this.set("comments_count",parseInt(this.get("comments_count"))+1)};Thread.prototype.follow=function(){return this.set("subscribed",true)};Thread.prototype.unfollow=function(){return this.set("subscribed",false)};Thread.prototype.display_body=function(){if(this.has("highlighted_body")){return String(this.get("highlighted_body")).replace(/<highlight>/g,"<mark>").replace(/<\/highlight>/g,"</mark>")}else{return this.get("body")}};Thread.prototype.display_title=function(){if(this.has("highlighted_title")){return String(this.get("highlighted_title")).replace(/<highlight>/g,"<mark>").replace(/<\/highlight>/g,"</mark>")}else{return this.get("title")}};Thread.prototype.toJSON=function(){var json_attributes;json_attributes=_.clone(this.attributes);return _.extend(json_attributes,{title:this.display_title(),body:this.display_body()})};Thread.prototype.created_at_date=function(){return new Date(this.get("created_at"))};Thread.prototype.created_at_time=function(){return new Date(this.get("created_at")).getTime()};Thread.prototype.hasResponses=function(){return this.get("comments_count")>0};return Thread}(this.Content);this.Comment=function(_super){__extends(Comment,_super);function Comment(){this.canBeEndorsed=__bind(this.canBeEndorsed,this);_ref2=Comment.__super__.constructor.apply(this,arguments);return _ref2}Comment.prototype.urlMappers={reply:function(){return DiscussionUtil.urlFor("create_sub_comment",this.id)},unvote:function(){return DiscussionUtil.urlFor("undo_vote_for_"+this.get("type"),this.id)},upvote:function(){return DiscussionUtil.urlFor("upvote_"+this.get("type"),this.id)},downvote:function(){return DiscussionUtil.urlFor("downvote_"+this.get("type"),this.id)},endorse:function(){return DiscussionUtil.urlFor("endorse_comment",this.id)},update:function(){return DiscussionUtil.urlFor("update_comment",this.id)},_delete:function(){return DiscussionUtil.urlFor("delete_comment",this.id)},flagAbuse:function(){return DiscussionUtil.urlFor("flagAbuse_"+this.get("type"),this.id)},unFlagAbuse:function(){return DiscussionUtil.urlFor("unFlagAbuse_"+this.get("type"),this.id)}};Comment.prototype.getCommentsCount=function(){var count;count=0;this.get("comments").each(function(comment){return count+=comment.getCommentsCount()+1});return count};Comment.prototype.canBeEndorsed=function(){var user_id;user_id=window.user.get("id");return user_id&&(DiscussionUtil.isPrivilegedUser(user_id)||this.get("thread").get("thread_type")==="question"&&this.get("thread").get("user_id")===user_id)};return Comment}(this.Content);this.Comments=function(_super){__extends(Comments,_super);function Comments(){_ref3=Comments.__super__.constructor.apply(this,arguments);return _ref3}Comments.prototype.model=Comment;Comments.prototype.initialize=function(){var _this=this;return this.bind("add",function(item){return item.collection=_this})};Comments.prototype.find=function(id){return _.first(this.where({id:id}))};return Comments}(Backbone.Collection)}}.call(this);!function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.Discussion=function(_super){__extends(Discussion,_super);function Discussion(){_ref=Discussion.__super__.constructor.apply(this,arguments);return _ref}Discussion.prototype.model=Thread;Discussion.prototype.initialize=function(models,options){var _this=this;if(options==null){options={}}this.pages=options["pages"]||1;this.current_page=1;this.sort_preference=options["sort"];this.bind("add",function(item){return item.discussion=_this});this.setSortComparator(this.sort_preference);return this.on("thread:remove",function(thread){return _this.remove(thread)})};Discussion.prototype.find=function(id){return _.first(this.where({id:id}))};Discussion.prototype.hasMorePages=function(){return this.current_page<this.pages};Discussion.prototype.setSortComparator=function(sortBy){switch(sortBy){case"date":return this.comparator=this.sortByDateRecentFirst;case"votes":return this.comparator=this.sortByVotes;case"comments":return this.comparator=this.sortByComments}};Discussion.prototype.addThread=function(thread,options){var model;if(!this.find(thread.id)){options||(options={});model=new Thread(thread);this.add(model);return model}};Discussion.prototype.retrieveAnotherPage=function(mode,options,sort_options,error){var data,url,_this=this;if(options==null){options={}}if(sort_options==null){sort_options={}}if(error==null){error=null}data={page:this.current_page+1};if(_.contains(["unread","unanswered","flagged"],options.filter)){data[options.filter]=true}switch(mode){case"search":url=DiscussionUtil.urlFor("search");data["text"]=options.search_text;break;case"commentables":url=DiscussionUtil.urlFor("search");data["commentable_ids"]=options.commentable_ids;break;case"all":url=DiscussionUtil.urlFor("threads");break;case"followed":url=DiscussionUtil.urlFor("followed_threads",options.user_id)}if(options["group_id"]){data["group_id"]=options["group_id"]}data["sort_key"]=sort_options.sort_key||"date";data["sort_order"]=sort_options.sort_order||"desc";return DiscussionUtil.safeAjax({$elem:this.$el,url:url,data:data,dataType:"json",success:function(response,textStatus){var models,new_collection,new_threads;models=_this.models;new_threads=[function(){var _i,_len,_ref1,_results;_ref1=response.discussion_data;_results=[];for(_i=0,_len=_ref1.length;_i<_len;_i++){data=_ref1[_i];_results.push(new Thread(data))}return _results}()][0];new_collection=_.union(models,new_threads);Content.loadContentInfos(response.annotated_content_info);_this.pages=response.num_pages;_this.current_page=response.page;return _this.reset(new_collection)},error:error})};Discussion.prototype.sortByDate=function(thread){var today;if(thread.get("pinned")){today=new Date;return new Date(today.getTime()+24*60*60*1e3)}else{return thread.get("created_at")}};Discussion.prototype.sortByDateRecentFirst=function(thread){var today;if(thread.get("pinned")){today=new Date;return-new Date(today.getTime()+24*60*60*1e3)}else{return-new Date(thread.get("created_at")).getTime()}};Discussion.prototype.sortByVotes=function(thread1,thread2){var thread1_count,thread2_count;thread1_count=parseInt(thread1.get("votes")["up_count"]);thread2_count=parseInt(thread2.get("votes")["up_count"]);if(thread2_count!==thread1_count){return thread2_count-thread1_count}else{return thread2.created_at_time()-thread1.created_at_time()}};Discussion.prototype.sortByComments=function(thread1,thread2){var thread1_count,thread2_count;thread1_count=parseInt(thread1.get("comments_count"));thread2_count=parseInt(thread2.get("comments_count"));if(thread2_count!==thread1_count){return thread2_count-thread1_count}else{return thread2.created_at_time()-thread1.created_at_time()}};return Discussion}(Backbone.Collection)}}.call(this);!function(){var DiscussionApp,DiscussionProfileApp;if(typeof Backbone!=="undefined"&&Backbone!==null){DiscussionApp={start:function(elem){var content_info,course_settings,discussion,element,sort_preference,thread_pages,threads,user,user_info;DiscussionUtil.loadRolesFromContainer();element=$(elem);window.$$course_id=element.data("course-id");user_info=element.data("user-info");sort_preference=element.data("sort-preference");threads=element.data("threads");thread_pages=element.data("thread-pages");content_info=element.data("content-info");user=new DiscussionUser(user_info);DiscussionUtil.setUser(user);window.user=user;Content.loadContentInfos(content_info);discussion=new Discussion(threads,{pages:thread_pages,sort:sort_preference});course_settings=new DiscussionCourseSettings(element.data("course-settings"));new DiscussionRouter({discussion:discussion,course_settings:course_settings});return Backbone.history.start({pushState:true,root:"/courses/"+$$course_id+"/discussion/forum/"})}};DiscussionProfileApp={start:function(elem){var element,numPages,page,threads,user_info;DiscussionUtil.loadRoles({Moderator:[],Administrator:[],"Community TA":[]});
element=$(elem);window.$$course_id=element.data("course-id");threads=element.data("threads");user_info=element.data("user-info");window.user=new DiscussionUser(user_info);page=element.data("page");numPages=element.data("num-pages");return new DiscussionUserProfileView({el:element,collection:threads,page:page,numPages:numPages})}};$(function(){$("section.discussion").each(function(index,elem){return DiscussionApp.start(elem)});return $("section.discussion-user-threads").each(function(index,elem){return DiscussionProfileApp.start(elem)})})}}.call(this);!function(){this.DiscussionFilter=function(){function DiscussionFilter(){}DiscussionFilter.filterDrop=function(e){var $drop,$items,query;$drop=$(e.target).parents(".topic-menu-wrapper");query=$(e.target).val();$items=$drop.find(".topic-menu-item");if(query.length===0){$items.removeClass("hidden");return}$items.addClass("hidden");return $items.each(function(i){var path,pathText,pathTitles;path=$(this).parents(".topic-menu-item").andSelf();pathTitles=path.children(".topic-title").map(function(i,elem){return $(elem).text()}).get();pathText=pathTitles.join(" / ").toLowerCase();if(query.split(" ").every(function(term){return pathText.search(term.toLowerCase())!==-1})){$(this).removeClass("hidden");$(this).find(".topic-menu-item").removeClass("hidden");return $(this).parents(".topic-menu-item").removeClass("hidden")}})};return DiscussionFilter}()}.call(this);!function(){var _ref,_ref1,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionContentView=function(_super){__extends(DiscussionContentView,_super);function DiscussionContentView(){this.setWmdContent=__bind(this.setWmdContent,this);this.getWmdContent=__bind(this.getWmdContent,this);this.getWmdEditor=__bind(this.getWmdEditor,this);this.makeWmdEditor=__bind(this.makeWmdEditor,this);_ref=DiscussionContentView.__super__.constructor.apply(this,arguments);return _ref}DiscussionContentView.prototype.events={"click .discussion-flag-abuse":"toggleFlagAbuse","keydown .discussion-flag-abuse":function(event){return DiscussionUtil.activateOnSpace(event,this.toggleFlagAbuse)}};DiscussionContentView.prototype.attrRenderer={ability:function(ability){var action,selector,_ref1,_results;_ref1=this.abilityRenderer;_results=[];for(action in _ref1){selector=_ref1[action];if(!ability[action]){_results.push(selector.disable.apply(this))}else{_results.push(selector.enable.apply(this))}}return _results}};DiscussionContentView.prototype.abilityRenderer={editable:{enable:function(){return this.$(".action-edit").closest(".actions-item").removeClass("is-hidden")},disable:function(){return this.$(".action-edit").closest(".actions-item").addClass("is-hidden")}},can_delete:{enable:function(){return this.$(".action-delete").closest(".actions-item").removeClass("is-hidden")},disable:function(){return this.$(".action-delete").closest(".actions-item").addClass("is-hidden")}},can_openclose:{enable:function(){var _this=this;return _.each([".action-close",".action-pin"],function(selector){return _this.$(selector).closest(".actions-item").removeClass("is-hidden")})},disable:function(){var _this=this;return _.each([".action-close",".action-pin"],function(selector){return _this.$(selector).closest(".actions-item").addClass("is-hidden")})}}};DiscussionContentView.prototype.renderPartialAttrs=function(){var attr,value,_ref1,_results;_ref1=this.model.changedAttributes();_results=[];for(attr in _ref1){value=_ref1[attr];if(this.attrRenderer[attr]){_results.push(this.attrRenderer[attr].apply(this,[value]))}else{_results.push(void 0)}}return _results};DiscussionContentView.prototype.renderAttrs=function(){var attr,value,_ref1,_results;_ref1=this.model.attributes;_results=[];for(attr in _ref1){value=_ref1[attr];if(this.attrRenderer[attr]){_results.push(this.attrRenderer[attr].apply(this,[value]))}else{_results.push(void 0)}}return _results};DiscussionContentView.prototype.makeWmdEditor=function(cls_identifier){if(!this.$el.find(".wmd-panel").length){return DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),cls_identifier)}};DiscussionContentView.prototype.getWmdEditor=function(cls_identifier){return DiscussionUtil.getWmdEditor(this.$el,$.proxy(this.$,this),cls_identifier)};DiscussionContentView.prototype.getWmdContent=function(cls_identifier){return DiscussionUtil.getWmdContent(this.$el,$.proxy(this.$,this),cls_identifier)};DiscussionContentView.prototype.setWmdContent=function(cls_identifier,text){return DiscussionUtil.setWmdContent(this.$el,$.proxy(this.$,this),cls_identifier,text)};DiscussionContentView.prototype.initialize=function(){var _this=this;this.model.bind("change",this.renderPartialAttrs,this);return this.listenTo(this.model,"change:endorsed",function(){if(_this.model instanceof Comment){return _this.trigger("comment:endorse")}})};return DiscussionContentView}(Backbone.View);this.DiscussionContentShowView=function(_super){var _this=this;__extends(DiscussionContentShowView,_super);function DiscussionContentShowView(){this.toggleClose=__bind(this.toggleClose,this);this.toggleReport=__bind(this.toggleReport,this);this.togglePin=__bind(this.togglePin,this);this.toggleVote=__bind(this.toggleVote,this);this.toggleEndorse=__bind(this.toggleEndorse,this);this.toggleFollow=__bind(this.toggleFollow,this);this.handleSecondaryActionBlur=__bind(this.handleSecondaryActionBlur,this);this.handleSecondaryActionEscape=__bind(this.handleSecondaryActionEscape,this);this.toggleSecondaryActions=__bind(this.toggleSecondaryActions,this);this.updateButtonState=__bind(this.updateButtonState,this);_ref1=DiscussionContentShowView.__super__.constructor.apply(this,arguments);return _ref1}DiscussionContentShowView.prototype.events=_.reduce([[".action-follow","toggleFollow"],[".action-answer","toggleEndorse"],[".action-endorse","toggleEndorse"],[".action-vote","toggleVote"],[".action-more","toggleSecondaryActions"],[".action-pin","togglePin"],[".action-edit","edit"],[".action-delete","_delete"],[".action-report","toggleReport"],[".action-close","toggleClose"]],function(obj,event){var funcName,selector;selector=event[0];funcName=event[1];obj["click "+selector]=function(event){return this[funcName](event)};obj["keydown "+selector]=function(event){return DiscussionUtil.activateOnSpace(event,this[funcName])};return obj},{});DiscussionContentShowView.prototype.updateButtonState=function(selector,checked){var $button;$button=this.$(selector);$button.toggleClass("is-checked",checked);return $button.attr("aria-checked",checked)};DiscussionContentShowView.prototype.attrRenderer=$.extend({},DiscussionContentView.prototype.attrRenderer,{subscribed:function(subscribed){return this.updateButtonState(".action-follow",subscribed)},endorsed:function(endorsed){var $button,selector;selector=this.model.get("thread").get("thread_type")==="question"?".action-answer":".action-endorse";this.updateButtonState(selector,endorsed);$button=this.$(selector);$button.closest(".actions-item").toggleClass("is-hidden",!this.model.canBeEndorsed());return $button.toggleClass("is-checked",endorsed)},votes:function(votes){var button,numVotes,selector;selector=".action-vote";this.updateButtonState(selector,window.user.voted(this.model));button=this.$el.find(selector);numVotes=votes.up_count;button.find(".js-sr-vote-count").html(interpolate(ngettext("currently %(numVotes)s vote","currently %(numVotes)s votes",numVotes),{numVotes:numVotes},true));return button.find(".js-visual-vote-count").html(interpolate(ngettext("%(numVotes)s Vote","%(numVotes)s Votes",numVotes),{numVotes:numVotes},true))},pinned:function(pinned){this.updateButtonState(".action-pin",pinned);return this.$(".post-label-pinned").toggleClass("is-hidden",!pinned)},abuse_flaggers:function(abuse_flaggers){var flagged;flagged=this.model.isFlagged();this.updateButtonState(".action-report",flagged);return this.$(".post-label-reported").toggleClass("is-hidden",!flagged)},closed:function(closed){this.updateButtonState(".action-close",closed);return this.$(".post-label-closed").toggleClass("is-hidden",!closed)}});DiscussionContentShowView.prototype.toggleSecondaryActions=function(event){event.preventDefault();event.stopPropagation();this.secondaryActionsExpanded=!this.secondaryActionsExpanded;this.$(".action-more").toggleClass("is-expanded",this.secondaryActionsExpanded);this.$(".actions-dropdown").toggleClass("is-expanded",this.secondaryActionsExpanded).attr("aria-expanded",this.secondaryActionsExpanded);if(this.secondaryActionsExpanded){if(event.type==="keydown"){this.$(".action-list-item:first").focus()}$("body").on("click",this.toggleSecondaryActions);$("body").on("keydown",this.handleSecondaryActionEscape);return this.$(".action-list-item").on("blur",this.handleSecondaryActionBlur)}else{$("body").off("click",this.toggleSecondaryActions);$("body").off("keydown",this.handleSecondaryActionEscape);return this.$(".action-list-item").off("blur",this.handleSecondaryActionBlur)}};DiscussionContentShowView.prototype.handleSecondaryActionEscape=function(event){if(event.keyCode===27){this.toggleSecondaryActions(event);return this.$(".action-more").focus()}};DiscussionContentShowView.prototype.handleSecondaryActionBlur=function(event){var _this=this;return setTimeout(function(){if(_this.secondaryActionsExpanded&&_this.$(".actions-dropdown :focus").length===0){return _this.toggleSecondaryActions(event)}},10)};DiscussionContentShowView.prototype.toggleFollow=function(event){var is_subscribing,msg,url;event.preventDefault();is_subscribing=!this.model.get("subscribed");url=this.model.urlFor(is_subscribing?"follow":"unfollow");if(is_subscribing){msg=gettext("We had some trouble subscribing you to this thread. Please try again.")}else{msg=gettext("We had some trouble unsubscribing you from this thread. Please try again.")}return DiscussionUtil.updateWithUndo(this.model,{subscribed:is_subscribing},{url:url,type:"POST",$elem:$(event.currentTarget)},msg)};DiscussionContentShowView.prototype.toggleEndorse=function(event){var beforeFunc,is_endorsing,msg,updates,url,_this=this;event.preventDefault();is_endorsing=!this.model.get("endorsed");url=this.model.urlFor("endorse");updates={endorsed:is_endorsing,endorsement:is_endorsing?{username:DiscussionUtil.getUser().get("username"),time:(new Date).toISOString()}:null};if(this.model.get("thread").get("thread_type")==="question"){if(is_endorsing){msg=gettext("We had some trouble marking this response as an answer.  Please try again.")}else{msg=gettext("We had some trouble removing this response as an answer.  Please try again.")}}else{if(is_endorsing){msg=gettext("We had some trouble marking this response endorsed.  Please try again.")}else{msg=gettext("We had some trouble removing this endorsement.  Please try again.")}}beforeFunc=function(){return _this.trigger("comment:endorse")};return DiscussionUtil.updateWithUndo(this.model,updates,{url:url,type:"POST",data:{endorsed:is_endorsing},beforeSend:beforeFunc,$elem:$(event.currentTarget)},msg).always(this.trigger("comment:endorse"))};DiscussionContentShowView.prototype.toggleVote=function(event){var is_voting,updates,url,user,_this=this;event.preventDefault();user=DiscussionUtil.getUser();is_voting=!user.voted(this.model);url=this.model.urlFor(is_voting?"upvote":"unvote");updates={upvoted_ids:(is_voting?_.union:_.difference)(user.get("upvoted_ids"),[this.model.id])};return DiscussionUtil.updateWithUndo(user,updates,{url:url,type:"POST",$elem:$(event.currentTarget)},gettext("We had some trouble saving your vote.  Please try again.")).done(function(){if(is_voting){return _this.model.vote()}else{return _this.model.unvote()}})};DiscussionContentShowView.prototype.togglePin=function(event){var is_pinning,msg,url;event.preventDefault();is_pinning=!this.model.get("pinned");url=this.model.urlFor(is_pinning?"pinThread":"unPinThread");if(is_pinning){msg=gettext("We had some trouble pinning this thread. Please try again.")}else{msg=gettext("We had some trouble unpinning this thread. Please try again.")}return DiscussionUtil.updateWithUndo(this.model,{pinned:is_pinning},{url:url,type:"POST",$elem:$(event.currentTarget)},msg)};DiscussionContentShowView.prototype.toggleReport=function(event){var is_flagging,msg,updates,url;event.preventDefault();if(this.model.isFlagged()){is_flagging=false;msg=gettext("We had some trouble removing your flag on this post.  Please try again.")}else{is_flagging=true;msg=gettext("We had some trouble reporting this post.  Please try again.")}url=this.model.urlFor(is_flagging?"flagAbuse":"unFlagAbuse");updates={abuse_flaggers:(is_flagging?_.union:_.difference)(this.model.get("abuse_flaggers"),[DiscussionUtil.getUser().id])};return DiscussionUtil.updateWithUndo(this.model,updates,{url:url,type:"POST",$elem:$(event.currentTarget)},msg)};DiscussionContentShowView.prototype.toggleClose=function(event){var is_closing,msg,updates;event.preventDefault();is_closing=!this.model.get("closed");if(is_closing){msg=gettext("We had some trouble closing this thread.  Please try again.")}else{msg=gettext("We had some trouble reopening this thread.  Please try again.")}updates={closed:is_closing};return DiscussionUtil.updateWithUndo(this.model,updates,{url:this.model.urlFor("close"),type:"POST",data:updates,$elem:$(event.currentTarget)},msg)};DiscussionContentShowView.prototype.getAuthorDisplay=function(){return _.template($("#post-user-display-template").html())({username:this.model.get("username")||null,user_url:this.model.get("user_url"),is_community_ta:this.model.get("community_ta_authored"),is_staff:this.model.get("staff_authored")})};DiscussionContentShowView.prototype.getEndorserDisplay=function(){var endorsement;endorsement=this.model.get("endorsement");if(endorsement&&endorsement.username){return _.template($("#post-user-display-template").html())({username:endorsement.username,user_url:DiscussionUtil.urlFor("user_profile",endorsement.user_id),is_community_ta:DiscussionUtil.isTA(endorsement.user_id),is_staff:DiscussionUtil.isStaff(endorsement.user_id)})}else{return null}};return DiscussionContentShowView}.call(this,DiscussionContentView)}}.call(this);!function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.ResponseCommentView=function(_super){__extends(ResponseCommentView,_super);function ResponseCommentView(){this.update=__bind(this.update,this);this.edit=__bind(this.edit,this);this.cancelEdit=__bind(this.cancelEdit,this);this._delete=__bind(this._delete,this);_ref=ResponseCommentView.__super__.constructor.apply(this,arguments);return _ref}ResponseCommentView.prototype.tagName="li";ResponseCommentView.prototype.$=function(selector){return this.$el.find(selector)};ResponseCommentView.prototype.initialize=function(){return ResponseCommentView.__super__.initialize.call(this)};ResponseCommentView.prototype.render=function(){this.renderShowView();return this};ResponseCommentView.prototype.renderSubView=function(view){view.setElement(this.$el);view.render();return view.delegateEvents()};ResponseCommentView.prototype.renderShowView=function(){if(this.showView==null){if(this.editView!=null){this.editView.undelegateEvents();this.editView.$el.empty();this.editView=null}this.showView=new ResponseCommentShowView({model:this.model});this.showView.bind("comment:_delete",this._delete);this.showView.bind("comment:edit",this.edit);return this.renderSubView(this.showView)}};ResponseCommentView.prototype.renderEditView=function(){if(this.editView==null){if(this.showView!=null){this.showView.undelegateEvents();this.showView.$el.empty();this.showView=null}this.editView=new ResponseCommentEditView({model:this.model});this.editView.bind("comment:update",this.update);this.editView.bind("comment:cancel_edit",this.cancelEdit);return this.renderSubView(this.editView)}};ResponseCommentView.prototype._delete=function(event){var $elem,url,_this=this;event.preventDefault();if(!this.model.can("can_delete")){return}if(!confirm(gettext("Are you sure you want to delete this comment?"))){return}url=this.model.urlFor("_delete");$elem=$(event.target);return DiscussionUtil.safeAjax({$elem:$elem,url:url,type:"POST",success:function(response,textStatus){_this.model.remove();return _this.$el.remove()},error:function(){return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble deleting this comment. Please try again."))}})};ResponseCommentView.prototype.cancelEdit=function(event){this.trigger("comment:cancel_edit",event);return this.renderShowView()};ResponseCommentView.prototype.edit=function(event){this.trigger("comment:edit",event);return this.renderEditView()};ResponseCommentView.prototype.update=function(event){var newBody,url,_this=this;newBody=this.editView.$(".edit-comment-body textarea").val();url=DiscussionUtil.urlFor("update_comment",this.model.id);return DiscussionUtil.safeAjax({$elem:$(event.target),$loading:$(event.target),url:url,type:"POST",dataType:"json",data:{body:newBody},error:DiscussionUtil.formErrorHandler(this.$(".edit-comment-form-errors")),success:function(response,textStatus){_this.model.set("body",newBody);return _this.cancelEdit()}})};return ResponseCommentView}(DiscussionContentView)}}.call(this);!function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.ThreadResponseShowView=function(_super){__extends(ThreadResponseShowView,_super);function ThreadResponseShowView(){_ref=ThreadResponseShowView.__super__.constructor.apply(this,arguments);return _ref}ThreadResponseShowView.prototype.initialize=function(){ThreadResponseShowView.__super__.initialize.call(this);return this.listenTo(this.model,"change",this.render)};ThreadResponseShowView.prototype.renderTemplate=function(){var context;this.template=_.template($("#thread-response-show-template").html());context=_.extend({cid:this.model.cid,author_display:this.getAuthorDisplay(),endorser_display:this.getEndorserDisplay()},this.model.attributes);return this.template(context)};ThreadResponseShowView.prototype.render=function(){this.$el.html(this.renderTemplate());this.delegateEvents();this.renderAttrs();this.$el.find(".posted-details .timeago").timeago();this.convertMath();return this};ThreadResponseShowView.prototype.convertMath=function(){var element;element=this.$(".response-body");element.html(DiscussionUtil.postMathJaxProcessor(DiscussionUtil.markdownWithHighlight(element.text())));return MathJax.Hub.Queue(["Typeset",MathJax.Hub,element[0]])};ThreadResponseShowView.prototype.edit=function(event){return this.trigger("response:edit",event)};ThreadResponseShowView.prototype._delete=function(event){return this.trigger("response:_delete",event)};return ThreadResponseShowView}(DiscussionContentShowView)}}.call(this);!function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionUserProfileView=function(_super){__extends(DiscussionUserProfileView,_super);function DiscussionUserProfileView(){this.render=__bind(this.render,this);_ref=DiscussionUserProfileView.__super__.constructor.apply(this,arguments);return _ref}DiscussionUserProfileView.prototype.events={"click .discussion-paginator a":"changePage"};DiscussionUserProfileView.prototype.initialize=function(options){DiscussionUserProfileView.__super__.initialize.call(this);this.page=options.page;this.numPages=options.numPages;this.discussion=new Discussion;this.discussion.on("reset",this.render);return this.discussion.reset(this.collection,{silent:false})};DiscussionUserProfileView.prototype.render=function(){var baseUri,pageUrlFunc,paginationParams,paginationTemplate,profileTemplate;profileTemplate=$("script#_user_profile").html();this.$el.html(Mustache.render(profileTemplate,{threads:this.discussion.models}));this.discussion.map(function(thread){return new DiscussionThreadProfileView({el:this.$("article#thread_"+thread.id),model:thread}).render()});baseUri=URI(window.location).removeSearch("page");pageUrlFunc=function(page){return baseUri.clone().addSearch("page",page)};paginationParams=DiscussionUtil.getPaginationParams(this.page,this.numPages,pageUrlFunc);paginationTemplate=$("script#_pagination").html();return this.$el.find(".pagination").html(Mustache.render(paginationTemplate,paginationParams))};DiscussionUserProfileView.prototype.changePage=function(event){var url,_this=this;event.preventDefault();url=$(event.target).attr("href");return DiscussionUtil.safeAjax({$elem:this.$el,$loading:$(event.target),takeFocus:true,url:url,type:"GET",dataType:"json",success:function(response,textStatus,xhr){_this.page=response.page;_this.numPages=response.num_pages;_this.discussion.reset(response.discussion_data,{silent:false});return history.pushState({},"",url)},error:function(){return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading the page you requested. Please try again."))}})};return DiscussionUserProfileView}(Backbone.View)}}.call(this);!function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.NewPostInlineView=function(_super){__extends(NewPostInlineView,_super);function NewPostInlineView(){_ref=NewPostInlineView.__super__.constructor.apply(this,arguments);return _ref}NewPostInlineView.prototype.initialize=function(){this.topicId=this.$(".topic").first().data("discussion-id");this.maxNameWidth=100;return DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),"new-post-body")};NewPostInlineView.prototype.events={"submit .new-post-form":"createPost"};NewPostInlineView.prototype.ignoreClick=function(event){return event.stopPropagation()};NewPostInlineView.prototype.createPost=function(event){var anonymous,anonymous_to_peers,body,follow,group,title,url,_this=this;event.preventDefault();title=this.$(".new-post-title").val();body=this.$(".new-post-body").find(".wmd-input").val();group=this.$(".new-post-group option:selected").attr("value");anonymous=false||this.$("input.discussion-anonymous").is(":checked");anonymous_to_peers=false||this.$("input.discussion-anonymous-to-peers").is(":checked");follow=false||this.$("input.discussion-follow").is(":checked");url=DiscussionUtil.urlFor("create_thread",this.topicId);return DiscussionUtil.safeAjax({$elem:$(event.target),$loading:event?$(event.target):void 0,url:url,type:"POST",dataType:"json",async:true,data:{title:title,body:body,group_id:group,anonymous:anonymous,anonymous_to_peers:anonymous_to_peers,auto_subscribe:follow},error:DiscussionUtil.formErrorHandler(this.$(".new-post-form-errors")),success:function(response,textStatus){var thread;thread=new Thread(response["content"]);DiscussionUtil.clearFormErrors(_this.$(".new-post-form-errors"));_this.$el.hide();_this.$(".new-post-title").val("").attr("prev-text","");_this.$(".new-post-body textarea").val("").attr("prev-text","");return _this.collection.add(thread)}})};return NewPostInlineView}(Backbone.View)}}.call(this);!function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.ThreadResponseEditView=function(_super){__extends(ThreadResponseEditView,_super);function ThreadResponseEditView(){_ref=ThreadResponseEditView.__super__.constructor.apply(this,arguments);return _ref}ThreadResponseEditView.prototype.events={"click .post-update":"update","click .post-cancel":"cancel_edit"};ThreadResponseEditView.prototype.$=function(selector){return this.$el.find(selector)};ThreadResponseEditView.prototype.initialize=function(){return ThreadResponseEditView.__super__.initialize.call(this)};ThreadResponseEditView.prototype.render=function(){this.template=_.template($("#thread-response-edit-template").html());this.$el.html(this.template(this.model.toJSON()));this.delegateEvents();DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),"edit-post-body");return this};ThreadResponseEditView.prototype.update=function(event){return this.trigger("response:update",event)};ThreadResponseEditView.prototype.cancel_edit=function(event){return this.trigger("response:cancel_edit",event)};return ThreadResponseEditView}(Backbone.View)}}.call(this);!function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionThreadView=function(_super){var INITIAL_RESPONSE_PAGE_SIZE,SUBSEQUENT_RESPONSE_PAGE_SIZE;__extends(DiscussionThreadView,_super);function DiscussionThreadView(){this._delete=__bind(this._delete,this);this.cancelEdit=__bind(this.cancelEdit,this);this.update=__bind(this.update,this);this.edit=__bind(this.edit,this);this.endorseThread=__bind(this.endorseThread,this);this.addComment=__bind(this.addComment,this);this.renderAddResponseButton=__bind(this.renderAddResponseButton,this);this.renderResponseToList=__bind(this.renderResponseToList,this);this.renderResponseCountAndPagination=__bind(this.renderResponseCountAndPagination,this);_ref=DiscussionThreadView.__super__.constructor.apply(this,arguments);return _ref}INITIAL_RESPONSE_PAGE_SIZE=25;SUBSEQUENT_RESPONSE_PAGE_SIZE=100;DiscussionThreadView.prototype.events={"click .discussion-submit-post":"submitComment","click .add-response-btn":"scrollToAddResponse","click .forum-thread-expand":"expand","click .forum-thread-collapse":"collapse"};DiscussionThreadView.prototype.$=function(selector){return this.$el.find(selector)};DiscussionThreadView.prototype.isQuestion=function(){return this.model.get("thread_type")==="question"};DiscussionThreadView.prototype.initialize=function(options){var _ref1;DiscussionThreadView.__super__.initialize.call(this);this.mode=options.mode||"inline";if((_ref1=this.mode)!=="tab"&&_ref1!=="inline"){throw new Error("invalid mode: "+this.mode)}this.createShowView();this.responses=new Comments;this.loadedResponses=false;if(this.isQuestion()){return this.markedAnswers=new Comments}};DiscussionThreadView.prototype.renderTemplate=function(){this.template=_.template($("#thread-template").html());return this.template(this.model.toJSON())};DiscussionThreadView.prototype.render=function(){var _this=this;this.$el.html(this.renderTemplate());this.delegateEvents();this.renderShowView();this.renderAttrs();this.$("span.timeago").timeago();this.makeWmdEditor("reply-body");this.renderAddResponseButton();this.responses.on("add",function(response){return _this.renderResponseToList(response,".js-response-list",{})});if(this.isQuestion()){this.markedAnswers.on("add",function(response){return _this.renderResponseToList(response,".js-marked-answer-list",{collapseComments:true})})}if(this.mode==="tab"){setTimeout(function(){return _this.loadInitialResponses()},100);return this.$(".post-tools").hide()}else{return this.collapse()}};DiscussionThreadView.prototype.attrRenderer=$.extend({},DiscussionContentView.prototype.attrRenderer,{closed:function(closed){this.$(".discussion-reply-new").toggle(!closed);return this.renderAddResponseButton()}});DiscussionThreadView.prototype.expand=function(event){if(event){event.preventDefault()}this.$el.addClass("expanded");this.$el.find(".post-body").text(this.model.get("body"));this.showView.convertMath();this.$el.find(".forum-thread-expand").hide();this.$el.find(".forum-thread-collapse").show();this.$el.find(".post-extended-content").show();if(!this.loadedResponses){return this.loadInitialResponses()}};DiscussionThreadView.prototype.collapse=function(event){if(event){event.preventDefault()}this.$el.removeClass("expanded");this.$el.find(".post-body").text(this.getAbbreviatedBody());this.showView.convertMath();this.$el.find(".forum-thread-expand").show();this.$el.find(".forum-thread-collapse").hide();return this.$el.find(".post-extended-content").hide()};DiscussionThreadView.prototype.getAbbreviatedBody=function(){var abbreviated,cached;cached=this.model.get("abbreviatedBody");if(cached){return cached}else{abbreviated=DiscussionUtil.abbreviateString(this.model.get("body"),140);this.model.set("abbreviatedBody",abbreviated);return abbreviated}};DiscussionThreadView.prototype.cleanup=function(){if(this.responsesRequest!=null){return this.responsesRequest.abort()}};DiscussionThreadView.prototype.loadResponses=function(responseLimit,elem,firstLoad){var _this=this;return this.responsesRequest=DiscussionUtil.safeAjax({url:DiscussionUtil.urlFor("retrieve_single_thread",this.model.get("commentable_id"),this.model.id),data:{resp_skip:this.responses.size(),resp_limit:responseLimit?responseLimit:void 0},$elem:elem,$loading:elem,takeFocus:true,complete:function(){return _this.responseRequest=null},success:function(data,textStatus,xhr){Content.loadContentInfos(data["annotated_content_info"]);if(_this.isQuestion()){_this.markedAnswers.add(data["content"]["endorsed_responses"])}_this.responses.add(_this.isQuestion()?data["content"]["non_endorsed_responses"]:data["content"]["children"]);_this.renderResponseCountAndPagination(_this.isQuestion()?data["content"]["non_endorsed_resp_total"]:data["content"]["resp_total"]);_this.trigger("thread:responses:rendered");return _this.loadedResponses=true},error:function(xhr){if(xhr.status===404){return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("The thread you selected has been deleted. Please select another thread."))}else if(firstLoad){return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading responses. Please reload the page."))}else{return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading more responses. Please try again."))}}})};DiscussionThreadView.prototype.loadInitialResponses=function(){return this.loadResponses(INITIAL_RESPONSE_PAGE_SIZE,this.$el.find(".js-response-list"),true)};DiscussionThreadView.prototype.renderResponseCountAndPagination=function(responseTotal){var buttonText,loadMoreButton,responseCountFormat,responseLimit,responsePagination,responsesRemaining,showingResponsesText,_this=this;if(this.isQuestion()&&this.markedAnswers.length!==0){responseCountFormat=ngettext("%(numResponses)s other response","%(numResponses)s other responses",responseTotal)}else{responseCountFormat=ngettext("%(numResponses)s response","%(numResponses)s responses",responseTotal)
}this.$el.find(".response-count").html(interpolate(responseCountFormat,{numResponses:responseTotal},true));responsePagination=this.$el.find(".response-pagination");responsePagination.empty();if(responseTotal>0){responsesRemaining=responseTotal-this.responses.size();showingResponsesText=responsesRemaining===0?gettext("Showing all responses"):interpolate(ngettext("Showing first response","Showing first %(numResponses)s responses",this.responses.size()),{numResponses:this.responses.size()},true);responsePagination.append($("<span>").addClass("response-display-count").html(_.escape(showingResponsesText)));if(responsesRemaining>0){if(responsesRemaining<SUBSEQUENT_RESPONSE_PAGE_SIZE){responseLimit=null;buttonText=gettext("Load all responses")}else{responseLimit=SUBSEQUENT_RESPONSE_PAGE_SIZE;buttonText=interpolate(gettext("Load next %(numResponses)s responses"),{numResponses:responseLimit},true)}loadMoreButton=$("<button>").addClass("load-response-button").html(_.escape(buttonText));loadMoreButton.click(function(event){return _this.loadResponses(responseLimit,loadMoreButton)});return responsePagination.append(loadMoreButton)}}};DiscussionThreadView.prototype.renderResponseToList=function(response,listSelector,options){var view;response.set("thread",this.model);view=new ThreadResponseView($.extend({model:response},options));view.on("comment:add",this.addComment);view.on("comment:endorse",this.endorseThread);view.render();this.$el.find(listSelector).append(view.el);return view.afterInsert()};DiscussionThreadView.prototype.renderAddResponseButton=function(){if(this.model.hasResponses()&&this.model.can("can_reply")&&!this.model.get("closed")){return this.$el.find("div.add-response").show()}else{return this.$el.find("div.add-response").hide()}};DiscussionThreadView.prototype.scrollToAddResponse=function(event){var form;event.preventDefault();form=$(event.target).parents("article.discussion-article").find("form.discussion-reply-new");$("html, body").scrollTop(form.offset().top);return form.find(".wmd-panel textarea").focus()};DiscussionThreadView.prototype.addComment=function(){return this.model.comment()};DiscussionThreadView.prototype.endorseThread=function(){return this.model.set("endorsed",this.$el.find(".action-answer.is-checked").length>0)};DiscussionThreadView.prototype.submitComment=function(event){var body,comment,url,_this=this;event.preventDefault();url=this.model.urlFor("reply");body=this.getWmdContent("reply-body");if(!body.trim().length){return}this.setWmdContent("reply-body","");comment=new Comment({body:body,created_at:(new Date).toISOString(),username:window.user.get("username"),votes:{up_count:0},abuse_flaggers:[],endorsed:false,user_id:window.user.get("id")});comment.set("thread",this.model.get("thread"));this.renderResponseToList(comment,".js-response-list");this.model.addComment();this.renderAddResponseButton();return DiscussionUtil.safeAjax({$elem:$(event.target),url:url,type:"POST",dataType:"json",data:{body:body},success:function(data,textStatus){comment.updateInfo(data.annotated_content_info);return comment.set(data.content)}})};DiscussionThreadView.prototype.edit=function(event){this.createEditView();return this.renderEditView()};DiscussionThreadView.prototype.update=function(event){var newBody,newTitle,url,_this=this;newTitle=this.editView.$(".edit-post-title").val();newBody=this.editView.$(".edit-post-body textarea").val();url=DiscussionUtil.urlFor("update_thread",this.model.id);return DiscussionUtil.safeAjax({$elem:$(event.target),$loading:event?$(event.target):void 0,url:url,type:"POST",dataType:"json",async:false,data:{title:newTitle,body:newBody},error:DiscussionUtil.formErrorHandler(this.$(".edit-post-form-errors")),success:function(response,textStatus){_this.editView.$(".edit-post-title").val("").attr("prev-text","");_this.editView.$(".edit-post-body textarea").val("").attr("prev-text","");_this.editView.$(".wmd-preview p").html("");_this.model.set({title:newTitle,body:newBody});_this.model.unset("abbreviatedBody");_this.createShowView();return _this.renderShowView()}})};DiscussionThreadView.prototype.createEditView=function(){if(this.showView!=null){this.showView.undelegateEvents();this.showView.$el.empty();this.showView=null}this.editView=new DiscussionThreadEditView({model:this.model});this.editView.bind("thread:update",this.update);return this.editView.bind("thread:cancel_edit",this.cancelEdit)};DiscussionThreadView.prototype.renderSubView=function(view){view.setElement(this.$(".thread-content-wrapper"));view.render();return view.delegateEvents()};DiscussionThreadView.prototype.renderEditView=function(){return this.renderSubView(this.editView)};DiscussionThreadView.prototype.createShowView=function(){if(this.editView!=null){this.editView.undelegateEvents();this.editView.$el.empty();this.editView=null}this.showView=new DiscussionThreadShowView({model:this.model,mode:this.mode});this.showView.bind("thread:_delete",this._delete);return this.showView.bind("thread:edit",this.edit)};DiscussionThreadView.prototype.renderShowView=function(){return this.renderSubView(this.showView)};DiscussionThreadView.prototype.cancelEdit=function(event){event.preventDefault();this.createShowView();return this.renderShowView()};DiscussionThreadView.prototype._delete=function(event){var $elem,url,_this=this;url=this.model.urlFor("_delete");if(!this.model.can("can_delete")){return}if(!confirm(gettext("Are you sure you want to delete this post?"))){return}this.model.remove();this.showView.undelegateEvents();this.undelegateEvents();this.$el.empty();$elem=$(event.target);return DiscussionUtil.safeAjax({$elem:$elem,url:url,type:"POST",success:function(response,textStatus){}})};return DiscussionThreadView}(DiscussionContentView)}}.call(this);!function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionThreadInlineView=function(_super){var expanded;__extends(DiscussionThreadInlineView,_super);function DiscussionThreadInlineView(){this.expandPost=__bind(this.expandPost,this);_ref=DiscussionThreadInlineView.__super__.constructor.apply(this,arguments);return _ref}expanded=false;DiscussionThreadInlineView.prototype.events={"click .discussion-submit-post":"submitComment","click .expand-post":"expandPost","click .collapse-post":"collapsePost","click .add-response-btn":"scrollToAddResponse"};DiscussionThreadInlineView.prototype.initialize=function(){return DiscussionThreadInlineView.__super__.initialize.call(this)};DiscussionThreadInlineView.prototype.initLocal=function(){this.$local=this.$el.children(".discussion-article").children(".local");if(!this.$local.length){this.$local=this.$el}return this.$delegateElement=this.$local};DiscussionThreadInlineView.prototype.renderTemplate=function(){var params;if(this.model.has("group_id")){this.template=DiscussionUtil.getTemplate("_inline_thread_cohorted")}else{this.template=DiscussionUtil.getTemplate("_inline_thread")}if(!this.model.has("abbreviatedBody")){this.abbreviateBody()}params=this.model.toJSON();return Mustache.render(this.template,params)};DiscussionThreadInlineView.prototype.render=function(){DiscussionThreadInlineView.__super__.render.call(this);this.$el.find(".post-extended-content").hide();return this.$el.find(".collapse-post").hide()};DiscussionThreadInlineView.prototype.getShowViewClass=function(){return DiscussionThreadInlineShowView};DiscussionThreadInlineView.prototype.loadInitialResponses=function(){if(this.expanded){return DiscussionThreadInlineView.__super__.loadInitialResponses.call(this)}};DiscussionThreadInlineView.prototype.abbreviateBody=function(){var abbreviated;abbreviated=DiscussionUtil.abbreviateString(this.model.get("body"),140);return this.model.set("abbreviatedBody",abbreviated)};DiscussionThreadInlineView.prototype.expandPost=function(event){this.$el.addClass("expanded");this.$el.find(".post-body").text(this.model.get("body"));this.showView.convertMath();this.$el.find(".expand-post").css("display","none");this.$el.find(".collapse-post").css("display","block");this.$el.find(".post-extended-content").show();if(!this.expanded){this.expanded=true;return this.loadInitialResponses()}};DiscussionThreadInlineView.prototype.collapsePost=function(event){var curScroll,postTop;curScroll=$(window).scrollTop();postTop=this.$el.offset().top;if(postTop<curScroll){$("html, body").animate({scrollTop:postTop})}this.$el.removeClass("expanded");this.$el.find(".post-body").text(this.model.get("abbreviatedBody"));this.showView.convertMath();this.$el.find(".expand-post").css("display","block");this.$el.find(".collapse-post").css("display","none");return this.$el.find(".post-extended-content").hide()};DiscussionThreadInlineView.prototype.createEditView=function(){DiscussionThreadInlineView.__super__.createEditView.call(this);return this.editView.bind("thread:update",this.abbreviateBody)};return DiscussionThreadInlineView}(DiscussionThreadView)}}.call(this);!function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.ThreadResponseView=function(_super){__extends(ThreadResponseView,_super);function ThreadResponseView(){this.update=__bind(this.update,this);this.edit=__bind(this.edit,this);this.cancelEdit=__bind(this.cancelEdit,this);this._delete=__bind(this._delete,this);this.renderComment=__bind(this.renderComment,this);_ref=ThreadResponseView.__super__.constructor.apply(this,arguments);return _ref}ThreadResponseView.prototype.tagName="li";ThreadResponseView.prototype.className="forum-response";ThreadResponseView.prototype.events={"click .discussion-submit-comment":"submitComment","focus .wmd-input":"showEditorChrome"};ThreadResponseView.prototype.$=function(selector){return this.$el.find(selector)};ThreadResponseView.prototype.initialize=function(options){this.collapseComments=options.collapseComments;return this.createShowView()};ThreadResponseView.prototype.renderTemplate=function(){var templateData,_ref1;this.template=_.template($("#thread-response-template").html());templateData=this.model.toJSON();templateData.wmdId=(_ref1=this.model.id)!=null?_ref1:(new Date).getTime();return this.template(templateData)};ThreadResponseView.prototype.render=function(){this.$el.addClass("response_"+this.model.get("id"));this.$el.html(this.renderTemplate());this.delegateEvents();this.renderShowView();this.renderAttrs();this.renderComments();return this};ThreadResponseView.prototype.afterInsert=function(){this.makeWmdEditor("comment-body");return this.hideEditorChrome()};ThreadResponseView.prototype.hideEditorChrome=function(){this.$(".wmd-button-row").hide();this.$(".wmd-preview-container").hide();this.$(".wmd-input").css({height:"35px",padding:"5px"});return this.$(".comment-post-control").hide()};ThreadResponseView.prototype.showEditorChrome=function(){this.$(".wmd-button-row").show();this.$(".wmd-preview-container").show();this.$(".comment-post-control").show();return this.$(".wmd-input").css({height:"125px",padding:"10px"})};ThreadResponseView.prototype.renderComments=function(){var collectComments,comments,_this=this;comments=new Comments;this.commentViews=[];comments.comparator=function(comment){return comment.get("created_at")};collectComments=function(comment){var children;comments.add(comment);children=new Comments(comment.get("children"));return children.each(function(child){child.parent=comment;return collectComments(child)})};this.model.get("comments").each(collectComments);comments.each(function(comment){return _this.renderComment(comment,false,null)});if(this.collapseComments&&comments.length){this.$(".comments").hide();return this.$(".action-show-comments").on("click",function(event){event.preventDefault();_this.$(".action-show-comments").hide();return _this.$(".comments").show()})}else{return this.$(".action-show-comments").hide()}};ThreadResponseView.prototype.renderComment=function(comment){var view,_this=this;comment.set("thread",this.model.get("thread"));view=new ResponseCommentView({model:comment});view.render();this.$el.find(".comments .new-comment").before(view.el);view.bind("comment:edit",function(event){if(_this.editView!=null){_this.cancelEdit(event)}_this.cancelCommentEdits();return _this.hideCommentForm()});view.bind("comment:cancel_edit",function(){return _this.showCommentForm()});this.commentViews.push(view);return view};ThreadResponseView.prototype.submitComment=function(event){var body,comment,url,view;event.preventDefault();url=this.model.urlFor("reply");body=this.getWmdContent("comment-body");if(!body.trim().length){return}this.setWmdContent("comment-body","");comment=new Comment({body:body,created_at:(new Date).toISOString(),username:window.user.get("username"),abuse_flaggers:[],user_id:window.user.get("id"),id:"unsaved"});view=this.renderComment(comment);this.hideEditorChrome();this.trigger("comment:add",comment);return DiscussionUtil.safeAjax({$elem:$(event.target),url:url,type:"POST",dataType:"json",data:{body:body},success:function(response,textStatus){comment.set(response.content);comment.updateInfo(response.annotated_content_info);return view.render()}})};ThreadResponseView.prototype._delete=function(event){var $elem,url,_this=this;event.preventDefault();if(!this.model.can("can_delete")){return}if(!confirm(gettext("Are you sure you want to delete this response?"))){return}url=this.model.urlFor("_delete");this.model.remove();this.$el.remove();$elem=$(event.target);return DiscussionUtil.safeAjax({$elem:$elem,url:url,type:"POST",success:function(response,textStatus){}})};ThreadResponseView.prototype.createEditView=function(){if(this.showView!=null){this.showView.undelegateEvents();this.showView.$el.empty();this.showView=null}this.editView=new ThreadResponseEditView({model:this.model});this.editView.bind("response:update",this.update);return this.editView.bind("response:cancel_edit",this.cancelEdit)};ThreadResponseView.prototype.renderSubView=function(view){view.setElement(this.$(".discussion-response"));view.render();return view.delegateEvents()};ThreadResponseView.prototype.renderEditView=function(){return this.renderSubView(this.editView)};ThreadResponseView.prototype.cancelCommentEdits=function(){return _.each(this.commentViews,function(view){return view.cancelEdit()})};ThreadResponseView.prototype.hideCommentForm=function(){return this.$(".comment-form").closest("li").hide()};ThreadResponseView.prototype.showCommentForm=function(){return this.$(".comment-form").closest("li").show()};ThreadResponseView.prototype.createShowView=function(){var _this=this;if(this.editView!=null){this.editView.undelegateEvents();this.editView.$el.empty();this.editView=null}this.showView=new ThreadResponseShowView({model:this.model});this.showView.bind("response:_delete",this._delete);this.showView.bind("response:edit",this.edit);return this.showView.on("comment:endorse",function(){return _this.trigger("comment:endorse")})};ThreadResponseView.prototype.renderShowView=function(){return this.renderSubView(this.showView)};ThreadResponseView.prototype.cancelEdit=function(event){event.preventDefault();this.createShowView();this.renderShowView();return this.showCommentForm()};ThreadResponseView.prototype.edit=function(event){this.createEditView();this.renderEditView();this.cancelCommentEdits();return this.hideCommentForm()};ThreadResponseView.prototype.update=function(event){var newBody,url,_this=this;newBody=this.editView.$(".edit-post-body textarea").val();url=DiscussionUtil.urlFor("update_comment",this.model.id);return DiscussionUtil.safeAjax({$elem:$(event.target),$loading:event?$(event.target):void 0,url:url,type:"POST",dataType:"json",async:false,data:{body:newBody},error:DiscussionUtil.formErrorHandler(this.$(".edit-post-form-errors")),success:function(response,textStatus){_this.editView.$(".edit-post-body textarea").val("").attr("prev-text","");_this.editView.$(".wmd-preview p").html("");_this.model.set({body:newBody});_this.createShowView();_this.renderShowView();return _this.showCommentForm()}})};return ThreadResponseView}(DiscussionContentView)}}.call(this);!function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionThreadListView=function(_super){var _this=this;__extends(DiscussionThreadListView,_super);function DiscussionThreadListView(){this.updateEmailNotifications=__bind(this.updateEmailNotifications,this);this.retrieveFollowed=__bind(this.retrieveFollowed,this);this.chooseCohort=__bind(this.chooseCohort,this);this.chooseFilter=__bind(this.chooseFilter,this);this.filterTopics=__bind(this.filterTopics,this);this.toggleBrowseMenu=__bind(this.toggleBrowseMenu,this);this.hideBrowseMenu=__bind(this.hideBrowseMenu,this);this.showBrowseMenu=__bind(this.showBrowseMenu,this);this.isBrowseMenuVisible=__bind(this.isBrowseMenuVisible,this);this.threadRemoved=__bind(this.threadRemoved,this);this.threadSelected=__bind(this.threadSelected,this);this.renderThread=__bind(this.renderThread,this);this.loadMorePages=__bind(this.loadMorePages,this);this.showMetadataAccordingToSort=__bind(this.showMetadataAccordingToSort,this);this.renderThreads=__bind(this.renderThreads,this);this.updateSidebar=__bind(this.updateSidebar,this);this.addAndSelectThread=__bind(this.addAndSelectThread,this);this.reloadDisplayedCollection=__bind(this.reloadDisplayedCollection,this);this.clearSearchAlerts=__bind(this.clearSearchAlerts,this);this.removeSearchAlert=__bind(this.removeSearchAlert,this);this.addSearchAlert=__bind(this.addSearchAlert,this);_ref=DiscussionThreadListView.__super__.constructor.apply(this,arguments);return _ref}DiscussionThreadListView.prototype.events={"click .forum-nav-browse":"toggleBrowseMenu","keypress .forum-nav-browse-filter-input":function(event){return DiscussionUtil.ignoreEnterKey(event)},"keyup .forum-nav-browse-filter-input":"filterTopics","click .forum-nav-browse-menu-wrapper":"ignoreClick","click .forum-nav-browse-title":"selectTopic","keydown .forum-nav-search-input":"performSearch","change .forum-nav-sort-control":"sortThreads","click .forum-nav-thread-link":"threadSelected","click .forum-nav-load-more-link":"loadMorePages","change .forum-nav-filter-main-control":"chooseFilter","change .forum-nav-filter-cohort-control":"chooseCohort"};DiscussionThreadListView.prototype.initialize=function(){var _this=this;this.displayedCollection=new Discussion(this.collection.models,{pages:this.collection.pages});this.collection.on("change",this.reloadDisplayedCollection);this.discussionIds="";this.collection.on("reset",function(discussion){var board;board=$(".current-board").html();_this.displayedCollection.current_page=discussion.current_page;_this.displayedCollection.pages=discussion.pages;return _this.displayedCollection.reset(discussion.models)});this.collection.on("add",this.addAndSelectThread);this.sidebar_padding=10;this.boardName;this.template=_.template($("#thread-list-template").html());this.current_search="";this.mode="all";this.searchAlertCollection=new Backbone.Collection([],{model:Backbone.Model});this.searchAlertCollection.on("add",function(searchAlert){var content;content=_.template($("#search-alert-template").html(),{message:searchAlert.attributes.message,cid:searchAlert.cid});_this.$(".search-alerts").append(content);return _this.$("#search-alert-"+searchAlert.cid+" a.dismiss").bind("click",searchAlert,function(event){return _this.removeSearchAlert(event.data.cid)})});this.searchAlertCollection.on("remove",function(searchAlert){return _this.$("#search-alert-"+searchAlert.cid).remove()});return this.searchAlertCollection.on("reset",function(){return _this.$(".search-alerts").empty()})};DiscussionThreadListView.prototype.addSearchAlert=function(message){var m;m=new Backbone.Model({message:message});this.searchAlertCollection.add(m);return m};DiscussionThreadListView.prototype.removeSearchAlert=function(searchAlert){return this.searchAlertCollection.remove(searchAlert)};DiscussionThreadListView.prototype.clearSearchAlerts=function(){return this.searchAlertCollection.reset()};DiscussionThreadListView.prototype.reloadDisplayedCollection=function(thread){var active,content,current_el,thread_id;this.clearSearchAlerts();thread_id=thread.get("id");content=this.renderThread(thread);current_el=this.$(".forum-nav-thread[data-id="+thread_id+"]");active=current_el.has(".forum-nav-thread-link.is-active").length!==0;current_el.replaceWith(content);this.showMetadataAccordingToSort();if(active){return this.setActiveThread(thread_id)}};DiscussionThreadListView.prototype.addAndSelectThread=function(thread){var commentable_id,menuItem,_this=this;commentable_id=thread.get("commentable_id");menuItem=this.$(".forum-nav-browse-menu-item[data-discussion-id]").filter(function(){return $(this).data("discussion-id")===commentable_id});this.setCurrentTopicDisplay(this.getPathText(menuItem));return this.retrieveDiscussion(commentable_id,function(){return _this.trigger("thread:created",thread.get("id"))})};DiscussionThreadListView.prototype.updateSidebar=function(){var amount,browseFilterHeight,discussionBody,discussionBottomOffset,discussionsBodyBottom,discussionsBodyTop,headerHeight,refineBarHeight,scrollTop,sidebar,sidebarHeight,topOffset,windowHeight;scrollTop=$(window).scrollTop();windowHeight=$(window).height();discussionBody=$(".discussion-column");discussionsBodyTop=discussionBody[0]?discussionBody.offset().top:void 0;discussionsBodyBottom=discussionsBodyTop+discussionBody.outerHeight();sidebar=$(".forum-nav");if(scrollTop>discussionsBodyTop-this.sidebar_padding){sidebar.css("top",scrollTop-discussionsBodyTop+this.sidebar_padding)}else{sidebar.css("top","0")}sidebarHeight=windowHeight-Math.max(discussionsBodyTop-scrollTop,this.sidebar_padding);topOffset=scrollTop+windowHeight;discussionBottomOffset=discussionsBodyBottom+this.sidebar_padding;amount=Math.max(topOffset-discussionBottomOffset,0);sidebarHeight=sidebarHeight-this.sidebar_padding-amount;sidebarHeight=Math.min(sidebarHeight+1,discussionBody.outerHeight());sidebar.css("height",sidebarHeight);headerHeight=this.$(".forum-nav-header").outerHeight();refineBarHeight=this.$(".forum-nav-refine-bar").outerHeight();browseFilterHeight=this.$(".forum-nav-browse-filter").outerHeight();this.$(".forum-nav-thread-list").css("height",sidebarHeight-headerHeight-refineBarHeight-2+"px");return this.$(".forum-nav-browse-menu").css("height",sidebarHeight-headerHeight-browseFilterHeight-2+"px")};DiscussionThreadListView.prototype.ignoreClick=function(event){return event.stopPropagation()};DiscussionThreadListView.prototype.render=function(){this.timer=0;this.$el.html(this.template());this.$(".forum-nav-sort-control").val(this.collection.sort_preference);$(window).bind("load",this.updateSidebar);$(window).bind("scroll",this.updateSidebar);$(window).bind("resize",this.updateSidebar);this.displayedCollection.on("reset",this.renderThreads);this.displayedCollection.on("thread:remove",this.renderThreads);this.renderThreads();return this};DiscussionThreadListView.prototype.renderThreads=function(){var content,rendered,thread,_i,_len,_ref1;this.$(".forum-nav-thread-list").html("");rendered=$("<div></div>");_ref1=this.displayedCollection.models;for(_i=0,_len=_ref1.length;_i<_len;_i++){thread=_ref1[_i];content=this.renderThread(thread);rendered.append(content)}this.$(".forum-nav-thread-list").html(rendered.html());this.showMetadataAccordingToSort();this.renderMorePages();this.updateSidebar();return this.trigger("threads:rendered")};DiscussionThreadListView.prototype.showMetadataAccordingToSort=function(){var commentCounts,voteCounts;voteCounts=this.$(".forum-nav-thread-votes-count");commentCounts=this.$(".forum-nav-thread-comments-count");voteCounts.hide();commentCounts.hide();switch(this.$(".forum-nav-sort-control").val()){case"date":case"comments":return commentCounts.show();case"votes":return voteCounts.show()}};DiscussionThreadListView.prototype.renderMorePages=function(){if(this.displayedCollection.hasMorePages()){return this.$(".forum-nav-thread-list").append("<li class='forum-nav-load-more'><a href='#' class='forum-nav-load-more-link'>"+gettext("Load more")+"</a></li>")}};DiscussionThreadListView.prototype.getLoadingContent=function(srText){return'<div class="forum-nav-loading" tabindex="0"><span class="icon-spinner icon-spin"/><span class="sr" role="alert">'+srText+"</span></div>"};DiscussionThreadListView.prototype.loadMorePages=function(event){var error,lastThread,loadMoreElem,loadingElem,options,_ref1,_this=this;if(event){event.preventDefault()}loadMoreElem=this.$(".forum-nav-load-more");loadMoreElem.html(this.getLoadingContent(gettext("Loading more threads")));loadingElem=loadMoreElem.find(".forum-nav-loading");DiscussionUtil.makeFocusTrap(loadingElem);loadingElem.focus();options={filter:this.filter};switch(this.mode){case"search":options.search_text=this.current_search;if(this.group_id){options.group_id=this.group_id}break;case"followed":options.user_id=window.user.id;options.group_id="all";break;case"commentables":options.commentable_ids=this.discussionIds;if(this.group_id){options.group_id=this.group_id}break;case"all":if(this.group_id){options.group_id=this.group_id}}lastThread=(_ref1=this.collection.last())!=null?_ref1.get("id"):void 0;if(lastThread){this.once("threads:rendered",function(){return $(".forum-nav-thread[data-id='"+lastThread+"'] + .forum-nav-thread .forum-nav-thread-link").focus()})}else{this.once("threads:rendered",function(){var _ref2;return(_ref2=$(".forum-nav-thread-link").first())!=null?_ref2.focus():void 0})}error=function(){_this.renderThreads();return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading more threads. Please try again."))};return this.collection.retrieveAnotherPage(this.mode,options,{sort_key:this.$(".forum-nav-sort-control").val()},error)};DiscussionThreadListView.prototype.renderThread=function(thread){var content,unreadCount;content=$(_.template($("#thread-list-item-template").html())(thread.toJSON()));unreadCount=thread.get("unread_comments_count")+(thread.get("read")?0:1);if(unreadCount>0){content.find(".forum-nav-thread-comments-count").attr("data-tooltip",interpolate(ngettext("%(unread_count)s new comment","%(unread_count)s new comments",unreadCount),{unread_count:unreadCount},true))}return content};DiscussionThreadListView.prototype.threadSelected=function(e){var thread_id;thread_id=$(e.target).closest(".forum-nav-thread").attr("data-id");this.setActiveThread(thread_id);this.trigger("thread:selected",thread_id);return false};DiscussionThreadListView.prototype.threadRemoved=function(thread_id){return this.trigger("thread:removed",thread_id)};DiscussionThreadListView.prototype.setActiveThread=function(thread_id){this.$(".forum-nav-thread[data-id!='"+thread_id+"'] .forum-nav-thread-link").removeClass("is-active");return this.$(".forum-nav-thread[data-id='"+thread_id+"'] .forum-nav-thread-link").addClass("is-active")};DiscussionThreadListView.prototype.goHome=function(){var thread_id,url,_this=this;this.template=_.template($("#discussion-home").html());$(".forum-content").html(this.template);$(".forum-nav-thread-list a").removeClass("is-active");$("input.email-setting").bind("click",this.updateEmailNotifications);url=DiscussionUtil.urlFor("notifications_status",window.user.get("id"));DiscussionUtil.safeAjax({url:url,type:"GET",success:function(response,textStatus){if(response.status){return $("input.email-setting").attr("checked","checked")}else{return $("input.email-setting").removeAttr("checked")}}});thread_id=null;return this.trigger("thread:removed")};DiscussionThreadListView.prototype.isBrowseMenuVisible=function(){return this.$(".forum-nav-browse-menu-wrapper").is(":visible")};DiscussionThreadListView.prototype.showBrowseMenu=function(){if(!this.isBrowseMenuVisible()){this.$(".forum-nav-browse").addClass("is-active");this.$(".forum-nav-browse-menu-wrapper").show();this.$(".forum-nav-thread-list-wrapper").hide();$(".forum-nav-browse-filter-input").focus();$("body").bind("click",this.hideBrowseMenu);return this.updateSidebar()}};DiscussionThreadListView.prototype.hideBrowseMenu=function(){if(this.isBrowseMenuVisible()){this.$(".forum-nav-browse").removeClass("is-active");this.$(".forum-nav-browse-menu-wrapper").hide();this.$(".forum-nav-thread-list-wrapper").show();$("body").unbind("click",this.hideBrowseMenu);return this.updateSidebar()}};DiscussionThreadListView.prototype.toggleBrowseMenu=function(event){event.preventDefault();event.stopPropagation();if(this.isBrowseMenuVisible()){return this.hideBrowseMenu()}else{return this.showBrowseMenu()}};DiscussionThreadListView.prototype.getPathText=function(item){var path,pathText,pathTitles;path=item.parents(".forum-nav-browse-menu-item").andSelf();pathTitles=path.children(".forum-nav-browse-title").map(function(i,elem){return $(elem).text()}).get();return pathText=pathTitles.join(" / ")};DiscussionThreadListView.prototype.filterTopics=function(event){var items,query,_this=this;query=$(event.target).val();items=this.$(".forum-nav-browse-menu-item");if(query.length===0){return items.show()}else{items.hide();return items.each(function(i,item){var path,pathText;item=$(item);if(!item.is(":visible")){pathText=_this.getPathText(item).toLowerCase();if(query.split(" ").every(function(term){return pathText.search(term.toLowerCase())!==-1})){path=item.parents(".forum-nav-browse-menu-item").andSelf();return path.add(item.find(".forum-nav-browse-menu-item")).show()}}})}};DiscussionThreadListView.prototype.setCurrentTopicDisplay=function(text){return this.$(".forum-nav-browse-current").text(this.fitName(text))};DiscussionThreadListView.prototype.getNameWidth=function(name){var test,width;test=$("<div>");test.css({"font-size":this.$(".forum-nav-browse-current").css("font-size"),opacity:0,position:"absolute",left:-1e3,top:-1e3});$("body").append(test);test.html(name);width=test.width();test.remove();return width};DiscussionThreadListView.prototype.fitName=function(name){var partialName,path,prefix,rawName,width,x;this.maxNameWidth=this.$(".forum-nav-browse").width()-parseInt(this.$(".forum-nav-browse").css("padding-left"))-parseInt(this.$(".forum-nav-browse").css("padding-right"))-this.$(".forum-nav-browse .icon").outerWidth(true)-this.$(".forum-nav-browse-drop-arrow").outerWidth(true);width=this.getNameWidth(name);if(width<this.maxNameWidth){return name}path=function(){var _i,_len,_ref1,_results;_ref1=name.split("/");_results=[];for(_i=0,_len=_ref1.length;_i<_len;_i++){x=_ref1[_i];_results.push(x.replace(/^\s+|\s+$/g,""))}return _results}();prefix="";while(path.length>1){prefix=gettext("…")+"/";path.shift();partialName=prefix+path.join("/");if(this.getNameWidth(partialName)<this.maxNameWidth){return partialName}}rawName=path[0];name=prefix+rawName;while(this.getNameWidth(name)>this.maxNameWidth){rawName=rawName.slice(0,rawName.length-1);name=prefix+rawName+gettext("…")}return name};DiscussionThreadListView.prototype.selectTopic=function(event){var allItems,discussionIds,item;event.preventDefault();this.hideBrowseMenu();this.clearSearch();item=$(event.target).closest(".forum-nav-browse-menu-item");
this.setCurrentTopicDisplay(this.getPathText(item));if(item.hasClass("forum-nav-browse-menu-all")){this.discussionIds="";this.$(".forum-nav-filter-cohort").show();return this.retrieveAllThreads()}else if(item.hasClass("forum-nav-browse-menu-following")){this.retrieveFollowed();return this.$(".forum-nav-filter-cohort").hide()}else{allItems=item.find(".forum-nav-browse-menu-item").andSelf();discussionIds=allItems.filter("[data-discussion-id]").map(function(i,elem){return $(elem).data("discussion-id")}).get();this.retrieveDiscussions(discussionIds);return this.$(".forum-nav-filter-cohort").toggle(item.data("cohorted")===true)}};DiscussionThreadListView.prototype.chooseFilter=function(event){this.filter=$(".forum-nav-filter-main-control :selected").val();return this.retrieveFirstPage()};DiscussionThreadListView.prototype.chooseCohort=function(event){this.group_id=this.$(".forum-nav-filter-cohort-control :selected").val();return this.retrieveFirstPage()};DiscussionThreadListView.prototype.retrieveDiscussion=function(discussion_id,callback){var url,_this=this;if(callback==null){callback=null}url=DiscussionUtil.urlFor("retrieve_discussion",discussion_id);return DiscussionUtil.safeAjax({url:url,type:"GET",success:function(response,textStatus){_this.collection.current_page=response.page;_this.collection.pages=response.num_pages;_this.collection.reset(response.discussion_data);Content.loadContentInfos(response.annotated_content_info);_this.displayedCollection.reset(_this.collection.models);if(callback!=null){return callback()}}})};DiscussionThreadListView.prototype.retrieveDiscussions=function(discussion_ids){this.discussionIds=discussion_ids.join(",");this.mode="commentables";return this.retrieveFirstPage()};DiscussionThreadListView.prototype.retrieveAllThreads=function(){this.mode="all";return this.retrieveFirstPage()};DiscussionThreadListView.prototype.retrieveFirstPage=function(event){this.collection.current_page=0;this.collection.reset();return this.loadMorePages(event)};DiscussionThreadListView.prototype.sortThreads=function(event){this.displayedCollection.setSortComparator(this.$(".forum-nav-sort-control").val());return this.retrieveFirstPage(event)};DiscussionThreadListView.prototype.performSearch=function(event){var text;if(event.which===13){event.preventDefault();this.hideBrowseMenu();this.setCurrentTopicDisplay(gettext("Search Results"));text=this.$(".forum-nav-search-input").val();return this.searchFor(text)}};DiscussionThreadListView.prototype.searchFor=function(text){var url,_this=this;this.clearSearchAlerts();this.clearFilters();this.mode="search";this.current_search=text;url=DiscussionUtil.urlFor("search");return DiscussionUtil.safeAjax({$elem:this.$(".forum-nav-search-input"),data:{text:text},url:url,type:"GET",dataType:"json",$loading:$,loadingCallback:function(){return _this.$(".forum-nav-thread-list").html("<li class='forum-nav-load-more'>"+_this.getLoadingContent(gettext("Loading thread list"))+"</li>")},loadedCallback:function(){return _this.$(".forum-nav-thread-list .forum-nav-load-more").remove()},success:function(response,textStatus){var message;if(textStatus==="success"){_this.collection.reset(response.discussion_data);Content.loadContentInfos(response.annotated_content_info);_this.collection.current_page=response.page;_this.collection.pages=response.num_pages;if(!_.isNull(response.corrected_text)){message=interpolate(_.escape(gettext("No results found for %(original_query)s. Showing results for %(suggested_query)s.")),{original_query:"<em>"+_.escape(text)+"</em>",suggested_query:"<em>"+response.corrected_text+"</em>"},true);_this.addSearchAlert(message)}else if(response.discussion_data.length===0){_this.addSearchAlert(gettext("No threads matched your query."))}_this.displayedCollection.reset(_this.collection.models);if(text){return _this.searchForUser(text)}}}})};DiscussionThreadListView.prototype.searchForUser=function(text){var _this=this;return DiscussionUtil.safeAjax({data:{username:text},url:DiscussionUtil.urlFor("users"),type:"GET",dataType:"json",error:function(){},success:function(response){var message;if(response.users.length>0){message=interpolate(_.escape(gettext("Show posts by %(username)s.")),{username:_.template('<a class="link-jump" href="<%= url %>"><%- username %></a>',{url:DiscussionUtil.urlFor("user_profile",response.users[0].id),username:response.users[0].username})},true);return _this.addSearchAlert(message)}}})};DiscussionThreadListView.prototype.clearSearch=function(){this.$(".forum-nav-search-input").val("");this.current_search="";return this.clearSearchAlerts()};DiscussionThreadListView.prototype.clearFilters=function(){this.$(".forum-nav-filter-main-control").val("all");return this.$(".forum-nav-filter-cohort-control").val("all")};DiscussionThreadListView.prototype.retrieveFollowed=function(){this.mode="followed";return this.retrieveFirstPage()};DiscussionThreadListView.prototype.updateEmailNotifications=function(){var _this=this;if($("input.email-setting").attr("checked")){return DiscussionUtil.safeAjax({url:DiscussionUtil.urlFor("enable_notifications"),type:"POST",error:function(){return $("input.email-setting").removeAttr("checked")}})}else{return DiscussionUtil.safeAjax({url:DiscussionUtil.urlFor("disable_notifications"),type:"POST",error:function(){return $("input.email-setting").attr("checked","checked")}})}};return DiscussionThreadListView}.call(this,Backbone.View)}}.call(this);!function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionThreadShowView=function(_super){__extends(DiscussionThreadShowView,_super);function DiscussionThreadShowView(){_ref=DiscussionThreadShowView.__super__.constructor.apply(this,arguments);return _ref}DiscussionThreadShowView.prototype.initialize=function(options){var _ref1;DiscussionThreadShowView.__super__.initialize.call(this);this.mode=options.mode||"inline";if((_ref1=this.mode)!=="tab"&&_ref1!=="inline"){throw new Error("invalid mode: "+this.mode)}};DiscussionThreadShowView.prototype.renderTemplate=function(){var context;this.template=_.template($("#thread-show-template").html());context=$.extend({mode:this.mode,flagged:this.model.isFlagged(),author_display:this.getAuthorDisplay(),cid:this.model.cid},this.model.attributes);return this.template(context)};DiscussionThreadShowView.prototype.render=function(){this.$el.html(this.renderTemplate());this.delegateEvents();this.renderAttrs();this.$("span.timeago").timeago();this.convertMath();this.highlight(this.$(".post-body"));this.highlight(this.$("h1,h3"));return this};DiscussionThreadShowView.prototype.convertMath=function(){var element;element=this.$(".post-body");element.html(DiscussionUtil.postMathJaxProcessor(DiscussionUtil.markdownWithHighlight(element.text())));return MathJax.Hub.Queue(["Typeset",MathJax.Hub,element[0]])};DiscussionThreadShowView.prototype.edit=function(event){return this.trigger("thread:edit",event)};DiscussionThreadShowView.prototype._delete=function(event){return this.trigger("thread:_delete",event)};DiscussionThreadShowView.prototype.highlight=function(el){if(el.html()){return el.html(el.html().replace(/&lt;mark&gt;/g,"<mark>").replace(/&lt;\/mark&gt;/g,"</mark>"))}};return DiscussionThreadShowView}(DiscussionContentShowView)}}.call(this);!function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionThreadEditView=function(_super){__extends(DiscussionThreadEditView,_super);function DiscussionThreadEditView(){_ref=DiscussionThreadEditView.__super__.constructor.apply(this,arguments);return _ref}DiscussionThreadEditView.prototype.events={"click .post-update":"update","click .post-cancel":"cancel_edit"};DiscussionThreadEditView.prototype.$=function(selector){return this.$el.find(selector)};DiscussionThreadEditView.prototype.initialize=function(){return DiscussionThreadEditView.__super__.initialize.call(this)};DiscussionThreadEditView.prototype.render=function(){this.template=_.template($("#thread-edit-template").html());this.$el.html(this.template(this.model.toJSON()));this.delegateEvents();DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),"edit-post-body");return this};DiscussionThreadEditView.prototype.update=function(event){return this.trigger("thread:update",event)};DiscussionThreadEditView.prototype.cancel_edit=function(event){return this.trigger("thread:cancel_edit",event)};return DiscussionThreadEditView}(Backbone.View)}}.call(this);!function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.ResponseCommentShowView=function(_super){__extends(ResponseCommentShowView,_super);function ResponseCommentShowView(){this.edit=__bind(this.edit,this);this._delete=__bind(this._delete,this);_ref=ResponseCommentShowView.__super__.constructor.apply(this,arguments);return _ref}ResponseCommentShowView.prototype.tagName="li";ResponseCommentShowView.prototype.render=function(){this.template=_.template($("#response-comment-show-template").html());this.$el.html(this.template(_.extend({cid:this.model.cid,author_display:this.getAuthorDisplay()},this.model.attributes)));this.delegateEvents();this.renderAttrs();this.$el.find(".timeago").timeago();this.convertMath();this.addReplyLink();return this};ResponseCommentShowView.prototype.addReplyLink=function(){var html,name,p,_ref1;if(this.model.hasOwnProperty("parent")){name=(_ref1=this.model.parent.get("username"))!=null?_ref1:gettext("anonymous");html="<a href='#comment_"+this.model.parent.id+"'>@"+name+"</a>:  ";p=this.$(".response-body p:first");return p.prepend(html)}};ResponseCommentShowView.prototype.convertMath=function(){var body;body=this.$el.find(".response-body");body.html(DiscussionUtil.postMathJaxProcessor(DiscussionUtil.markdownWithHighlight(body.text())));return MathJax.Hub.Queue(["Typeset",MathJax.Hub,body[0]])};ResponseCommentShowView.prototype._delete=function(event){return this.trigger("comment:_delete",event)};ResponseCommentShowView.prototype.edit=function(event){return this.trigger("comment:edit",event)};return ResponseCommentShowView}(DiscussionContentShowView)}}.call(this);!function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionThreadProfileView=function(_super){__extends(DiscussionThreadProfileView,_super);function DiscussionThreadProfileView(){_ref=DiscussionThreadProfileView.__super__.constructor.apply(this,arguments);return _ref}DiscussionThreadProfileView.prototype.render=function(){var element,params;this.template=DiscussionUtil.getTemplate("_profile_thread");this.convertMath();this.abbreviateBody();params=$.extend(this.model.toJSON(),{permalink:this.model.urlFor("retrieve")});if(!this.model.get("anonymous")){params=$.extend(params,{user:{username:this.model.username,user_url:this.model.user_url}})}this.$el.html(Mustache.render(this.template,params));this.$("span.timeago").timeago();element=this.$(".post-body");MathJax.Hub.Queue(["Typeset",MathJax.Hub,element[0]]);return this};DiscussionThreadProfileView.prototype.convertMath=function(){return this.model.set("markdownBody",DiscussionUtil.postMathJaxProcessor(DiscussionUtil.markdownWithHighlight(this.model.get("body"))))};DiscussionThreadProfileView.prototype.abbreviateBody=function(){var abbreviated;abbreviated=DiscussionUtil.abbreviateHTML(this.model.get("markdownBody"),140);return this.model.set("abbreviatedBody",abbreviated)};return DiscussionThreadProfileView}(Backbone.View)}}.call(this);!function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.NewPostView=function(_super){__extends(NewPostView,_super);function NewPostView(){this.hideTopicDropdown=__bind(this.hideTopicDropdown,this);_ref=NewPostView.__super__.constructor.apply(this,arguments);return _ref}NewPostView.prototype.initialize=function(options){var _ref1;this.mode=options.mode||"inline";if((_ref1=this.mode)!=="tab"&&_ref1!=="inline"){throw new Error("invalid mode: "+this.mode)}this.course_settings=options.course_settings;this.maxNameWidth=100;return this.topicId=options.topicId};NewPostView.prototype.render=function(){var context;context=_.clone(this.course_settings.attributes);_.extend(context,{cohort_options:this.getCohortOptions(),mode:this.mode,form_id:this.mode+(this.topicId?"-"+this.topicId:"")});if(this.mode==="tab"){context.topics_html=this.renderCategoryMap(this.course_settings.get("category_map"))}this.$el.html(_.template($("#new-post-template").html(),context));if(this.mode==="tab"){this.dropdownButton=this.$(".post-topic-button");this.topicMenu=this.$(".topic-menu-wrapper");this.hideTopicDropdown();this.setTopic(this.$("a.topic-title").first())}return DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),"js-post-body")};NewPostView.prototype.renderCategoryMap=function(map){var category_template,entry,entry_template,html,name,_i,_len,_ref1;category_template=_.template($("#new-post-menu-category-template").html());entry_template=_.template($("#new-post-menu-entry-template").html());html="";_ref1=map.children;for(_i=0,_len=_ref1.length;_i<_len;_i++){name=_ref1[_i];if(name in map.entries){entry=map.entries[name];html+=entry_template({text:name,id:entry.id,is_cohorted:entry.is_cohorted})}else{html+=category_template({text:name,entries:this.renderCategoryMap(map.subcategories[name])})}}return html};NewPostView.prototype.getCohortOptions=function(){var user_cohort_id;if(this.course_settings.get("is_cohorted")&&DiscussionUtil.isStaff()){user_cohort_id=$("#discussion-container").data("user-cohort-id");return _.map(this.course_settings.get("cohorts"),function(cohort){return{value:cohort.id,text:cohort.name,selected:cohort.id===user_cohort_id}})}else{return null}};NewPostView.prototype.events={"submit .forum-new-post-form":"createPost","click .post-topic-button":"toggleTopicDropdown","click .topic-menu-wrapper":"handleTopicEvent","click .topic-filter-label":"ignoreClick","keyup .topic-filter-input":DiscussionFilter.filterDrop,"change .post-option-input":"postOptionChange"};NewPostView.prototype.ignoreClick=function(event){return event.stopPropagation()};NewPostView.prototype.postOptionChange=function(event){var $optionElem,$target;$target=$(event.target);$optionElem=$target.closest(".post-option");if($target.is(":checked")){return $optionElem.addClass("is-enabled")}else{return $optionElem.removeClass("is-enabled")}};NewPostView.prototype.createPost=function(event){var anonymous,anonymous_to_peers,body,follow,group,thread_type,title,url,_this=this;event.preventDefault();thread_type=this.$(".post-type-input:checked").val();title=this.$(".js-post-title").val();body=this.$(".js-post-body").find(".wmd-input").val();group=this.$(".js-group-select option:selected").attr("value");anonymous=false||this.$(".js-anon").is(":checked");anonymous_to_peers=false||this.$(".js-anon-peers").is(":checked");follow=false||this.$(".js-follow").is(":checked");url=DiscussionUtil.urlFor("create_thread",this.topicId);return DiscussionUtil.safeAjax({$elem:$(event.target),$loading:event?$(event.target):void 0,url:url,type:"POST",dataType:"json",async:false,data:{thread_type:thread_type,title:title,body:body,anonymous:anonymous,anonymous_to_peers:anonymous_to_peers,auto_subscribe:follow,group_id:group},error:DiscussionUtil.formErrorHandler(this.$(".post-errors")),success:function(response,textStatus){var thread;thread=new Thread(response["content"]);DiscussionUtil.clearFormErrors(_this.$(".post-errors"));_this.$el.hide();_this.$(".js-post-title").val("").attr("prev-text","");_this.$(".js-post-body textarea").val("").attr("prev-text","");_this.$(".wmd-preview p").html("");return _this.collection.add(thread)}})};NewPostView.prototype.toggleTopicDropdown=function(event){event.preventDefault();event.stopPropagation();if(this.menuOpen){return this.hideTopicDropdown()}else{return this.showTopicDropdown()}};NewPostView.prototype.showTopicDropdown=function(){this.menuOpen=true;this.dropdownButton.addClass("dropped");this.topicMenu.show();$(".form-topic-drop-search-input").focus();$("body").bind("click",this.hideTopicDropdown);return this.maxNameWidth=this.dropdownButton.width()-40};NewPostView.prototype.hideTopicDropdown=function(){this.menuOpen=false;this.dropdownButton.removeClass("dropped");this.topicMenu.hide();return $("body").unbind("click",this.hideTopicDropdown)};NewPostView.prototype.handleTopicEvent=function(event){event.preventDefault();event.stopPropagation();return this.setTopic($(event.target))};NewPostView.prototype.setTopic=function($target){if($target.data("discussion-id")){this.topicText=$target.html();this.topicText=this.getFullTopicName($target);this.topicId=$target.data("discussion-id");this.setSelectedTopic();if($target.data("cohorted")){$(".js-group-select").prop("disabled",false)}else{$(".js-group-select").val("");$(".js-group-select").prop("disabled",true)}return this.hideTopicDropdown()}};NewPostView.prototype.setSelectedTopic=function(){return this.$(".js-selected-topic").html(this.fitName(this.topicText))};NewPostView.prototype.getFullTopicName=function(topicElement){var name;name=topicElement.html();topicElement.parents(".topic-submenu").each(function(){return name=$(this).siblings(".topic-title").text()+" / "+name});return name};NewPostView.prototype.getNameWidth=function(name){var test,width;test=$("<div>");test.css({"font-size":this.dropdownButton.css("font-size"),opacity:0,position:"absolute",left:-1e3,top:-1e3});$("body").append(test);test.html(name);width=test.width();test.remove();return width};NewPostView.prototype.fitName=function(name){var partialName,path,rawName,width,x;width=this.getNameWidth(name);if(width<this.maxNameWidth){return name}path=function(){var _i,_len,_ref1,_results;_ref1=name.split("/");_results=[];for(_i=0,_len=_ref1.length;_i<_len;_i++){x=_ref1[_i];_results.push(x.replace(/^\s+|\s+$/g,""))}return _results}();while(path.length>1){path.shift();partialName=gettext("…")+" / "+path.join(" / ");if(this.getNameWidth(partialName)<this.maxNameWidth){return partialName}}rawName=path[0];name=gettext("…")+" / "+rawName;while(this.getNameWidth(name)>this.maxNameWidth){rawName=rawName.slice(0,rawName.length-1);name=gettext("…")+" / "+rawName+" "+gettext("…")}return name};return NewPostView}(Backbone.View)}}.call(this);!function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.ResponseCommentEditView=function(_super){__extends(ResponseCommentEditView,_super);function ResponseCommentEditView(){_ref=ResponseCommentEditView.__super__.constructor.apply(this,arguments);return _ref}ResponseCommentEditView.prototype.events={"click .post-update":"update","click .post-cancel":"cancel_edit"};ResponseCommentEditView.prototype.$=function(selector){return this.$el.find(selector)};ResponseCommentEditView.prototype.initialize=function(){return ResponseCommentEditView.__super__.initialize.call(this)};ResponseCommentEditView.prototype.render=function(){this.template=_.template($("#response-comment-edit-template").html());this.$el.html(this.template(this.model.toJSON()));this.delegateEvents();DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),"edit-comment-body");return this};ResponseCommentEditView.prototype.update=function(event){return this.trigger("comment:update",event)};ResponseCommentEditView.prototype.cancel_edit=function(event){return this.trigger("comment:cancel_edit",event)};return ResponseCommentEditView}(Backbone.View)}}.call(this);!function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionRouter=function(_super){__extends(DiscussionRouter,_super);function DiscussionRouter(){this.hideNewPost=__bind(this.hideNewPost,this);this.showNewPost=__bind(this.showNewPost,this);this.navigateToAllThreads=__bind(this.navigateToAllThreads,this);this.navigateToThread=__bind(this.navigateToThread,this);this.setActiveThread=__bind(this.setActiveThread,this);_ref=DiscussionRouter.__super__.constructor.apply(this,arguments);return _ref}DiscussionRouter.prototype.routes={"":"allThreads",":forum_name/threads/:thread_id":"showThread"};DiscussionRouter.prototype.initialize=function(options){var _this=this;this.discussion=options["discussion"];this.course_settings=options["course_settings"];this.nav=new DiscussionThreadListView({collection:this.discussion,el:$(".forum-nav")});this.nav.on("thread:selected",this.navigateToThread);this.nav.on("thread:removed",this.navigateToAllThreads);this.nav.on("threads:rendered",this.setActiveThread);this.nav.on("thread:created",this.navigateToThread);this.nav.render();this.newPost=$(".new-post-article");this.newPostView=new NewPostView({el:this.newPost,collection:this.discussion,course_settings:this.course_settings,mode:"tab"});this.newPostView.render();$(".new-post-btn").bind("click",this.showNewPost);$(".new-post-btn").bind("keydown",function(event){return DiscussionUtil.activateOnSpace(event,_this.showNewPost)});return this.newPostView.$(".cancel").bind("click",this.hideNewPost)};DiscussionRouter.prototype.allThreads=function(){this.nav.updateSidebar();return this.nav.goHome()};DiscussionRouter.prototype.setActiveThread=function(){if(this.thread){return this.nav.setActiveThread(this.thread.get("id"))}else{return this.nav.goHome}};DiscussionRouter.prototype.showThread=function(forum_name,thread_id){var _this=this;this.thread=this.discussion.get(thread_id);this.thread.set("unread_comments_count",0);this.thread.set("read",true);this.setActiveThread();if(this.main){this.main.cleanup();this.main.undelegateEvents()}if(!$(".forum-content").is(":visible")){$(".forum-content").fadeIn()}if(this.newPost.is(":visible")){this.newPost.fadeOut()}this.main=new DiscussionThreadView({el:$(".forum-content"),model:this.thread,mode:"tab"});this.main.render();return this.main.on("thread:responses:rendered",function(){return _this.nav.updateSidebar()})};DiscussionRouter.prototype.navigateToThread=function(thread_id){var thread;thread=this.discussion.get(thread_id);return this.navigate(""+thread.get("commentable_id")+"/threads/"+thread_id,{trigger:true})};DiscussionRouter.prototype.navigateToAllThreads=function(){return this.navigate("",{trigger:true})};DiscussionRouter.prototype.showNewPost=function(event){var _this=this;return $(".forum-content").fadeOut({duration:200,complete:function(){_this.newPost.fadeIn(200);return $(".new-post-title").focus()}})};DiscussionRouter.prototype.hideNewPost=function(event){var _this=this;return this.newPost.fadeOut({duration:200,complete:function(){return $(".forum-content").fadeIn(200)}})};return DiscussionRouter}(Backbone.Router)}}.call(this);!function(){$(function(){if(!window.$$contents){window.$$contents={}}return $.fn.extend({loading:function(takeFocus){this.$_loading=$("<div class='loading-animation' tabindex='0'><span class='sr'>"+gettext("Loading content")+"</span></div>");$(this).after(this.$_loading);if(takeFocus){DiscussionUtil.makeFocusTrap(this.$_loading);return this.$_loading.focus()}},loaded:function(){return this.$_loading.remove()}})});this.DiscussionUtil=function(){function DiscussionUtil(){}DiscussionUtil.wmdEditors={};DiscussionUtil.getTemplate=function(id){return $("script#"+id).html()};DiscussionUtil.setUser=function(user){return this.user=user};DiscussionUtil.getUser=function(){return this.user};DiscussionUtil.loadRoles=function(roles){return this.roleIds=roles};DiscussionUtil.loadRolesFromContainer=function(){return this.loadRoles($("#discussion-container").data("roles"))};DiscussionUtil.isStaff=function(user_id){var staff,_ref;if(user_id==null){user_id=(_ref=this.user)!=null?_ref.id:void 0}staff=_.union(this.roleIds["Moderator"],this.roleIds["Administrator"]);return _.include(staff,parseInt(user_id))};DiscussionUtil.isTA=function(user_id){var ta,_ref;if(user_id==null){user_id=(_ref=this.user)!=null?_ref.id:void 0}ta=_.union(this.roleIds["Community TA"]);return _.include(ta,parseInt(user_id))};DiscussionUtil.isPrivilegedUser=function(user_id){return this.isStaff(user_id)||this.isTA(user_id)};DiscussionUtil.bulkUpdateContentInfo=function(infos){var id,info,_results;_results=[];for(id in infos){info=infos[id];_results.push(Content.getContent(id).updateInfo(info))}return _results};DiscussionUtil.generateDiscussionLink=function(cls,txt,handler){return $("<a>").addClass("discussion-link").attr("href","javascript:void(0)").addClass(cls).html(txt).click(function(){return handler(this)})};DiscussionUtil.urlFor=function(name,param,param1,param2){return{follow_discussion:"/courses/"+$$course_id+"/discussion/"+param+"/follow",unfollow_discussion:"/courses/"+$$course_id+"/discussion/"+param+"/unfollow",create_thread:"/courses/"+$$course_id+"/discussion/"+param+"/threads/create",update_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/update",create_comment:"/courses/"+$$course_id+"/discussion/threads/"+param+"/reply",delete_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/delete",flagAbuse_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/flagAbuse",unFlagAbuse_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/unFlagAbuse",flagAbuse_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/flagAbuse",unFlagAbuse_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/unFlagAbuse",upvote_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/upvote",downvote_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/downvote",pin_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/pin",un_pin_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/unpin",undo_vote_for_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/unvote",follow_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/follow",unfollow_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/unfollow",update_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/update",endorse_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/endorse",create_sub_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/reply",delete_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/delete",upvote_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/upvote",downvote_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/downvote",undo_vote_for_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/unvote",upload:"/courses/"+$$course_id+"/discussion/upload",users:"/courses/"+$$course_id+"/discussion/users",search:"/courses/"+$$course_id+"/discussion/forum/search",retrieve_discussion:"/courses/"+$$course_id+"/discussion/forum/"+param+"/inline",retrieve_single_thread:"/courses/"+$$course_id+"/discussion/forum/"+param+"/threads/"+param1,openclose_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/close",permanent_link_thread:"/courses/"+$$course_id+"/discussion/forum/"+param+"/threads/"+param1,permanent_link_comment:"/courses/"+$$course_id+"/discussion/forum/"+param+"/threads/"+param1+"#"+param2,user_profile:"/courses/"+$$course_id+"/discussion/forum/users/"+param,followed_threads:"/courses/"+$$course_id+"/discussion/forum/users/"+param+"/followed",threads:"/courses/"+$$course_id+"/discussion/forum",enable_notifications:"/notification_prefs/enable/",disable_notifications:"/notification_prefs/disable/",notifications_status:"/notification_prefs/status/"}[name]};DiscussionUtil.ignoreEnterKey=function(event){if(event.which===13){return event.preventDefault()}};DiscussionUtil.activateOnSpace=function(event,func){if(event.which===32){event.preventDefault();return func(event)}};DiscussionUtil.makeFocusTrap=function(elem){return elem.keydown(function(event){if(event.which===9){return event.preventDefault()}})};DiscussionUtil.discussionAlert=function(header,body){var alertDiv,alertTrigger;if($("#discussion-alert").length===0){alertDiv=$("<div class='modal' role='alertdialog' id='discussion-alert' aria-describedby='discussion-alert-message'/>").css("display","none");alertDiv.html("<div class='inner-wrapper discussion-alert-wrapper'>"+"  <button class='close-modal dismiss' aria-hidden='true'><i class='icon-remove'></i></button>"+"  <header><h2/><hr/></header>"+"  <p id='discussion-alert-message'/>"+"  <hr/>"+"  <button class='dismiss'>"+gettext("OK")+"</button>"+"</div>");this.makeFocusTrap(alertDiv.find("button"));alertTrigger=$("<a href='#discussion-alert' id='discussion-alert-trigger'/>").css("display","none");alertTrigger.leanModal({closeButton:"#discussion-alert .dismiss",overlay:1,top:200});$("body").append(alertDiv).append(alertTrigger)}$("#discussion-alert header h2").html(header);$("#discussion-alert p").html(body);$("#discussion-alert-trigger").click();return $("#discussion-alert button").focus()};DiscussionUtil.safeAjax=function(params){var $elem,request,_this=this;$elem=params.$elem;if($elem&&$elem.attr("disabled")){return}params["url"]=URI(params["url"]).addSearch({ajax:1});params["beforeSend"]=function(){if($elem){$elem.attr("disabled","disabled")}if(params["$loading"]){if(params["loadingCallback"]!=null){return params["loadingCallback"].apply(params["$loading"])}else{return params["$loading"].loading(params["takeFocus"])}}};if(!params["error"]){params["error"]=function(){return _this.discussionAlert(gettext("Sorry"),gettext("We had some trouble processing your request. Please ensure you have copied any unsaved work and then reload the page."))}}request=$.ajax(params).always(function(){if($elem){$elem.removeAttr("disabled")}if(params["$loading"]){if(params["loadedCallback"]!=null){return params["loadedCallback"].apply(params["$loading"])}else{return params["$loading"].loaded()}}});return request};DiscussionUtil.updateWithUndo=function(model,updates,safeAjaxParams,errorMsg){var undo,_this=this;if(errorMsg){safeAjaxParams.error=function(){return _this.discussionAlert(gettext("Sorry"),errorMsg)}}undo=_.pick(model.attributes,_.keys(updates));model.set(updates);return this.safeAjax(safeAjaxParams).fail(function(){return model.set(undo)})};DiscussionUtil.bindLocalEvents=function($local,eventsHandler){var event,eventSelector,handler,selector,_ref,_results;
_results=[];for(eventSelector in eventsHandler){handler=eventsHandler[eventSelector];_ref=eventSelector.split(" "),event=_ref[0],selector=_ref[1];_results.push($local(selector).unbind(event)[event](handler))}return _results};DiscussionUtil.formErrorHandler=function(errorsField){return function(xhr,textStatus,error){var makeErrorElem,response,_i,_len,_ref,_results;makeErrorElem=function(message){return $("<li>").addClass("post-error").html(message)};errorsField.empty().show();if(xhr.status===400){response=JSON.parse(xhr.responseText);if(response.errors!=null&&response.errors.length>0){_ref=response.errors;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){error=_ref[_i];_results.push(errorsField.append(makeErrorElem(error)))}return _results}}else{return errorsField.append(makeErrorElem(gettext("We had some trouble processing your request. Please try again.")))}}};DiscussionUtil.clearFormErrors=function(errorsField){return errorsField.empty()};DiscussionUtil.postMathJaxProcessor=function(text){var RE_DISPLAYMATH,RE_INLINEMATH;RE_INLINEMATH=/^\$([^\$]*)\$/g;RE_DISPLAYMATH=/^\$\$([^\$]*)\$\$/g;return this.processEachMathAndCode(text,function(s,type){if(type==="display"){return s.replace(RE_DISPLAYMATH,function($0,$1){return"\\["+$1+"\\]"})}else if(type==="inline"){return s.replace(RE_INLINEMATH,function($0,$1){return"\\("+$1+"\\)"})}else{return s}})};DiscussionUtil.makeWmdEditor=function($content,$local,cls_identifier){var appended_id,editor,elem,id,imageUploadUrl,placeholder,_processor;elem=$local("."+cls_identifier);placeholder=elem.data("placeholder");id=elem.attr("data-id");appended_id="-"+cls_identifier+"-"+id;imageUploadUrl=this.urlFor("upload");_processor=function(_this){return function(text){return _this.postMathJaxProcessor(text)}};editor=Markdown.makeWmdEditor(elem,appended_id,imageUploadUrl,_processor(this));this.wmdEditors[""+cls_identifier+"-"+id]=editor;if(placeholder!=null){elem.find("#wmd-input"+appended_id).attr("placeholder",placeholder)}return editor};DiscussionUtil.getWmdEditor=function($content,$local,cls_identifier){var elem,id;elem=$local("."+cls_identifier);id=elem.attr("data-id");return this.wmdEditors[""+cls_identifier+"-"+id]};DiscussionUtil.getWmdInput=function($content,$local,cls_identifier){var elem,id;elem=$local("."+cls_identifier);id=elem.attr("data-id");return $local("#wmd-input-"+cls_identifier+"-"+id)};DiscussionUtil.getWmdContent=function($content,$local,cls_identifier){return this.getWmdInput($content,$local,cls_identifier).val()};DiscussionUtil.setWmdContent=function($content,$local,cls_identifier,text){this.getWmdInput($content,$local,cls_identifier).val(text);return this.getWmdEditor($content,$local,cls_identifier).refreshPreview()};DiscussionUtil.processEachMathAndCode=function(text,processor){var $div,ESCAPED_BACKSLASH,ESCAPED_DOLLAR,RE_DISPLAYMATH,RE_INLINEMATH,cnt,codeArchive,processedText;codeArchive=[];RE_DISPLAYMATH=/^([^\$]*?)\$\$([^\$]*?)\$\$(.*)$/m;RE_INLINEMATH=/^([^\$]*?)\$([^\$]+?)\$(.*)$/m;ESCAPED_DOLLAR="@@ESCAPED_D@@";ESCAPED_BACKSLASH="@@ESCAPED_B@@";processedText="";$div=$("<div>").html(text);$div.find("code").each(function(index,code){codeArchive.push($(code).html());return $(code).html(codeArchive.length-1)});text=$div.html();text=text.replace(/\\\$/g,ESCAPED_DOLLAR);while(true){if(RE_INLINEMATH.test(text)){text=text.replace(RE_INLINEMATH,function($0,$1,$2,$3){processedText+=$1+processor("$"+$2+"$","inline");return $3})}else if(RE_DISPLAYMATH.test(text)){text=text.replace(RE_DISPLAYMATH,function($0,$1,$2,$3){processedText=processor("$$"+$2+"$$","display")+processedText;processedText=$1+processedText;return $3})}else{processedText+=text;break}}text=processedText;text=text.replace(new RegExp(ESCAPED_DOLLAR,"g"),"\\$");text=text.replace(/\\\\\\\\/g,ESCAPED_BACKSLASH);text=text.replace(/\\begin\{([a-z]*\*?)\}([\s\S]*?)\\end\{\1\}/gim,function($0,$1,$2){return processor("\\begin{"+$1+"}"+$2+("\\end{"+$1+"}"))});text=text.replace(new RegExp(ESCAPED_BACKSLASH,"g"),"\\\\\\\\");$div=$("<div>").html(text);cnt=0;$div.find("code").each(function(index,code){$(code).html(processor(codeArchive[cnt],"code"));return cnt+=1});text=$div.html();return text};DiscussionUtil.unescapeHighlightTag=function(text){return text.replace(/\&lt\;highlight\&gt\;/g,"<span class='search-highlight'>").replace(/\&lt\;\/highlight\&gt\;/g,"</span>")};DiscussionUtil.stripHighlight=function(text){return text.replace(/\&(amp\;)?lt\;highlight\&(amp\;)?gt\;/g,"").replace(/\&(amp\;)?lt\;\/highlight\&(amp\;)?gt\;/g,"")};DiscussionUtil.stripLatexHighlight=function(text){return this.processEachMathAndCode(text,this.stripHighlight)};DiscussionUtil.markdownWithHighlight=function(text){var converter;text=text.replace(/^\&gt\;/gm,">");converter=Markdown.getMathCompatibleConverter();text=this.unescapeHighlightTag(this.stripLatexHighlight(converter.makeHtml(text)));return text.replace(/^>/gm,"&gt;")};DiscussionUtil.abbreviateString=function(text,minLength){if(text.length<minLength){return text}else{while(minLength<text.length&&text[minLength]!==" "){minLength++}return text.substr(0,minLength)+gettext("…")}};DiscussionUtil.abbreviateHTML=function(html,minLength){var $result,imagesToReplace,truncated_text;truncated_text=jQuery.truncate(html,{length:minLength,noBreaks:true,ellipsis:gettext("…")});$result=$("<div>"+truncated_text+"</div>");imagesToReplace=$result.find("img:not(:first)");if(imagesToReplace.length>0){$result.append("<p><em>Some images in this post have been omitted</em></p>")}imagesToReplace.replaceWith("<em>image omitted</em>");return $result.html()};DiscussionUtil.getPaginationParams=function(curPage,numPages,pageUrlFunc){var delta,maxPage,minPage,pageInfo,params;delta=2;minPage=Math.max(curPage-delta,1);maxPage=Math.min(curPage+delta,numPages);pageInfo=function(pageNum){return{number:pageNum,url:pageUrlFunc(pageNum)}};return params={page:curPage,lowPages:_.range(minPage,curPage).map(pageInfo),highPages:_.range(curPage+1,maxPage+1).map(pageInfo),previous:curPage>1?pageInfo(curPage-1):null,next:curPage<numPages?pageInfo(curPage+1):null,leftdots:minPage>2,rightdots:maxPage<numPages-1,first:minPage>1?pageInfo(1):null,last:maxPage<numPages?pageInfo(numPages):null}};return DiscussionUtil}.call(this)}.call(this);!function(){}.call(this);!function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionModuleView=function(_super){__extends(DiscussionModuleView,_super);function DiscussionModuleView(){this.navigateToPage=__bind(this.navigateToPage,this);this.renderPagination=__bind(this.renderPagination,this);this.addThread=__bind(this.addThread,this);this.renderDiscussion=__bind(this.renderDiscussion,this);this.loadPage=__bind(this.loadPage,this);this.toggleDiscussion=__bind(this.toggleDiscussion,this);this.hideDiscussion=__bind(this.hideDiscussion,this);this.toggleNewPost=__bind(this.toggleNewPost,this);_ref=DiscussionModuleView.__super__.constructor.apply(this,arguments);return _ref}DiscussionModuleView.prototype.events={"click .discussion-show":"toggleDiscussion","keydown .discussion-show":function(event){return DiscussionUtil.activateOnSpace(event,this.toggleDiscussion)},"click .new-post-btn":"toggleNewPost","keydown .new-post-btn":function(event){return DiscussionUtil.activateOnSpace(event,this.toggleNewPost)},"click .cancel":"hideNewPost","click .discussion-paginator a":"navigateToPage"};DiscussionModuleView.prototype.paginationTemplate=function(){return DiscussionUtil.getTemplate("_pagination")};DiscussionModuleView.prototype.page_re=/\?discussion_page=(\d+)/;DiscussionModuleView.prototype.initialize=function(){var match;this.toggleDiscussionBtn=this.$(".discussion-show");match=this.page_re.exec(window.location.href);if(match){return this.page=parseInt(match[1])}else{return this.page=1}};DiscussionModuleView.prototype.toggleNewPost=function(event){event.preventDefault();if(!this.newPostForm){this.toggleDiscussion();this.isWaitingOnNewPost=true;return}if(this.showed){this.newPostForm.slideDown(300)}else{this.newPostForm.show()}this.toggleDiscussionBtn.addClass("shown");this.toggleDiscussionBtn.find(".button-text").html(gettext("Hide Discussion"));this.$("section.discussion").slideDown();return this.showed=true};DiscussionModuleView.prototype.hideNewPost=function(event){event.preventDefault();return this.newPostForm.slideUp(300)};DiscussionModuleView.prototype.hideDiscussion=function(){this.$("section.discussion").slideUp();this.toggleDiscussionBtn.removeClass("shown");this.toggleDiscussionBtn.find(".button-text").html(gettext("Show Discussion"));return this.showed=false};DiscussionModuleView.prototype.toggleDiscussion=function(event){var $elem,_this=this;if(this.showed){return this.hideDiscussion()}else{this.toggleDiscussionBtn.addClass("shown");this.toggleDiscussionBtn.find(".button-text").html(gettext("Hide Discussion"));if(this.retrieved){this.$("section.discussion").slideDown();return this.showed=true}else{$elem=this.toggleDiscussionBtn;return this.loadPage($elem,function(){_this.hideDiscussion();return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading the discussion. Please try again."))})}}};DiscussionModuleView.prototype.loadPage=function($elem,error){var discussionId,url,_this=this;discussionId=this.$el.data("discussion-id");url=DiscussionUtil.urlFor("retrieve_discussion",discussionId)+("?page="+this.page);return DiscussionUtil.safeAjax({$elem:$elem,$loading:$elem,takeFocus:true,url:url,type:"GET",dataType:"json",success:function(response,textStatus,jqXHR){return _this.renderDiscussion($elem,response,textStatus,discussionId)},error:error})};DiscussionModuleView.prototype.renderDiscussion=function($elem,response,textStatus,discussionId){var $discussion,user;$elem.focus();user=new DiscussionUser(response.user_info);window.user=user;DiscussionUtil.setUser(user);Content.loadContentInfos(response.annotated_content_info);DiscussionUtil.loadRoles(response.roles);this.course_settings=new DiscussionCourseSettings(response.course_settings);this.discussion=new Discussion;this.discussion.reset(response.discussion_data,{silent:false});$discussion=$(Mustache.render($("script#_inline_discussion").html(),{threads:response.discussion_data,discussionId:discussionId}));if(this.$("section.discussion").length){this.$("section.discussion").replaceWith($discussion)}else{this.$el.append($discussion)}this.newPostForm=$(".new-post-article");this.threadviews=this.discussion.map(function(thread){return new DiscussionThreadView({el:this.$("article#thread_"+thread.id),model:thread,mode:"inline"})});_.each(this.threadviews,function(dtv){return dtv.render()});DiscussionUtil.bulkUpdateContentInfo(window.$$annotated_content_info);this.newPostView=new NewPostView({el:this.newPostForm,collection:this.discussion,course_settings:this.course_settings,topicId:discussionId});this.newPostView.render();this.discussion.on("add",this.addThread);this.retrieved=true;this.showed=true;this.renderPagination(response.num_pages);if(this.isWaitingOnNewPost){return this.newPostForm.show()}};DiscussionModuleView.prototype.addThread=function(thread,collection,options){var article,threadView;article=$("<article class='discussion-thread' id='thread_"+thread.id+"'></article>");this.$("section.discussion > .threads").prepend(article);threadView=new DiscussionThreadView({el:article,model:thread,mode:"inline"});threadView.render();return this.threadviews.unshift(threadView)};DiscussionModuleView.prototype.renderPagination=function(numPages){var pageUrl,params,thing;pageUrl=function(number){return"?discussion_page="+number};params=DiscussionUtil.getPaginationParams(this.page,numPages,pageUrl);thing=Mustache.render(this.paginationTemplate(),params);return this.$("section.pagination").html(thing)};DiscussionModuleView.prototype.navigateToPage=function(event){var currPage,_this=this;event.preventDefault();window.history.pushState({},window.document.title,event.target.href);currPage=this.page;this.page=$(event.target).data("page-number");return this.loadPage($(event.target),function(){_this.page=currPage;return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading the threads you requested. Please try again."))})};return DiscussionModuleView}(Backbone.View)}}.call(this);