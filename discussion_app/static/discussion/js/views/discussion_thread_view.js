// Generated by CoffeeScript 1.6.3
(function() {
  var _ref,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  if (typeof Backbone !== "undefined" && Backbone !== null) {
    this.DiscussionThreadView = (function(_super) {
      var INITIAL_RESPONSE_PAGE_SIZE, SUBSEQUENT_RESPONSE_PAGE_SIZE;

      __extends(DiscussionThreadView, _super);

      function DiscussionThreadView() {
        this._delete = __bind(this._delete, this);
        this.cancelEdit = __bind(this.cancelEdit, this);
        this.update = __bind(this.update, this);
        this.edit = __bind(this.edit, this);
        this.endorseThread = __bind(this.endorseThread, this);
        this.addComment = __bind(this.addComment, this);
        this.renderAddResponseButton = __bind(this.renderAddResponseButton, this);
        this.renderResponseToList = __bind(this.renderResponseToList, this);
        this.renderResponseCountAndPagination = __bind(this.renderResponseCountAndPagination, this);
        _ref = DiscussionThreadView.__super__.constructor.apply(this, arguments);
        return _ref;
      }

      INITIAL_RESPONSE_PAGE_SIZE = 25;

      SUBSEQUENT_RESPONSE_PAGE_SIZE = 100;

      DiscussionThreadView.prototype.events = {
        "click .discussion-submit-post": "submitComment",
        "click .add-response-btn": "scrollToAddResponse",
        "click .forum-thread-expand": "expand",
        "click .forum-thread-collapse": "collapse"
      };

      DiscussionThreadView.prototype.$ = function(selector) {
        return this.$el.find(selector);
      };

      DiscussionThreadView.prototype.isQuestion = function() {
        return this.model.get("thread_type") === "question";
      };

      DiscussionThreadView.prototype.initialize = function(options) {
        var _ref1;
        DiscussionThreadView.__super__.initialize.call(this);
        this.mode = options.mode || "inline";
        if ((_ref1 = this.mode) !== "tab" && _ref1 !== "inline") {
          throw new Error("invalid mode: " + this.mode);
        }
        this.createShowView();
        this.responses = new Comments();
        this.loadedResponses = false;
        if (this.isQuestion()) {
          return this.markedAnswers = new Comments();
        }
      };

      DiscussionThreadView.prototype.renderTemplate = function() {
        this.template = _.template($("#thread-template").html());
        return this.template(this.model.toJSON());
      };

      DiscussionThreadView.prototype.render = function() {
        var _this = this;
        this.$el.html(this.renderTemplate());
        this.delegateEvents();
        this.renderShowView();
        this.renderAttrs();
        this.$("span.timeago").timeago();
        this.makeWmdEditor("reply-body");
        this.renderAddResponseButton();
        this.responses.on("add", function(response) {
          return _this.renderResponseToList(response, ".js-response-list", {});
        });
        if (this.isQuestion()) {
          this.markedAnswers.on("add", function(response) {
            return _this.renderResponseToList(response, ".js-marked-answer-list", {
              collapseComments: true
            });
          });
        }
        if (this.mode === "tab") {
          setTimeout((function() {
            return _this.loadInitialResponses();
          }), 100);
          return this.$(".post-tools").hide();
        } else {
          return this.collapse();
        }
      };

      DiscussionThreadView.prototype.attrRenderer = $.extend({}, DiscussionContentView.prototype.attrRenderer, {
        closed: function(closed) {
          this.$(".discussion-reply-new").toggle(!closed);
          return this.renderAddResponseButton();
        }
      });

      DiscussionThreadView.prototype.expand = function(event) {
        if (event) {
          event.preventDefault();
        }
        this.$el.addClass("expanded");
        this.$el.find(".post-body").text(this.model.get("body"));
        this.showView.convertMath();
        this.$el.find(".forum-thread-expand").hide();
        this.$el.find(".forum-thread-collapse").show();
        this.$el.find(".post-extended-content").show();
        if (!this.loadedResponses) {
          return this.loadInitialResponses();
        }
      };

      DiscussionThreadView.prototype.collapse = function(event) {
        if (event) {
          event.preventDefault();
        }
        this.$el.removeClass("expanded");
        this.$el.find(".post-body").text(this.getAbbreviatedBody());
        this.showView.convertMath();
        this.$el.find(".forum-thread-expand").show();
        this.$el.find(".forum-thread-collapse").hide();
        return this.$el.find(".post-extended-content").hide();
      };

      DiscussionThreadView.prototype.getAbbreviatedBody = function() {
        var abbreviated, cached;
        cached = this.model.get("abbreviatedBody");
        if (cached) {
          return cached;
        } else {
          abbreviated = DiscussionUtil.abbreviateString(this.model.get("body"), 140);
          this.model.set("abbreviatedBody", abbreviated);
          return abbreviated;
        }
      };

      DiscussionThreadView.prototype.cleanup = function() {
        if (this.responsesRequest != null) {
          return this.responsesRequest.abort();
        }
      };

      DiscussionThreadView.prototype.loadResponses = function(responseLimit, elem, firstLoad) {
        var _this = this;
        return this.responsesRequest = DiscussionUtil.safeAjax({
          url: DiscussionUtil.urlFor('retrieve_single_thread', this.model.get('commentable_id'), this.model.id),
          data: {
            resp_skip: this.responses.size(),
            resp_limit: responseLimit ? responseLimit : void 0
          },
          $elem: elem,
          $loading: elem,
          takeFocus: true,
          complete: function() {
            return _this.responseRequest = null;
          },
          success: function(data, textStatus, xhr) {
            Content.loadContentInfos(data['annotated_content_info']);
            if (_this.isQuestion()) {
              _this.markedAnswers.add(data["content"]["endorsed_responses"]);
            }
            _this.responses.add(_this.isQuestion() ? data["content"]["non_endorsed_responses"] : data["content"]["children"]);
            _this.renderResponseCountAndPagination(_this.isQuestion() ? data["content"]["non_endorsed_resp_total"] : data["content"]["resp_total"]);
            _this.trigger("thread:responses:rendered");
            return _this.loadedResponses = true;
          },
          error: function(xhr) {
            if (xhr.status === 404) {
              return DiscussionUtil.discussionAlert(gettext("Sorry"), gettext("The thread you selected has been deleted. Please select another thread."));
            } else if (firstLoad) {
              return DiscussionUtil.discussionAlert(gettext("Sorry"), gettext("We had some trouble loading responses. Please reload the page."));
            } else {
              return DiscussionUtil.discussionAlert(gettext("Sorry"), gettext("We had some trouble loading more responses. Please try again."));
            }
          }
        });
      };

      DiscussionThreadView.prototype.loadInitialResponses = function() {
        return this.loadResponses(INITIAL_RESPONSE_PAGE_SIZE, this.$el.find(".js-response-list"), true);
      };

      DiscussionThreadView.prototype.renderResponseCountAndPagination = function(responseTotal) {
        var buttonText, loadMoreButton, responseCountFormat, responseLimit, responsePagination, responsesRemaining, showingResponsesText,
          _this = this;
        if (this.isQuestion() && this.markedAnswers.length !== 0) {
          responseCountFormat = ngettext("%(numResponses)s other response", "%(numResponses)s other responses", responseTotal);
        } else {
          responseCountFormat = ngettext("%(numResponses)s response", "%(numResponses)s responses", responseTotal);
        }
        this.$el.find(".response-count").html(interpolate(responseCountFormat, {
          numResponses: responseTotal
        }, true));
        responsePagination = this.$el.find(".response-pagination");
        responsePagination.empty();
        if (responseTotal > 0) {
          responsesRemaining = responseTotal - this.responses.size();
          showingResponsesText = responsesRemaining === 0 ? gettext("Showing all responses") : interpolate(ngettext("Showing first response", "Showing first %(numResponses)s responses", this.responses.size()), {
            numResponses: this.responses.size()
          }, true);
          responsePagination.append($("<span>").addClass("response-display-count").html(_.escape(showingResponsesText)));
          if (responsesRemaining > 0) {
            if (responsesRemaining < SUBSEQUENT_RESPONSE_PAGE_SIZE) {
              responseLimit = null;
              buttonText = gettext("Load all responses");
            } else {
              responseLimit = SUBSEQUENT_RESPONSE_PAGE_SIZE;
              buttonText = interpolate(gettext("Load next %(numResponses)s responses"), {
                numResponses: responseLimit
              }, true);
            }
            loadMoreButton = $("<button>").addClass("load-response-button").html(_.escape(buttonText));
            loadMoreButton.click(function(event) {
              return _this.loadResponses(responseLimit, loadMoreButton);
            });
            return responsePagination.append(loadMoreButton);
          }
        }
      };

      DiscussionThreadView.prototype.renderResponseToList = function(response, listSelector, options) {
        var view;
        response.set('thread', this.model);
        view = new ThreadResponseView($.extend({
          model: response
        }, options));
        view.on("comment:add", this.addComment);
        view.on("comment:endorse", this.endorseThread);
        view.render();
        this.$el.find(listSelector).append(view.el);
        return view.afterInsert();
      };

      DiscussionThreadView.prototype.renderAddResponseButton = function() {
        if (this.model.hasResponses() && this.model.can('can_reply') && !this.model.get('closed')) {
          return this.$el.find('div.add-response').show();
        } else {
          return this.$el.find('div.add-response').hide();
        }
      };

      DiscussionThreadView.prototype.scrollToAddResponse = function(event) {
        var form;
        event.preventDefault();
        form = $(event.target).parents('article.discussion-article').find('form.discussion-reply-new');
        $('html, body').scrollTop(form.offset().top);
        return form.find('.wmd-panel textarea').focus();
      };

      DiscussionThreadView.prototype.addComment = function() {
        return this.model.comment();
      };

      DiscussionThreadView.prototype.endorseThread = function() {
        return this.model.set('endorsed', this.$el.find(".action-answer.is-checked").length > 0);
      };

      DiscussionThreadView.prototype.submitComment = function(event) {
        var body, comment, url,
          _this = this;
        event.preventDefault();
        url = this.model.urlFor('reply');
        body = this.getWmdContent("reply-body");
        if (!body.trim().length) {
          return;
        }
        this.setWmdContent("reply-body", "");
        comment = new Comment({
          body: body,
          created_at: (new Date()).toISOString(),
          username: window.user.get("username"),
          votes: {
            up_count: 0
          },
          abuse_flaggers: [],
          endorsed: false,
          user_id: window.user.get("id")
        });
        comment.set('thread', this.model.get('thread'));
        this.renderResponseToList(comment, ".js-response-list");
        this.model.addComment();
        this.renderAddResponseButton();
        return DiscussionUtil.safeAjax({
          $elem: $(event.target),
          url: url,
          type: "POST",
          dataType: 'json',
          data: {
            body: body
          },
          success: function(data, textStatus) {
            comment.updateInfo(data.annotated_content_info);
            return comment.set(data.content);
          }
        });
      };

      DiscussionThreadView.prototype.edit = function(event) {
        this.createEditView();
        return this.renderEditView();
      };

      DiscussionThreadView.prototype.update = function(event) {
        var newBody, newTitle, url,
          _this = this;
        newTitle = this.editView.$(".edit-post-title").val();
        newBody = this.editView.$(".edit-post-body textarea").val();
        url = DiscussionUtil.urlFor('update_thread', this.model.id);
        return DiscussionUtil.safeAjax({
          $elem: $(event.target),
          $loading: event ? $(event.target) : void 0,
          url: url,
          type: "POST",
          dataType: 'json',
          async: false,
          data: {
            title: newTitle,
            body: newBody
          },
          error: DiscussionUtil.formErrorHandler(this.$(".edit-post-form-errors")),
          success: function(response, textStatus) {
            _this.editView.$(".edit-post-title").val("").attr("prev-text", "");
            _this.editView.$(".edit-post-body textarea").val("").attr("prev-text", "");
            _this.editView.$(".wmd-preview p").html("");
            _this.model.set({
              title: newTitle,
              body: newBody
            });
            _this.model.unset("abbreviatedBody");
            _this.createShowView();
            return _this.renderShowView();
          }
        });
      };

      DiscussionThreadView.prototype.createEditView = function() {
        if (this.showView != null) {
          this.showView.undelegateEvents();
          this.showView.$el.empty();
          this.showView = null;
        }
        this.editView = new DiscussionThreadEditView({
          model: this.model
        });
        this.editView.bind("thread:update", this.update);
        return this.editView.bind("thread:cancel_edit", this.cancelEdit);
      };

      DiscussionThreadView.prototype.renderSubView = function(view) {
        view.setElement(this.$('.thread-content-wrapper'));
        view.render();
        return view.delegateEvents();
      };

      DiscussionThreadView.prototype.renderEditView = function() {
        return this.renderSubView(this.editView);
      };

      DiscussionThreadView.prototype.createShowView = function() {
        if (this.editView != null) {
          this.editView.undelegateEvents();
          this.editView.$el.empty();
          this.editView = null;
        }
        this.showView = new DiscussionThreadShowView({
          model: this.model,
          mode: this.mode
        });
        this.showView.bind("thread:_delete", this._delete);
        return this.showView.bind("thread:edit", this.edit);
      };

      DiscussionThreadView.prototype.renderShowView = function() {
        return this.renderSubView(this.showView);
      };

      DiscussionThreadView.prototype.cancelEdit = function(event) {
        event.preventDefault();
        this.createShowView();
        return this.renderShowView();
      };

      DiscussionThreadView.prototype._delete = function(event) {
        var $elem, url,
          _this = this;
        url = this.model.urlFor('_delete');
        if (!this.model.can('can_delete')) {
          return;
        }
        if (!confirm(gettext("Are you sure you want to delete this post?"))) {
          return;
        }
        this.model.remove();
        this.showView.undelegateEvents();
        this.undelegateEvents();
        this.$el.empty();
        $elem = $(event.target);
        return DiscussionUtil.safeAjax({
          $elem: $elem,
          url: url,
          type: "POST",
          success: function(response, textStatus) {}
        });
      };

      return DiscussionThreadView;

    })(DiscussionContentView);
  }

}).call(this);
